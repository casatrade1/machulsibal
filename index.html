<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¹Œì‚¬íŠ¸ë ˆì´ë“œ ê³„ì¢Œë¶„ì„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; 
        }
        .header h1 { margin-bottom: 10px; }
        
        .upload-section { 
            background: white; padding: 25px; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px; 
        }
        .file-drop { 
            border: 2px dashed #d1d5db; border-radius: 10px; padding: 40px 20px; 
            text-align: center; cursor: pointer; transition: all 0.2s; 
        }
        .file-drop:hover { border-color: #2563eb; background: #f8fafc; }
        .file-drop.active { border-color: #059669; background: #f0fdf4; }
        
        .tabs {
            display: flex; background: white; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px; overflow: hidden;
        }
        .tab {
            padding: 15px 20px; background: #f9fafb; border: none; 
            cursor: pointer; font-weight: 500; flex: 1; transition: all 0.2s;
        }
        .tab.active { background: #2563eb; color: white; }
        .tab:hover:not(.active) { background: #e5e7eb; }
        
        .content-section { 
            background: white; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px;
        }
        .section-header { 
            background: #f8fafc; padding: 20px; border-bottom: 1px solid #e5e7eb; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .section-title { font-size: 1.3em; font-weight: bold; color: #1f2937; }
        .section-body { padding: 20px; }
        
        .summary-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; margin-bottom: 25px; 
        }
        .summary-card { 
            background: #f9fafb; padding: 20px; border-radius: 15px; 
            border-left: 4px solid #2563eb; 
        }
        .summary-title { font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .summary-value { color: #2563eb; font-size: 1.3em; font-weight: 600; margin-bottom: 5px; }
        .summary-detail { font-size: 0.9em; color: #6b7280; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { 
            background: #f9fafb; font-weight: 600; color: #374151; 
            position: sticky; top: 0; z-index: 10;
        }
        td { font-size: 14px; }
        
        .amount-positive { color: #059669; font-weight: 600; }
        .amount-negative { color: #dc2626; font-weight: 600; }
        .amount-large { color: #7c3aed; font-weight: bold; }
        
        .status-badge { 
            padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; 
        }
        .status-maintained { background: #f0fdf4; color: #059669; }
        .status-churned { background: #fef2f2; color: #dc2626; }
        .status-refund { background: #fef3c7; color: #d97706; }
        .status-return { background: #dbeafe; color: #2563eb; }
        .status-deposit { background: #fef3c7; color: #d97706; }
        .status-sales { background: #dbeafe; color: #2563eb; }
        .status-boutique { background: #ede9fe; color: #7c3aed; }
        
        .btn {
            background: #2563eb; color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 2000; 
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px; 
            width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto;
        }
        
        .progress-bar {
            width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; 
            overflow: hidden; margin: 20px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #2563eb, #059669); 
            transition: width 0.3s ease; width: 0%;
        }
        
        .customer-row { cursor: pointer; transition: background 0.2s; }
        .customer-row:hover { background: #f9fafb; }
        .customer-row.selected { background: #e0f2fe; }
        
        .classification-controls {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .classification-controls select, .classification-controls input {
            padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ ê¹Œì‚¬íŠ¸ë ˆì´ë“œ ê³„ì¢Œë¶„ì„ ì‹œìŠ¤í…œ</h1>
            <p>ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œë¡œ ìë™ ê³ ê° ë¶„ë¥˜ ë° ë§¤ì¶œ ë¶„ì„</p>
        </div>

        <div class="upload-section">
            <div class="file-drop" id="fileDrop">
                <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“</div>
                <div style="font-size: 1.2em; margin-bottom: 5px;">ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                <div style="color: #6b7280;">.xls, .xlsx íŒŒì¼ë§Œ ì§€ì›</div>
                <input type="file" id="fileInput" accept=".xls,.xlsx" style="display: none;">
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText" style="text-align: center; margin-top: 10px; display: none;"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">ğŸ“Š ì „ì²´ ê°œìš”</button>
            <button class="tab" onclick="showTab('customers')">ğŸ‘¥ ê³ ê° ê´€ë¦¬</button>
            <button class="tab" onclick="showTab('tradesales')">ğŸ’¼ íŠ¸ë ˆì´ë“œ ë§¤ì¶œ</button>
            <button class="tab" onclick="showTab('boutiquesales')">ğŸ›ï¸ ë¶€í‹°í¬ ë§¤ì¶œ</button>
            <button class="tab" onclick="showTab('deposits')">ğŸ’° ë³´ì¦ê¸ˆ ê´€ë¦¬</button>
        </div>

        <!-- ì „ì²´ ê°œìš” íƒ­ -->
        <div id="overviewTab" class="content-section">
            <div class="section-header">
                <h2 class="section-title">ğŸ“Š ì „ì²´ ê°œìš”</h2>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="overviewGrid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
        </div>

        <!-- ê³ ê° ê´€ë¦¬ íƒ­ -->
        <div id="customersTab" class="content-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">ğŸ‘¥ ê³ ê° ê´€ë¦¬</h2>
                <div class="classification-controls">
                    <select id="customerFilter">
                        <option value="all">ì „ì²´ ê³ ê°</option>
                        <option value="trade">íŠ¸ë ˆì´ë“œ ê³ ê°</option>
                        <option value="boutique">ë¶€í‹°í¬ ê³ ê°</option>
                        <option value="maintained">ìœ ì§€ê³ ê°</option>
                        <option value="churned">ì´íƒˆê³ ê°</option>
                    </select>
                    <input type="text" id="customerSearch" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                    <button class="btn" onclick="exportCustomerData()">ğŸ“Š JSON ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn" onclick="exportToExcel()">ğŸ“ˆ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn" onclick="showCustomerMergeModal()" style="background: #7c3aed;">ğŸ”— ê³ ê° í†µí•©</button>
                    <button class="btn" onclick="createSampleData()" style="background: #059669;">ğŸ§ª ìƒ˜í”Œ ë°ì´í„°</button>
                </div>
            </div>
            <div class="section-body">
                <table>
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ë¶„ë¥˜</th>
                            <th>ë³´ì¦ê¸ˆ</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>ìƒíƒœ</th>
                            <th>ê±°ë˜ìˆ˜</th>
                            <th>ìµœê·¼ê±°ë˜</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- íŠ¸ë ˆì´ë“œ ë§¤ì¶œ íƒ­ -->
        <div id="tradesalesTab" class="content-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">ğŸ’¼ íŠ¸ë ˆì´ë“œ ë§¤ì¶œ (ë³´ì¦ê¸ˆ ì œì™¸)</h2>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="tradeSalesGrid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ê±°ë˜ì¼</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ë¶„ë¥˜</th>
                        </tr>
                    </thead>
                    <tbody id="tradeSalesTable">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ë¶€í‹°í¬ ë§¤ì¶œ íƒ­ -->
        <div id="boutiquesalesTab" class="content-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">ğŸ›ï¸ ë¶€í‹°í¬ ë§¤ì¶œ</h2>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="boutiqueSalesGrid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ê±°ë˜ì¼</th>
                            <th>ê¸ˆì•¡</th>
                            <th>ë¶„ë¥˜</th>
                        </tr>
                    </thead>
                    <tbody id="boutiqueSalesTable">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ë³´ì¦ê¸ˆ ê´€ë¦¬ íƒ­ -->
        <div id="depositsTab" class="content-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">ğŸ’° ë³´ì¦ê¸ˆ ê´€ë¦¬</h2>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="depositsGrid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ë³´ì¦ê¸ˆ</th>
                            <th>í™˜ê¸‰ì•¡</th>
                            <th>ìƒíƒœ</th>
                            <th>ì°¨ì•¡</th>
                            <th>ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="depositsTable">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        let allTransactions = [];
        let allCustomers = {};
        let customerMerges = {}; // ê³ ê° í†µí•© ì •ë³´
        let manualClassifications = {}; // ìˆ˜ë™ ë¶„ë¥˜ ì •ë³´

        // ë³´ì¦ê¸ˆ ê¸ˆì•¡ íŒ¨í„´ (ê¹”ë”í•œ ê¸ˆì•¡)
        const DEPOSIT_AMOUNTS = [500000, 1000000, 2000000, 3000000, 5000000];

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('fileDrop').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileDrop').addEventListener('dragover', (e) => {
            e.preventDefault();
            document.getElementById('fileDrop').classList.add('active');
        });
        document.getElementById('fileDrop').addEventListener('dragleave', () => {
            document.getElementById('fileDrop').classList.remove('active');
        });
        document.getElementById('fileDrop').addEventListener('drop', (e) => {
            e.preventDefault();
            document.getElementById('fileDrop').classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xls|xlsx)$/)) {
                alert('ì—‘ì…€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            showProgress(0, 'íŒŒì¼ ì½ëŠ” ì¤‘...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    showProgress(30, 'ê±°ë˜ ë‚´ì—­ ë¶„ì„ ì¤‘...');
                    parseTransactionData(jsonData);
                    
                    showProgress(60, 'ê³ ê° ë¶„ë¥˜ ì¤‘...');
                    classifyCustomers();
                    
                    showProgress(80, 'ë°ì´í„° í†µí•© ì¤‘...');
                    mergeCustomers();
                    
                    showProgress(100, 'ë¶„ì„ ì™„ë£Œ!');
                    updateAllTabs();
                    
                    setTimeout(() => {
                        document.getElementById('progressBar').style.display = 'none';
                        document.getElementById('progressText').style.display = 'none';
                    }, 1000);
                    
                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    hideProgress();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showProgress(percent, text) {
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('progressText').style.display = 'none';
        }

        function parseTransactionData(jsonData) {
            allTransactions = [];
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length < 4) continue;
                
                let date = row[0];
                const customer = row[1];
                const inAmount = row[2] ? parseFloat(row[2]) : 0;
                const outAmount = row[3] ? parseFloat(row[3]) : 0;
                
                if (!date || !customer) continue;
                
                // ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
                let parsedDate;
                if (typeof date === 'number') {
                    // ì—‘ì…€ ë‚ ì§œ ìˆ«ì í˜•ì‹ (1900ë…„ ê¸°ì¤€)
                    parsedDate = new Date((date - 25569) * 86400 * 1000);
                } else if (typeof date === 'string') {
                    // ë¬¸ìì—´ ë‚ ì§œ
                    parsedDate = new Date(date);
                } else {
                    parsedDate = new Date(date);
                }
                
                // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ ì²˜ë¦¬
                if (isNaN(parsedDate.getTime())) {
                    console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ:', date);
                    continue;
                }
                
                const transaction = {
                    id: `${date}_${customer}_${inAmount || outAmount}`,
                    date: date,
                    customer: customer.toString().trim(),
                    inAmount: inAmount || 0,
                    outAmount: outAmount || 0,
                    type: inAmount > 0 ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ',
                    parsedDate: parsedDate
                };
                
                allTransactions.push(transaction);
            }
            
            // ë‚ ì§œìˆœ ì •ë ¬
            allTransactions.sort((a, b) => b.parsedDate - a.parsedDate);
            console.log('íŒŒì‹±ëœ ê±°ë˜ ìˆ˜:', allTransactions.length);
        }

        function classifyCustomers() {
            allCustomers = {};
            
            allTransactions.forEach(transaction => {
                const customer = transaction.customer;
                
                if (!allCustomers[customer]) {
                    allCustomers[customer] = {
                        name: customer,
                        transactions: [],
                        totalIncome: 0,
                        totalOutcome: 0,
                        depositAmount: 0,
                        salesAmount: 0,
                        depositDate: null,
                        refundAmount: 0,
                        refundDate: null,
                        status: 'unknown',
                        classification: 'unknown',
                        firstTransactionDate: null,
                        lastTransactionDate: null
                    };
                }
                
                const customerData = allCustomers[customer];
                customerData.transactions.push(transaction);
                
                if (transaction.type === 'ì…ê¸ˆ') {
                    customerData.totalIncome += transaction.inAmount;
                } else {
                    customerData.totalOutcome += transaction.outAmount;
                }
                
                if (!customerData.firstTransactionDate || transaction.parsedDate < customerData.firstTransactionDate) {
                    customerData.firstTransactionDate = transaction.parsedDate;
                }
                if (!customerData.lastTransactionDate || transaction.parsedDate > customerData.lastTransactionDate) {
                    customerData.lastTransactionDate = transaction.parsedDate;
                }
            });
            
            // ê³ ê°ë³„ ë¶„ë¥˜
            Object.values(allCustomers).forEach(customer => {
                classifyCustomer(customer);
            });
        }

        function classifyCustomer(customer) {
            // ìˆ˜ë™ ë¶„ë¥˜ê°€ ìˆìœ¼ë©´ ìš°ì„  ì ìš©
            if (manualClassifications[customer.name] && manualClassifications[customer.name].modified) {
                const manual = manualClassifications[customer.name];
                customer.classification = manual.classification || customer.classification;
                customer.status = manual.status || customer.status;
                customer.depositAmount = manual.depositAmount !== undefined ? manual.depositAmount : customer.depositAmount;
                customer.refundAmount = manual.refundAmount !== undefined ? manual.refundAmount : customer.refundAmount;
                customer.salesAmount = manual.salesAmount !== undefined ? manual.salesAmount : customer.salesAmount;
                if (manual.refundDate) customer.refundDate = manual.refundDate;
                return;
            }
            
            const incomeTransactions = customer.transactions.filter(t => t.type === 'ì…ê¸ˆ');
            const outcomeTransactions = customer.transactions.filter(t => t.type === 'ì¶œê¸ˆ');
            
            // ë³´ì¦ê¸ˆ ì°¾ê¸° (ê¹”ë”í•œ ê¸ˆì•¡ì˜ ì²« ì…ê¸ˆ)
            let depositTransaction = null;
            for (let transaction of incomeTransactions) {
                if (DEPOSIT_AMOUNTS.includes(transaction.inAmount)) {
                    depositTransaction = transaction;
                    break;
                }
            }
            
            if (depositTransaction) {
                customer.depositAmount = depositTransaction.inAmount;
                customer.depositDate = depositTransaction.date;
                customer.classification = 'trade';
                
                // ë³´ì¦ê¸ˆ ì œì™¸í•œ ë§¤ì¶œ ê³„ì‚°
                customer.salesAmount = incomeTransactions
                    .filter(t => t !== depositTransaction)
                    .reduce((sum, t) => sum + t.inAmount, 0);
                
                // í™˜ê¸‰ í™•ì¸
                const refundTransaction = outcomeTransactions.find(t => 
                    Math.abs(t.outAmount - customer.depositAmount) < 1000
                );
                
                if (refundTransaction) {
                    customer.refundAmount = refundTransaction.outAmount;
                    customer.refundDate = refundTransaction.date;
                    
                    if (refundTransaction.outAmount >= customer.depositAmount * 0.95) {
                        customer.status = 'churned'; // ì´íƒˆê³ ê°
                    } else {
                        customer.status = 'refund'; // í™˜ë¶ˆ
                    }
                } else {
                    customer.status = 'maintained'; // ìœ ì§€ê³ ê°
                }
            } else {
                // ë³´ì¦ê¸ˆì´ ì—†ìœ¼ë©´ ë¶€í‹°í¬ ê³ ê°
                customer.classification = 'boutique';
                customer.salesAmount = customer.totalIncome;
                customer.status = 'boutique';
            }
        }

        function mergeCustomers() {
            // ìœ ì‚¬í•œ ì´ë¦„ ìë™ ì¸ì‹ ë° í†µí•©
            const customerNames = Object.keys(allCustomers);
            
            for (let i = 0; i < customerNames.length; i++) {
                for (let j = i + 1; j < customerNames.length; j++) {
                    const name1 = customerNames[i];
                    const name2 = customerNames[j];
                    
                    if (isSimilarName(name1, name2)) {
                        mergeCustomerData(name1, name2);
                    }
                }
            }
        }

        function isSimilarName(name1, name2) {
            // ê´„í˜¸ ì œê±° í›„ ë¹„êµ
            const clean1 = name1.replace(/\([^)]*\)/g, '').trim();
            const clean2 = name2.replace(/\([^)]*\)/g, '').trim();
            
            // ì™„ì „ ì¼ì¹˜
            if (clean1 === clean2) return true;
            
            // ë¶€ë¶„ ì¼ì¹˜ (í•œìª½ì´ ë‹¤ë¥¸ ìª½ì„ í¬í•¨)
            if (clean1.includes(clean2) || clean2.includes(clean1)) return true;
            
            // ìœ ì‚¬ë„ ê³„ì‚° (ê°„ë‹¨í•œ ë²„ì „)
            const similarity = calculateSimilarity(clean1, clean2);
            return similarity > 0.7;
        }

        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        function mergeCustomerData(mainCustomer, mergeCustomer) {
            const main = allCustomers[mainCustomer];
            const merge = allCustomers[mergeCustomer];
            
            if (!main || !merge) return;
            
            // ë©”ì¸ ê³ ê°ì— ë³‘í•©
            main.transactions = [...main.transactions, ...merge.transactions];
            main.totalIncome += merge.totalIncome;
            main.totalOutcome += merge.totalOutcome;
            main.salesAmount += merge.salesAmount;
            
            // ë³´ì¦ê¸ˆì´ ë” í° ìª½ìœ¼ë¡œ ì„¤ì •
            if (merge.depositAmount > main.depositAmount) {
                main.depositAmount = merge.depositAmount;
                main.depositDate = merge.depositDate;
            }
            
            // í™˜ê¸‰ ì •ë³´ ì—…ë°ì´íŠ¸
            if (merge.refundAmount > 0) {
                main.refundAmount += merge.refundAmount;
                if (!main.refundDate || (merge.refundDate && merge.refundDate > main.refundDate)) {
                    main.refundDate = merge.refundDate;
                }
            }
            
            // ë‚ ì§œ ì—…ë°ì´íŠ¸
            if (merge.firstTransactionDate < main.firstTransactionDate) {
                main.firstTransactionDate = merge.firstTransactionDate;
            }
            if (merge.lastTransactionDate > main.lastTransactionDate) {
                main.lastTransactionDate = merge.lastTransactionDate;
            }
            
            // ê±°ë˜ ì •ë ¬
            main.transactions.sort((a, b) => b.parsedDate - a.parsedDate);
            
            // ë³‘í•©ëœ ê³ ê° ì œê±°
            delete allCustomers[mergeCustomer];
            
            // ê³ ê° í†µí•© ì •ë³´ ì €ì¥
            if (!customerMerges[mainCustomer]) {
                customerMerges[mainCustomer] = [];
            }
            customerMerges[mainCustomer].push(mergeCustomer);
        }

        function updateAllTabs() {
            console.log('=== íƒ­ ì—…ë°ì´íŠ¸ ì‹œì‘ ===');
            console.log('ì „ì²´ ê³ ê° ìˆ˜:', Object.keys(allCustomers).length);
            console.log('ì „ì²´ ê±°ë˜ ìˆ˜:', allTransactions.length);
            
            updateOverviewTab();
            updateCustomersTab();
            updateTradeSalesTab();
            updateBoutiqueSalesTab();
            updateDepositsTab();
            
            console.log('=== íƒ­ ì—…ë°ì´íŠ¸ ì™„ë£Œ ===');
        }

        function updateOverviewTab() {
            const totalCustomers = Object.keys(allCustomers).length;
            const tradeCustomers = Object.values(allCustomers).filter(c => c.classification === 'trade').length;
            const boutiqueCustomers = Object.values(allCustomers).filter(c => c.classification === 'boutique').length;
            const maintainedCustomers = Object.values(allCustomers).filter(c => c.status === 'maintained').length;
            const churnedCustomers = Object.values(allCustomers).filter(c => c.status === 'churned').length;
            
            const totalSales = Object.values(allCustomers).reduce((sum, c) => sum + (c.salesAmount || 0), 0);
            const totalDeposits = Object.values(allCustomers).reduce((sum, c) => sum + (c.depositAmount || 0), 0);
            const totalRefunds = Object.values(allCustomers).reduce((sum, c) => sum + (c.refundAmount || 0), 0);
            
            document.getElementById('overviewGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">ì´ ê³ ê°ìˆ˜</div>
                    <div class="summary-value">${totalCustomers.toLocaleString()}ëª…</div>
                    <div class="summary-detail">íŠ¸ë ˆì´ë“œ: ${tradeCustomers}ëª…, ë¶€í‹°í¬: ${boutiqueCustomers}ëª…</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ì´ ë§¤ì¶œì•¡</div>
                    <div class="summary-value">â‚©${totalSales.toLocaleString()}</div>
                    <div class="summary-detail">ë³´ì¦ê¸ˆ ì œì™¸</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ì´ ë³´ì¦ê¸ˆ</div>
                    <div class="summary-value">â‚©${totalDeposits.toLocaleString()}</div>
                    <div class="summary-detail">í™˜ê¸‰ì•¡: â‚©${totalRefunds.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ê³ ê° ìƒíƒœ</div>
                    <div class="summary-value">ìœ ì§€: ${maintainedCustomers}ëª…</div>
                    <div class="summary-detail">ì´íƒˆ: ${churnedCustomers}ëª…</div>
                </div>
            `;
        }

        function updateCustomersTab() {
            const customers = Object.values(allCustomers);
            const filter = document.getElementById('customerFilter').value;
            const search = document.getElementById('customerSearch').value.toLowerCase();
            
            let filteredCustomers = customers;
            
            if (filter !== 'all') {
                filteredCustomers = customers.filter(c => {
                    if (filter === 'trade') return c.classification === 'trade';
                    if (filter === 'boutique') return c.classification === 'boutique';
                    if (filter === 'maintained') return c.status === 'maintained';
                    if (filter === 'churned') return c.status === 'churned';
                    return true;
                });
            }
            
            if (search) {
                filteredCustomers = filteredCustomers.filter(c => 
                    c.name.toLowerCase().includes(search)
                );
            }
            
            const tbody = document.getElementById('customersTable');
            tbody.innerHTML = '';
            
            if (filteredCustomers.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="8" style="text-align: center; padding: 20px; color: #6b7280;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”.</td>';
                return;
            }
            
            filteredCustomers.forEach(customer => {
                const row = tbody.insertRow();
                row.className = 'customer-row';
                
                const statusBadge = getStatusBadge(customer);
                const classificationBadge = getClassificationBadge(customer);
                
                // ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
                let lastTransactionDate = '-';
                if (customer.lastTransactionDate && !isNaN(customer.lastTransactionDate.getTime())) {
                    lastTransactionDate = customer.lastTransactionDate.toLocaleDateString('ko-KR');
                }
                
                // ê³ ê°ëª… ì•ˆì „ ì²˜ë¦¬
                const customerName = customer.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                row.innerHTML = `
                    <td>${customerName}</td>
                    <td>${classificationBadge}</td>
                    <td class="amount-positive">â‚©${(customer.depositAmount || 0).toLocaleString()}</td>
                    <td class="amount-positive">â‚©${(customer.salesAmount || 0).toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td>${customer.transactions.length}ê±´</td>
                    <td>${lastTransactionDate}</td>
                    <td>
                        <button class="btn" onclick="editCustomer('${customerName.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                    </td>
                `;
            });
        }

        function getStatusBadge(customer) {
            switch (customer.status) {
                case 'maintained': return '<span class="status-badge status-maintained">ìœ ì§€ê³ ê°</span>';
                case 'churned': return '<span class="status-badge status-churned">ì´íƒˆê³ ê°</span>';
                case 'refund': return '<span class="status-badge status-refund">í™˜ë¶ˆ</span>';
                case 'boutique': return '<span class="status-badge status-boutique">ë¶€í‹°í¬</span>';
                default: return '<span class="status-badge">ë¯¸ë¶„ë¥˜</span>';
            }
        }

        function getClassificationBadge(customer) {
            switch (customer.classification) {
                case 'trade': return '<span class="status-badge status-sales">íŠ¸ë ˆì´ë“œ</span>';
                case 'boutique': return '<span class="status-badge status-boutique">ë¶€í‹°í¬</span>';
                default: return '<span class="status-badge">ë¯¸ë¶„ë¥˜</span>';
            }
        }

        function updateTradeSalesTab() {
            const tradeTransactions = allTransactions.filter(t => {
                const customer = allCustomers[t.customer];
                if (!customer || customer.classification !== 'trade') return false;
                if (t.type !== 'ì…ê¸ˆ') return false;
                
                // ë³´ì¦ê¸ˆ ê±°ë˜ ì œì™¸
                if (customer.depositAmount > 0 && t.inAmount === customer.depositAmount) return false;
                
                return true;
            });
            
            const totalAmount = tradeTransactions.reduce((sum, t) => sum + t.inAmount, 0);
            const avgAmount = tradeTransactions.length > 0 ? Math.round(totalAmount / tradeTransactions.length) : 0;
            
            document.getElementById('tradeSalesGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">íŠ¸ë ˆì´ë“œ ë§¤ì¶œ ì´ì•¡</div>
                    <div class="summary-value">â‚©${totalAmount.toLocaleString()}</div>
                    <div class="summary-detail">ë³´ì¦ê¸ˆ ì œì™¸</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ê±°ë˜ ê±´ìˆ˜</div>
                    <div class="summary-value">${tradeTransactions.length}ê±´</div>
                    <div class="summary-detail">í‰ê· : â‚©${avgAmount.toLocaleString()}</div>
                </div>
            `;
            
            const tbody = document.getElementById('tradeSalesTable');
            tbody.innerHTML = '';
            
            if (tradeTransactions.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="4" style="text-align: center; padding: 20px; color: #6b7280;">íŠ¸ë ˆì´ë“œ ë§¤ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
                return;
            }
            
            tradeTransactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.customer || 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                    <td>${transaction.date || '-'}</td>
                    <td class="amount-positive">â‚©${(transaction.inAmount || 0).toLocaleString()}</td>
                    <td><span class="status-badge status-sales">íŠ¸ë ˆì´ë“œ</span></td>
                `;
            });
        }

        function updateBoutiqueSalesTab() {
            const boutiqueTransactions = allTransactions.filter(t => {
                const customer = allCustomers[t.customer];
                return customer && customer.classification === 'boutique' && t.type === 'ì…ê¸ˆ';
            });
            
            const totalAmount = boutiqueTransactions.reduce((sum, t) => sum + t.inAmount, 0);
            const avgAmount = boutiqueTransactions.length > 0 ? Math.round(totalAmount / boutiqueTransactions.length) : 0;
            
            document.getElementById('boutiqueSalesGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">ë¶€í‹°í¬ ë§¤ì¶œ ì´ì•¡</div>
                    <div class="summary-value">â‚©${totalAmount.toLocaleString()}</div>
                    <div class="summary-detail">1íšŒì„± ê³ ê°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ê±°ë˜ ê±´ìˆ˜</div>
                    <div class="summary-value">${boutiqueTransactions.length}ê±´</div>
                    <div class="summary-detail">í‰ê· : â‚©${avgAmount.toLocaleString()}</div>
                </div>
            `;
            
            const tbody = document.getElementById('boutiqueSalesTable');
            tbody.innerHTML = '';
            
            if (boutiqueTransactions.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="4" style="text-align: center; padding: 20px; color: #6b7280;">ë¶€í‹°í¬ ë§¤ì¶œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
                return;
            }
            
            boutiqueTransactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.customer || 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                    <td>${transaction.date || '-'}</td>
                    <td class="amount-positive">â‚©${(transaction.inAmount || 0).toLocaleString()}</td>
                    <td><span class="status-badge status-boutique">ë¶€í‹°í¬</span></td>
                `;
            });
        }

        function updateDepositsTab() {
            const depositCustomers = Object.values(allCustomers).filter(c => c.depositAmount > 0);
            
            const totalDeposits = depositCustomers.reduce((sum, c) => sum + c.depositAmount, 0);
            const totalRefunds = depositCustomers.reduce((sum, c) => sum + c.refundAmount, 0);
            const maintainedDeposits = depositCustomers.filter(c => c.status === 'maintained').reduce((sum, c) => sum + c.depositAmount, 0);
            
            const refundRate = totalDeposits > 0 ? Math.round(totalRefunds / totalDeposits * 100) : 0;
            
            document.getElementById('depositsGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">ì´ ë³´ì¦ê¸ˆ</div>
                    <div class="summary-value">â‚©${totalDeposits.toLocaleString()}</div>
                    <div class="summary-detail">${depositCustomers.length}ëª…</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ì´ í™˜ê¸‰ì•¡</div>
                    <div class="summary-value">â‚©${totalRefunds.toLocaleString()}</div>
                    <div class="summary-detail">í™˜ê¸‰ë¥ : ${refundRate}%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ìœ ì§€ ë³´ì¦ê¸ˆ</div>
                    <div class="summary-value">â‚©${maintainedDeposits.toLocaleString()}</div>
                    <div class="summary-detail">ë¯¸í™˜ê¸‰</div>
                </div>
            `;
            
            const tbody = document.getElementById('depositsTable');
            tbody.innerHTML = '';
            
            if (depositCustomers.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px; color: #6b7280;">ë³´ì¦ê¸ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
                return;
            }
            
            depositCustomers.forEach(customer => {
                const row = tbody.insertRow();
                const difference = customer.depositAmount - customer.refundAmount;
                const statusBadge = getStatusBadge(customer);
                const customerName = customer.name || 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                row.innerHTML = `
                    <td>${customerName}</td>
                    <td class="amount-positive">â‚©${(customer.depositAmount || 0).toLocaleString()}</td>
                    <td class="amount-negative">â‚©${(customer.refundAmount || 0).toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td class="${difference > 0 ? 'amount-positive' : 'amount-negative'}">â‚©${difference.toLocaleString()}</td>
                    <td>
                        <button class="btn" onclick="editDeposit('${customerName.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                    </td>
                `;
            });
        }

        function showTab(tabName) {
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.content-section').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ì„ íƒëœ íƒ­ ë³´ì´ê¸°
            document.getElementById(tabName + 'Tab').style.display = 'block';
            event.target.classList.add('active');
        }

        function editCustomer(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            showCustomerEditModal(customer);
        }

        function editDeposit(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            showDepositEditModal(customer);
        }

        function showCustomerEditModal(customer) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>ê³ ê° ì •ë³´ ìˆ˜ì •: ${customer.name}</h3>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë¶„ë¥˜</label>
                        <select id="editClassification" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                            <option value="trade" ${customer.classification === 'trade' ? 'selected' : ''}>íŠ¸ë ˆì´ë“œ</option>
                            <option value="boutique" ${customer.classification === 'boutique' ? 'selected' : ''}>ë¶€í‹°í¬</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ìƒíƒœ</label>
                        <select id="editStatus" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                            <option value="maintained" ${customer.status === 'maintained' ? 'selected' : ''}>ìœ ì§€ê³ ê°</option>
                            <option value="churned" ${customer.status === 'churned' ? 'selected' : ''}>ì´íƒˆê³ ê°</option>
                            <option value="refund" ${customer.status === 'refund' ? 'selected' : ''}>í™˜ë¶ˆ</option>
                            <option value="boutique" ${customer.status === 'boutique' ? 'selected' : ''}>ë¶€í‹°í¬</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë³´ì¦ê¸ˆ (ìˆ˜ë™ ì„¤ì •)</label>
                        <input type="number" id="editDepositAmount" value="${customer.depositAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">í™˜ê¸‰ì•¡ (ìˆ˜ë™ ì„¤ì •)</label>
                        <input type="number" id="editRefundAmount" value="${customer.refundAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë§¤ì¶œì•¡ (ìˆ˜ë™ ì„¤ì •)</label>
                        <input type="number" id="editSalesAmount" value="${customer.salesAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button class="btn" onclick="saveCustomerEdit('${customer.name}')">ì €ì¥</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showDepositEditModal(customer) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>ë³´ì¦ê¸ˆ ê´€ë¦¬: ${customer.name}</h3>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4>í˜„ì¬ ì •ë³´</h4>
                        <p><strong>ë³´ì¦ê¸ˆ:</strong> â‚©${customer.depositAmount.toLocaleString()}</p>
                        <p><strong>í™˜ê¸‰ì•¡:</strong> â‚©${customer.refundAmount.toLocaleString()}</p>
                        <p><strong>ì°¨ì•¡:</strong> â‚©${(customer.depositAmount - customer.refundAmount).toLocaleString()}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë³´ì¦ê¸ˆ ìˆ˜ì •</label>
                        <input type="number" id="editDepositAmount" value="${customer.depositAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">í™˜ê¸‰ì•¡ ìˆ˜ì •</label>
                        <input type="number" id="editRefundAmount" value="${customer.refundAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">í™˜ê¸‰ì¼</label>
                        <input type="date" id="editRefundDate" value="${customer.refundDate || ''}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ìƒíƒœ</label>
                        <select id="editDepositStatus" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                            <option value="maintained" ${customer.status === 'maintained' ? 'selected' : ''}>ìœ ì§€ê³ ê°</option>
                            <option value="churned" ${customer.status === 'churned' ? 'selected' : ''}>ì´íƒˆê³ ê°</option>
                            <option value="refund" ${customer.status === 'refund' ? 'selected' : ''}>í™˜ë¶ˆ</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button class="btn" onclick="saveDepositEdit('${customer.name}')">ì €ì¥</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function saveCustomerEdit(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            const classification = document.getElementById('editClassification').value;
            const status = document.getElementById('editStatus').value;
            const depositAmount = parseInt(document.getElementById('editDepositAmount').value) || 0;
            const refundAmount = parseInt(document.getElementById('editRefundAmount').value) || 0;
            const salesAmount = parseInt(document.getElementById('editSalesAmount').value) || 0;
            
            // ìˆ˜ë™ ë¶„ë¥˜ ì •ë³´ ì €ì¥
            manualClassifications[customerName] = {
                classification: classification,
                status: status,
                depositAmount: depositAmount,
                refundAmount: refundAmount,
                salesAmount: salesAmount,
                modified: true
            };
            
            // ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
            customer.classification = classification;
            customer.status = status;
            customer.depositAmount = depositAmount;
            customer.refundAmount = refundAmount;
            customer.salesAmount = salesAmount;
            
            closeModal();
            updateAllTabs();
            
            showNotification('âœ… ê³ ê° ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function saveDepositEdit(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            const depositAmount = parseInt(document.getElementById('editDepositAmount').value) || 0;
            const refundAmount = parseInt(document.getElementById('editRefundAmount').value) || 0;
            const refundDate = document.getElementById('editRefundDate').value;
            const status = document.getElementById('editDepositStatus').value;
            
            // ìˆ˜ë™ ë¶„ë¥˜ ì •ë³´ ì €ì¥
            if (!manualClassifications[customerName]) {
                manualClassifications[customerName] = {};
            }
            manualClassifications[customerName].depositAmount = depositAmount;
            manualClassifications[customerName].refundAmount = refundAmount;
            manualClassifications[customerName].refundDate = refundDate;
            manualClassifications[customerName].status = status;
            manualClassifications[customerName].modified = true;
            
            // ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
            customer.depositAmount = depositAmount;
            customer.refundAmount = refundAmount;
            customer.refundDate = refundDate;
            customer.status = status;
            
            closeModal();
            updateAllTabs();
            
            showNotification('âœ… ë³´ì¦ê¸ˆ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #059669; color: white;
                padding: 15px 20px; border-radius: 8px; z-index: 3000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function exportCustomerData() {
            const data = {
                customers: allCustomers,
                transactions: allTransactions,
                manualClassifications: manualClassifications,
                customerMerges: customerMerges,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `casa_trade_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('âœ… ë°ì´í„°ê°€ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function exportToExcel() {
            // ì—‘ì…€ í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
            const workbook = XLSX.utils.book_new();
            
            // ê³ ê° ë°ì´í„° ì‹œíŠ¸
            const customerData = Object.values(allCustomers).map(customer => ({
                'ê³ ê°ëª…': customer.name,
                'ë¶„ë¥˜': customer.classification === 'trade' ? 'íŠ¸ë ˆì´ë“œ' : 'ë¶€í‹°í¬',
                'ìƒíƒœ': getStatusText(customer.status),
                'ë³´ì¦ê¸ˆ': customer.depositAmount,
                'í™˜ê¸‰ì•¡': customer.refundAmount,
                'ë§¤ì¶œì•¡': customer.salesAmount,
                'ì´ì…ê¸ˆ': customer.totalIncome,
                'ì´ì¶œê¸ˆ': customer.totalOutcome,
                'ê±°ë˜ìˆ˜': customer.transactions.length,
                'ì²«ê±°ë˜ì¼': customer.firstTransactionDate ? customer.firstTransactionDate.toLocaleDateString() : '',
                'ìµœê·¼ê±°ë˜ì¼': customer.lastTransactionDate ? customer.lastTransactionDate.toLocaleDateString() : ''
            }));
            
            const customerSheet = XLSX.utils.json_to_sheet(customerData);
            XLSX.utils.book_append_sheet(workbook, customerSheet, 'ê³ ê°ë°ì´í„°');
            
            // íŠ¸ë ˆì´ë“œ ë§¤ì¶œ ì‹œíŠ¸
            const tradeTransactions = allTransactions.filter(t => {
                const customer = allCustomers[t.customer];
                return customer && customer.classification === 'trade' && t.type === 'ì…ê¸ˆ' && 
                       !(customer.depositAmount > 0 && t.inAmount === customer.depositAmount);
            });
            
            const tradeData = tradeTransactions.map(t => ({
                'ê³ ê°ëª…': t.customer,
                'ê±°ë˜ì¼': t.date,
                'ê¸ˆì•¡': t.inAmount,
                'ë¶„ë¥˜': 'íŠ¸ë ˆì´ë“œ'
            }));
            
            const tradeSheet = XLSX.utils.json_to_sheet(tradeData);
            XLSX.utils.book_append_sheet(workbook, tradeSheet, 'íŠ¸ë ˆì´ë“œë§¤ì¶œ');
            
            // ë¶€í‹°í¬ ë§¤ì¶œ ì‹œíŠ¸
            const boutiqueTransactions = allTransactions.filter(t => {
                const customer = allCustomers[t.customer];
                return customer && customer.classification === 'boutique' && t.type === 'ì…ê¸ˆ';
            });
            
            const boutiqueData = boutiqueTransactions.map(t => ({
                'ê³ ê°ëª…': t.customer,
                'ê±°ë˜ì¼': t.date,
                'ê¸ˆì•¡': t.inAmount,
                'ë¶„ë¥˜': 'ë¶€í‹°í¬'
            }));
            
            const boutiqueSheet = XLSX.utils.json_to_sheet(boutiqueData);
            XLSX.utils.book_append_sheet(workbook, boutiqueSheet, 'ë¶€í‹°í¬ë§¤ì¶œ');
            
            // ë³´ì¦ê¸ˆ ê´€ë¦¬ ì‹œíŠ¸
            const depositData = Object.values(allCustomers)
                .filter(c => c.depositAmount > 0)
                .map(customer => ({
                    'ê³ ê°ëª…': customer.name,
                    'ë³´ì¦ê¸ˆ': customer.depositAmount,
                    'í™˜ê¸‰ì•¡': customer.refundAmount,
                    'ì°¨ì•¡': customer.depositAmount - customer.refundAmount,
                    'ìƒíƒœ': getStatusText(customer.status),
                    'í™˜ê¸‰ì¼': customer.refundDate || ''
                }));
            
            const depositSheet = XLSX.utils.json_to_sheet(depositData);
            XLSX.utils.book_append_sheet(workbook, depositSheet, 'ë³´ì¦ê¸ˆê´€ë¦¬');
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            XLSX.writeFile(workbook, `casa_trade_analysis_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('âœ… ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function getStatusText(status) {
            switch (status) {
                case 'maintained': return 'ìœ ì§€ê³ ê°';
                case 'churned': return 'ì´íƒˆê³ ê°';
                case 'refund': return 'í™˜ë¶ˆ';
                case 'boutique': return 'ë¶€í‹°í¬';
                default: return 'ë¯¸ë¶„ë¥˜';
            }
        }

        function showCustomerMergeModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>ğŸ”— ê³ ê° í†µí•© (ê°™ì€ ì‚¬ëŒì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°)</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        ì˜ˆ: "ê¹€ê·œ"ì™€ "ê¹€ê·œë‚™ì°°ê¸ˆ"ì²˜ëŸ¼ ê°™ì€ ì‚¬ëŒì´ì§€ë§Œ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ê±°ë˜í•œ ê²½ìš°
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë³‘í•©í•  ê³ ê° 1 (ë©”ì¸)</label>
                            <select id="mergeCustomer1" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                                <option value="">ê³ ê° ì„ íƒ...</option>
                                ${Object.keys(allCustomers).map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                            <div id="customer1Info" style="font-size: 0.8em; color: #6b7280; margin-top: 5px;"></div>
                        </div>
                        
                        <div style="text-align: center; font-size: 1.5em; color: #7c3aed;">â†’</div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë³‘í•©í•  ê³ ê° 2 (ë³‘í•©ë¨)</label>
                            <select id="mergeCustomer2" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                                <option value="">ê³ ê° ì„ íƒ...</option>
                                ${Object.keys(allCustomers).map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                            <div id="customer2Info" style="font-size: 0.8em; color: #6b7280; margin-top: 5px;"></div>
                        </div>
                    </div>
                    
                    <div id="mergePreview" style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                        <h4 style="margin-bottom: 10px;">ë³‘í•© ë¯¸ë¦¬ë³´ê¸°:</h4>
                        <div id="mergePreviewContent"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button class="btn" onclick="executeCustomerMerge()" id="executeMergeBtn" disabled>ë³‘í•© ì‹¤í–‰</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ê³ ê° ì„ íƒ ì‹œ ì •ë³´ í‘œì‹œ
            document.getElementById('mergeCustomer1').addEventListener('change', updateMergePreview);
            document.getElementById('mergeCustomer2').addEventListener('change', updateMergePreview);
        }

        function updateMergePreview() {
            const customer1Name = document.getElementById('mergeCustomer1').value;
            const customer2Name = document.getElementById('mergeCustomer2').value;
            
            const customer1Info = document.getElementById('customer1Info');
            const customer2Info = document.getElementById('customer2Info');
            const mergePreview = document.getElementById('mergePreview');
            const executeMergeBtn = document.getElementById('executeMergeBtn');
            
            if (customer1Name && allCustomers[customer1Name]) {
                const c1 = allCustomers[customer1Name];
                customer1Info.textContent = `ë³´ì¦ê¸ˆ: â‚©${c1.depositAmount.toLocaleString()}, ë§¤ì¶œ: â‚©${c1.salesAmount.toLocaleString()}, ê±°ë˜: ${c1.transactions.length}ê±´`;
            } else {
                customer1Info.textContent = '';
            }
            
            if (customer2Name && allCustomers[customer2Name]) {
                const c2 = allCustomers[customer2Name];
                customer2Info.textContent = `ë³´ì¦ê¸ˆ: â‚©${c2.depositAmount.toLocaleString()}, ë§¤ì¶œ: â‚©${c2.salesAmount.toLocaleString()}, ê±°ë˜: ${c2.transactions.length}ê±´`;
            } else {
                customer2Info.textContent = '';
            }
            
            if (customer1Name && customer2Name && customer1Name !== customer2Name) {
                const c1 = allCustomers[customer1Name];
                const c2 = allCustomers[customer2Name];
                
                mergePreview.style.display = 'block';
                document.getElementById('mergePreviewContent').innerHTML = `
                    <strong>"${customer2Name}"ì˜ ëª¨ë“  ê±°ë˜ê°€ "${customer1Name}"ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤:</strong><br>
                    â€¢ ì´ ê±°ë˜: ${c1.transactions.length + c2.transactions.length}ê±´<br>
                    â€¢ í•©ê³„ ë³´ì¦ê¸ˆ: â‚©${(c1.depositAmount + c2.depositAmount).toLocaleString()}<br>
                    â€¢ í•©ê³„ ë§¤ì¶œ: â‚©${(c1.salesAmount + c2.salesAmount).toLocaleString()}<br>
                    <div style="color: #dc2626; margin-top: 10px;">âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</div>
                `;
                executeMergeBtn.disabled = false;
            } else {
                mergePreview.style.display = 'none';
                executeMergeBtn.disabled = true;
            }
        }

        function executeCustomerMerge() {
            const customer1Name = document.getElementById('mergeCustomer1').value;
            const customer2Name = document.getElementById('mergeCustomer2').value;
            
            if (!customer1Name || !customer2Name || customer1Name === customer2Name) {
                showNotification('âŒ ì˜¬ë°”ë¥¸ ê³ ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (!confirm(`ì •ë§ë¡œ "${customer2Name}"ì„ "${customer1Name}"ìœ¼ë¡œ ë³‘í•©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                return;
            }
            
            const customer1 = allCustomers[customer1Name];
            const customer2 = allCustomers[customer2Name];
            
            if (!customer1 || !customer2) {
                showNotification('âŒ ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            // ê³ ê° í†µí•© ì‹¤í–‰
            mergeCustomerData(customer1Name, customer2Name);
            
            closeModal();
            updateAllTabs();
            
            showNotification(`âœ… "${customer2Name}"ì´ "${customer1Name}"ìœ¼ë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„° ìƒì„±
        function createSampleData() {
            const sampleTransactions = [
                { date: '2024-01-15', customer: 'ê¹€ê·œ', inAmount: 1000000, outAmount: 0 },
                { date: '2024-01-20', customer: 'ê¹€ê·œ', inAmount: 150000, outAmount: 0 },
                { date: '2024-01-25', customer: 'ê¹€ê·œ', inAmount: 0, outAmount: 1000000 },
                { date: '2024-02-01', customer: 'ê¹€ê·œë‚™ì°°ê¸ˆ', inAmount: 500000, outAmount: 0 },
                { date: '2024-02-05', customer: 'ê¹€ê·œë‚™ì°°ê¸ˆ', inAmount: 200000, outAmount: 0 },
                { date: '2024-02-10', customer: 'ê¹€ê·œë‚™ì°°ê¸ˆ', inAmount: 0, outAmount: 500000 },
                { date: '2024-01-10', customer: 'ì´ì˜í¬', inAmount: 50000, outAmount: 0 },
                { date: '2024-01-12', customer: 'ë°•ë¯¼ìˆ˜', inAmount: 30000, outAmount: 0 },
                { date: '2024-01-18', customer: 'ìµœì§„í˜¸', inAmount: 2000000, outAmount: 0 },
                { date: '2024-01-22', customer: 'ìµœì§„í˜¸', inAmount: 300000, outAmount: 0 },
                { date: '2024-01-28', customer: 'ìµœì§„í˜¸', inAmount: 0, outAmount: 2000000 }
            ];
            
            allTransactions = sampleTransactions.map(t => ({
                id: `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`,
                date: t.date,
                customer: t.customer,
                inAmount: t.inAmount || 0,
                outAmount: t.outAmount || 0,
                type: t.inAmount > 0 ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ',
                parsedDate: new Date(t.date)
            }));
            
            classifyCustomers();
            mergeCustomers();
            updateAllTabs();
            
            showNotification('âœ… ìƒ˜í”Œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            updateAllTabs();
        });

        // ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById('customerSearch').addEventListener('input', updateCustomersTab);
        document.getElementById('customerFilter').addEventListener('change', updateCustomersTab);
    </script>
</body>
</html>
