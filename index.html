
</html><!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëˆ„ì  ê³„ì¢Œë‚´ì—­ ì™„ì „ ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; 
        }
        .header h1 { margin-bottom: 10px; }
        .header-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .header-stat { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; }
        .header-stat-number { font-size: 1.5em; font-weight: bold; }
        .header-stat-label { font-size: 0.9em; opacity: 0.9; }
        
        .upload-section { 
            background: white; padding: 25px; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px; 
        }
        .file-drop { 
            border: 2px dashed #d1d5db; border-radius: 10px; padding: 40px 20px; 
            text-align: center; cursor: pointer; transition: all 0.2s; 
        }
        .file-drop:hover { border-color: #2563eb; background: #f8fafc; }
        .file-drop.active { border-color: #059669; background: #f0fdf4; }
        .file-input { display: none; }
        
        .tabs {
            display: flex; background: white; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px; overflow: hidden;
        }
        .tab {
            padding: 15px 20px; background: #f9fafb; border: none; 
            cursor: pointer; font-weight: 500; flex: 1; transition: all 0.2s;
        }
        .tab.active { background: #2563eb; color: white; }
        .tab:hover:not(.active) { background: #e5e7eb; }
        
        .content-section { 
            background: white; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px;
        }
        .section-header { 
            background: #f8fafc; padding: 20px; border-bottom: 1px solid #e5e7eb; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .section-title { font-size: 1.3em; font-weight: bold; color: #1f2937; }
        .section-body { padding: 20px; }
        
        .summary-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; margin-bottom: 25px; 
        }
        .summary-card { 
            background: #f9fafb; padding: 20px; border-radius: 15px; 
            border-left: 4px solid #2563eb; 
        }
        .summary-title { font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .summary-value { color: #2563eb; font-size: 1.3em; font-weight: 600; margin-bottom: 5px; }
        .summary-detail { font-size: 0.9em; color: #6b7280; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { 
            background: #f9fafb; font-weight: 600; color: #374151; 
            position: sticky; top: 0; z-index: 10;
        }
        td { font-size: 14px; }
        
        .amount-positive { color: #059669; font-weight: 600; }
        .amount-negative { color: #dc2626; font-weight: 600; }
        .amount-large { color: #7c3aed; font-weight: bold; }
        
        .customer-row { cursor: pointer; transition: background 0.2s; }
        .customer-row:hover { background: #f9fafb; }
        .customer-row.expanded { background: #f0fdf4; }
        
        .detail-row { 
            background: #f8fafc; font-size: 0.9em; 
            border-left: 3px solid #2563eb; 
        }
        .detail-row td { padding: 8px 12px; }
        
        .status-badge { 
            padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; 
        }
        .status-unreturned { background: #fef2f2; color: #dc2626; }
        .status-returned { background: #f0fdf4; color: #059669; }
        .status-refund { background: #fef2f2; color: #dc2626; }
        .status-excluded { background: #fef3c7; color: #d97706; }
        .status-new { background: #ede9fe; color: #7c3aed; }
        .status-sales { background: #dbeafe; color: #2563eb; }
        .status-deposit { background: #fef3c7; color: #d97706; }
        
        .btn { 
            background: #2563eb; color: white; padding: 12px 24px; 
            border: none; border-radius: 8px; cursor: pointer; 
            font-weight: 500; transition: all 0.2s; margin: 0 5px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        
        .search-filter {
            display: flex; gap: 15px; margin-bottom: 20px; align-items: center;
        }
        .search-input {
            padding: 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; 
            font-size: 14px; flex: 1; max-width: 300px;
        }
        
        .notification { 
            position: fixed; top: 20px; right: 20px; background: #059669; 
            color: white; padding: 15px 20px; border-radius: 8px; z-index: 1000; 
            transform: translateX(300px); transition: transform 0.3s ease; 
        }
        .notification.show { transform: translateX(0); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .progress-bar {
            background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            background: #2563eb; height: 100%; transition: width 0.3s ease;
        }
        
        .transaction-type-income { background: #f0fdf4; }
        .transaction-type-outcome { background: #fef2f2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ëˆ„ì  ê³„ì¢Œë‚´ì—­ ì™„ì „ ë¶„ì„ ì‹œìŠ¤í…œ</h1>
            <p>ì „ì²´ ê³„ì¢Œë‚´ì—­ ëˆ„ì  ë¶„ì„ â€¢ ë§¤ì¶œ/ë³´ì¦ê¸ˆ/í™˜ê¸‰ ì™„ì „ ì¶”ì  â€¢ ìƒì„¸ ê±°ë˜ë‚´ì—­ í™•ì¸</p>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-number" id="totalTransactions">0ê±´</div>
                    <div class="header-stat-label">ì´ ê±°ë˜ ê±´ìˆ˜</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="totalIncome">â‚©0</div>
                    <div class="header-stat-label">ì´ ì…ê¸ˆì•¡</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="totalCustomers">0ëª…</div>
                    <div class="header-stat-label">ì „ì²´ ê³ ê° ìˆ˜</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="finalSalesAmount">â‚©0</div>
                    <div class="header-stat-label">ìµœì¢… ë§¤ì¶œì•¡</div>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <div class="file-drop" id="fileDrop">
                <h3>ğŸ“‚ ê³„ì¢Œë‚´ì—­ ì—…ë¡œë“œ (ëˆ„ì  ë¶„ì„)</h3>
                <p>ìƒˆë¡œìš´ ê³„ì¢Œë‚´ì—­ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ë¡œ ëˆ„ì ë©ë‹ˆë‹¤</p>
                <div id="uploadStatus"></div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px; align-items: center;">
                <button onclick="analyzeData()" class="btn" id="analyzeBtn" disabled>ğŸ” ì „ì²´ ë°ì´í„° ë¶„ì„</button>
                <button onclick="clearData()" class="btn btn-secondary">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
                <button onclick="exportData()" class="btn btn-secondary">ğŸ“Š ë¶„ì„ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
                <div id="processStatus" style="flex: 1; text-align: right;"></div>
            </div>
            <div class="progress-bar" id="progressContainer" style="display: none;">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('ceoDashboard')">ğŸ“Š CEO ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab" onclick="showTab('deposits')">ğŸ¦ ë³´ì¦ê¸ˆ ê´€ë¦¬</button>
            <button class="tab" onclick="showTab('tradeSales')">ğŸª íŠ¸ë ˆì´ë“œ ë§¤ì¶œ</button>
            <button class="tab" onclick="showTab('boutiqueSales')">ğŸ›ï¸ ë¶€í‹°í¬ ë§¤ì¶œ</button>
            <button class="tab" onclick="showTab('monthly')">ğŸ“… ì›”ë³„ ë¶„ì„</button>
            <button class="tab" onclick="showTab('transactions')">ğŸ“‹ ì „ì²´ ê±°ë˜</button>
        </div>

        <!-- CEO ëŒ€ì‹œë³´ë“œ íƒ­ -->
        <div id="ceoDashboard" class="content-section tab-content active">
            <div class="section-header">
                <div class="section-title">ğŸ“Š CEO ìš”ì•½ ëŒ€ì‹œë³´ë“œ</div>
            </div>
            <div class="section-body">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-title">ğŸ’° ì´ ë³´ì¦ê¸ˆ</div>
                        <div class="summary-value" id="ceoDashboardTotalDeposits">â‚©0</div>
                        <div class="summary-detail" id="ceoDashboardDepositDetail">ë¯¸í™˜ê¸‰ + í™˜ê¸‰ì™„ë£Œ</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“ˆ ì´ ë§¤ì¶œ</div>
                        <div class="summary-value" id="ceoDashboardTotalSales">â‚©0</div>
                        <div class="summary-detail" id="ceoDashboardSalesDetail">íŠ¸ë ˆì´ë“œ + ë¶€í‹°í¬</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">âš ï¸ ì´íƒˆ ìœ„í—˜ ê³ ê°</div>
                        <div class="summary-value" id="ceoDashboardRiskCustomers">0ëª…</div>
                        <div class="summary-detail" id="ceoDashboardRiskDetail">ë³´ì¦ê¸ˆ ìˆìœ¼ë‚˜ ë§¤ì¶œ ì—†ìŒ</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“Š ë³´ì¦ê¸ˆ íš¨ìœ¨ì„±</div>
                        <div class="summary-value" id="ceoDashboardEfficiency">0%</div>
                        <div class="summary-detail" id="ceoDashboardEfficiencyDetail">ë§¤ì¶œ ëŒ€ë¹„ ë³´ì¦ê¸ˆ ë¹„ìœ¨</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px;">ğŸ“ˆ ì›”ë³„ ì„±ì¥ ë¹„êµ</h4>
                        <div id="monthlyGrowthChart"></div>
                    </div>
                    <div style="background: #f9fafb; padding: 20px; border-radius: 10px;">
                        <h4 style="margin-bottom: 15px;">ğŸ‘¥ ê³ ê° ì„±ì¥ íŒ¨í„´</h4>
                        <div id="customerGrowthChart"></div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;">âš ï¸ ì´íƒˆ ìœ„í—˜ ê³ ê° ëª©ë¡</h4>
                    <div id="riskCustomersList"></div>
                </div>

                <div id="recentUploads" style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;">ğŸ“‚ ì—…ë¡œë“œëœ íŒŒì¼ í˜„í™©</h4>
                    <div id="uploadHistory"></div>
                </div>
            </div>
        </div>

        <!-- ë³´ì¦ê¸ˆ ê´€ë¦¬ íƒ­ -->
        <div id="deposits" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ¦ ë³´ì¦ê¸ˆ ê´€ë¦¬</div>
                <div class="search-filter">
                    <input type="text" id="depositSearch" class="search-input" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                    <select id="depositFilter" class="search-input" style="max-width: 150px;">
                        <option value="all">ì „ì²´ ë³´ì¦ê¸ˆ</option>
                        <option value="active">í˜„ì¬ ìœ ì§€ê³ ê°</option>
                        <option value="returned">ì´íƒˆê³ ê°(í™˜ê¸‰ì™„ë£Œ)</option>
                        <option value="large">ê³ ì•¡ (500ë§Œ+)</option>
                    </select>
                    <select id="depositSort" class="search-input" style="max-width: 120px;">
                        <option value="deposit_desc">ë³´ì¦ê¸ˆâ†“</option>
                        <option value="deposit_asc">ë³´ì¦ê¸ˆâ†‘</option>
                        <option value="date_desc">ìµœì‹ ìˆœ</option>
                        <option value="date_asc">ì˜¤ë˜ëœìˆœ</option>
                        <option value="deposit_date_desc">ë³´ì¦ê¸ˆì…ê¸ˆìˆœ(ìµœì‹ )</option>
                        <option value="deposit_date_asc">ë³´ì¦ê¸ˆì…ê¸ˆìˆœ(ì˜¤ë˜ëœ)</option>
                    </select>
                </div>
            </div>
            <div class="section-body">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-title">ğŸ”´ ë¯¸í™˜ê¸‰ ë³´ì¦ê¸ˆ</div>
                        <div class="summary-value" id="unreturnedDepositAmount">â‚©0</div>
                        <div class="summary-detail" id="unreturnedDepositCount">0ëª… ê³ ê°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">âœ… í™˜ê¸‰ì™„ë£Œ ë³´ì¦ê¸ˆ</div>
                        <div class="summary-value" id="returnedDepositAmount">â‚©0</div>
                        <div class="summary-detail" id="returnedDepositCount">0ëª… ê³ ê°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“Š ë³´ì¦ê¸ˆ íš¨ìœ¨ì„±</div>
                        <div class="summary-value" id="depositEfficiency">0%</div>
                        <div class="summary-detail" id="depositEfficiencyDetail">ë§¤ì¶œ ì „í™˜ìœ¨</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">âš ï¸ ì£¼ì˜ ê³ ê°</div>
                        <div class="summary-value" id="warningCustomers">0ëª…</div>
                        <div class="summary-detail" id="warningCustomersDetail">ë³´ì¦ê¸ˆë§Œ ìˆê³  ë§¤ì¶œ ì—†ìŒ (ë¯¸í™˜ê¸‰)</div>
                    </div>
                </div>
                
                <table id="depositsTable">
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ë³´ì¦ê¸ˆ</th>
                            <th>ë³´ì¦ê¸ˆ ë‚ ì§œ</th>
                            <th>í™˜ê¸‰ìƒíƒœ</th>
                            <th>í™˜ê¸‰ì¼</th>
                            <th>ë§¤ì¶œ</th>
                            <th>ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- íŠ¸ë ˆì´ë“œ ë§¤ì¶œ ë¶„ì„ íƒ­ -->
        <div id="tradeSales" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸª íŠ¸ë ˆì´ë“œ ë§¤ì¶œ ê±°ë˜ë‚´ì—­ (ìµœì‹ ìˆœ)</div>
                <div class="search-filter">
                    <input type="text" id="tradeSearch" class="search-input" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                    <select id="tradeFilter" class="search-input" style="max-width: 200px;">
                        <option value="all">ì „ì²´ íŠ¸ë ˆì´ë“œ</option>
                        <option value="high">ê³ ì•¡ (500ë§Œ+)</option>
                        <option value="medium">ì¤‘ì•¡ (100ë§Œ+)</option>
                        <option value="low">ì†Œì•¡ (100ë§Œë¯¸ë§Œ)</option>
                        <option value="recent">ìµœê·¼ 7ì¼</option>
                    </select>
                    <select id="tradeSort" class="search-input" style="max-width: 120px;">
                        <option value="date_desc">ìµœì‹ ìˆœ</option>
                        <option value="amount_desc">ê¸ˆì•¡â†“</option>
                        <option value="amount_asc">ê¸ˆì•¡â†‘</option>
                        <option value="customer_asc">ê³ ê°ëª…ìˆœ</option>
                    </select>
                </div>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="tradeSummaryGrid">
                    <div class="summary-card">
                        <div class="summary-title">ğŸª ì´ íŠ¸ë ˆì´ë“œ ë§¤ì¶œ</div>
                        <div class="summary-value" id="totalTradeRevenue">â‚©0</div>
                        <div class="summary-detail" id="totalTradeCount">0ê±´ ê±°ë˜</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“… ì˜¤ëŠ˜ ë§¤ì¶œ</div>
                        <div class="summary-value" id="todayTradeRevenue">â‚©0</div>
                        <div class="summary-detail" id="todayTradeCount">0ê±´ ê±°ë˜</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ”¥ ì´ë²ˆì£¼ ë§¤ì¶œ</div>
                        <div class="summary-value" id="weekTradeRevenue">â‚©0</div>
                        <div class="summary-detail" id="weekTradeCount">0ê±´ ê±°ë˜</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“ˆ í‰ê·  ê±°ë˜ì•¡</div>
                        <div class="summary-value" id="avgTradeAmount">â‚©0</div>
                        <div class="summary-detail" id="avgTradeDetail">ê±°ë˜ë‹¹ í‰ê· </div>
                    </div>
                </div>
                
                <table id="tradeTable">
                    <thead>
                        <tr>
                            <th>ê±°ë˜ì¼ì‹œ</th>
                            <th>ê³ ê°ëª…</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>ê±°ë˜íƒ€ì…</th>
                            <th>ëˆ„ì ë§¤ì¶œ</th>
                            <th>ë³´ì¦ê¸ˆìƒíƒœ</th>
                            <th>ìƒì„¸ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ë¶€í‹°í¬ ë§¤ì¶œ ë¶„ì„ íƒ­ -->
        <div id="boutiqueSales" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ›ï¸ ë¶€í‹°í¬ ë§¤ì¶œ ë¶„ì„</div>
                <div class="search-filter">
                    <input type="text" id="boutiqueSearch" class="search-input" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                    <select id="boutiqueFilter" class="search-input" style="max-width: 200px;">
                        <option value="all">ì „ì²´ ë¶€í‹°í¬</option>
                        <option value="high">ê³ ë§¤ì¶œ (200ë§Œ+)</option>
                        <option value="medium">ì¤‘ë§¤ì¶œ (50ë§Œ+)</option>
                        <option value="low">ì €ë§¤ì¶œ (50ë§Œë¯¸ë§Œ)</option>
                    </select>
                    <select id="boutiqueSort" class="search-input" style="max-width: 120px;">
                        <option value="sales_desc">ë§¤ì¶œâ†“</option>
                        <option value="sales_asc">ë§¤ì¶œâ†‘</option>
                        <option value="date_desc">ìµœì‹ ìˆœ</option>
                        <option value="date_asc">ì˜¤ë˜ëœìˆœ</option>
                    </select>
                </div>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="boutiqueSummaryGrid">
                    <!-- ë¶€í‹°í¬ ë§¤ì¶œ ìš”ì•½ ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                
                <table id="boutiqueTable">
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>ê±°ë˜ê±´ìˆ˜</th>
                            <th>ê±°ë˜ê¸°ê°„</th>
                            <th>ì›”í‰ê· </th>
                            <th>ì²«ê±°ë˜ì¼</th>
                            <th>ìƒì„¸ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ì›”ë³„ ë¶„ì„ íƒ­ -->
        <div id="monthly" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ“… ì›”ë³„ ê±°ë˜ í˜„í™©</div>
            </div>
            <div class="section-body">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“Š ì›”ë³„ ë¶„ì„ ê¸°ì¤€</div>
                        <div class="summary-value">ìˆœìˆ˜ ë§¤ì¶œë§Œ</div>
                        <div class="summary-detail">ë³´ì¦ê¸ˆ, í™˜ê¸‰, ì œì™¸í•­ëª© ì™„ì „ ì œì™¸í•œ ì‹¤ì œ ë§¤ì¶œ ê±°ë˜</div>
                    </div>
                </div>
                
                <table id="monthlyTable">
                    <thead>
                        <tr>
                            <th>ë…„ì›”</th>
                            <th>ë§¤ì¶œ ê±°ë˜ê±´ìˆ˜</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>íŠ¸ë ˆì´ë“œ/ë¶€í‹°í¬</th>
                            <th>ì‹ ê·œê³ ê°</th>
                            <th>í‰ê· ê±°ë˜ì•¡</th>
                            <th>ì „ì›”ëŒ€ë¹„</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ì „ì²´ ê±°ë˜ íƒ­ -->
        <div id="transactions" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ“‹ ì „ì²´ ê±°ë˜ ë‚´ì—­ (ì§ì› ë¶„ë¥˜ ê°€ëŠ¥)</div>
                <div class="search-filter">
                    <input type="text" id="transactionSearch" class="search-input" placeholder="ê³ ê°ëª…/ë‚ ì§œ ê²€ìƒ‰...">
                    <select id="transactionFilter" class="search-input" style="max-width: 200px;">
                        <option value="all">ì „ì²´</option>
                        <option value="income">ì…ê¸ˆë§Œ</option>
                        <option value="outcome">ì¶œê¸ˆë§Œ</option>
                        <option value="large">100ë§Œì› ì´ìƒ</option>
                        <option value="recent">ìµœê·¼ 30ì¼</option>
                        <option value="unclassified">ë¯¸ë¶„ë¥˜</option>
                    </select>
                    <button class="btn" onclick="exportClassificationData()">ğŸ“Š ë¶„ë¥˜ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn btn-secondary" onclick="importClassificationData()">ğŸ“¥ ë¶„ë¥˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
                    <button class="btn" style="background: #7c3aed;" onclick="showCustomerMergeModal()">ğŸ”— ê³ ê° ë³‘í•©</button>
                </div>
            </div>
            <div class="section-body">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“ ë¶„ë¥˜ ì™„ë£Œ</div>
                        <div class="summary-value" id="classifiedCount">0ê±´</div>
                        <div class="summary-detail">ì „ì²´ ê±°ë˜ ëŒ€ë¹„ ë¶„ë¥˜ ì™„ë£Œìœ¨</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">â³ ë¯¸ë¶„ë¥˜</div>
                        <div class="summary-value" id="unclassifiedCount">0ê±´</div>
                        <div class="summary-detail">ë¶„ë¥˜ í•„ìš”í•œ ê±°ë˜</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸª íŠ¸ë ˆì´ë“œ ë§¤ì¶œ</div>
                        <div class="summary-value" id="tradeClassifiedCount">0ê±´</div>
                        <div class="summary-detail">ì§ì› ë¶„ë¥˜ íŠ¸ë ˆì´ë“œ ë§¤ì¶œ</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ›ï¸ ë¶€í‹°í¬ ë§¤ì¶œ</div>
                        <div class="summary-value" id="boutiqueClassifiedCount">0ê±´</div>
                        <div class="summary-detail">ì§ì› ë¶„ë¥˜ ë¶€í‹°í¬ ë§¤ì¶œ</div>
                    </div>
                </div>
                
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ê³ ê°ëª…</th>
                            <th>ì…ê¸ˆì•¡</th>
                            <th>ì¶œê¸ˆì•¡</th>
                            <th>ìë™ë¶„ë¥˜</th>
                            <th>ì§ì›ë¶„ë¥˜</th>
                            <th>ë¹„ê³ </th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        let allTransactions = [];
        let allCustomers = {};
        let uploadHistory = [];
        let analysisComplete = false;
        let staffClassifications = {};
    
        // ì œì™¸ ê³ ê° ë° íŒ¨í„´ ê·œì¹™ (KBì²´í¬, ì´ìì„¸ê¸ˆ ë“± ë§¤ì¶œì´ ì•„ë‹Œ ê±°ë˜ë“¤)
        const excludePatterns = ['í™©ìŠ¹í•˜', 'í™©ìŠ¹í•˜(ì¿¨í‚¤ì¦ˆí´ëŸ½)', 'SENTBE', 'ì´ì°½í›ˆ', 'êµ­ê³ í™˜ê¸‰:ì€í‰ì„¸ë¬´ì„œ', 'ì£¼ì‹íšŒì‚¬í•„ì›¨ì´', 'KBì²´í¬', 'ì²´í¬', 'ë§ˆìŠ¤íƒ€í•´ì™¸ìŠ¹ì¸ì¶œê¸ˆ', 'ì´ìì„¸ê¸ˆ', 'ìë™ê²°ì œ', 'Amazon_AWS', 'NICE', 'ë‹¬ë¹›í¬ì°¨', 'ìœ ì±„ì—°', 'êµ¬ê¸€í”Œë ˆì´', 'GooglePlay', 'Google Play', 'ë¹„ëŒ€ë©´ë‹¹ë°œì†¡ê¸ˆì·¨ì†Œ'];
        const specialCases = {
            'ê¹€ì§„í˜¸': { 
                type: 'settlement_complete', 
                note: 'ë³´ì¦ê¸ˆ 500ë§Œì› ì •ì‚° ì™„ë£Œ',
                deposit: 5000000,
                sales: 576168,
                fee: 94071,
                refund: 4905929
            },
            'ì±„í˜': { type: 'deposit_management', note: 'ì˜ˆì¹˜ê¸ˆ í˜•íƒœ ìš´ì˜' },
            'ì£¼ì‹íšŒì‚¬ã€€í…Œì´ë°ë©(': { type: 'full_refund', note: 'ì „ì•¡ í™˜ë¶ˆ' },
            'ì£¼ì‹íšŒì‚¬ã€€í…Œì´ë°ë©': { type: 'full_refund', note: 'ì „ì•¡ í™˜ë¶ˆ' },
            'í…Œì´ë°ë©': { type: 'full_refund', note: 'ì „ì•¡ í™˜ë¶ˆ' },
            'ì¡°íƒœë ¨': { type: 'deposit_500', note: '500ë§Œì› ë³´ì¦ê¸ˆ' },
            'ì£¼ì‹íšŒì‚¬ë””ì—”ë””(DND)': { type: 'pre_deposit', note: 'ì˜ˆì¹˜ê¸ˆ í˜•íƒœ' },
            'ë””ì—”ë””': { type: 'pre_deposit', note: 'ì˜ˆì¹˜ê¸ˆ í˜•íƒœ' },
            'ê°•íš¨ìˆœ': { type: 'deposit_1000000_for_kangminguk', note: 'ê°•ë¯¼êµ­ ë³´ì¦ê¸ˆ(ì—„ë§ˆëª…ì˜) - ë³´ì¦ê¸ˆ ê´€ë¦¬ì—ì„œ ì œì™¸', depositAmount: 1000000, excludeFromDepositManagement: true },
            'ê°•ë¯¼êµ­': { type: 'linked_to_kanghyosoon', note: 'ê°•íš¨ìˆœ ëª…ì˜ ë³´ì¦ê¸ˆ 1000ë§Œì›', depositAmount: 1000000, returnDate: '2025-07-03' },
            'ê¹€ì„ ì˜': { type: 'deposit_2000000', note: 'ë³´ì¦ê¸ˆ 200ë§Œì› (100ë§ŒÃ—2íšŒ)', depositAmount: 2000000, returnDate: '2025-06-30' },
            'ì‹ ìˆ˜ì—°': { type: 'partial_refund', note: 'ë³´ì¦ê¸ˆ 1500ë§Œì› â†’ 1000ë§Œì› ë¶€ë¶„í™˜ê¸‰ â†’ ì”ì•¡ 500ë§Œì›', 
                      totalDeposit: 15000000, partialRefund: 10000000, remainingDeposit: 5000000, 
                      refundDate: '2025-09-17' },
            'ì´ìœ ì§„': { type: 'complex_deposit_case', note: 'ë³´ì¦ê¸ˆ 50ë§Œì›, ì›”ì´ìš©ë£Œ ì°¨ê° 104,000ì›, í™˜ë¶ˆ 1,009,475ì›', 
                      depositAmount: 500000, 
                      monthlyFeeDeduction: 104000,
                      actualRefund: 1009475,
                      specialCalculation: true },
            'ì‹ ë²”ìˆ˜': { type: 'deposit_500000', note: 'ë³´ì¦ê¸ˆ 50ë§Œì›', depositAmount: 500000 },
            'ê¹€ìœ ë¹ˆ': { type: 'deposit_100000', note: 'ë³´ì¦ê¸ˆ 10ë§Œì›', depositAmount: 100000 },
            'ì •ìµë§Œ': { type: 'deposit_500000', note: 'ë³´ì¦ê¸ˆ 50ë§Œì› (ë§¤ì¶œ ìˆìŒ)', depositAmount: 500000, hasSales: true },
            'ì •ìµë§Œ(ì‡¼í•‘777)': { type: 'deposit_500000', note: 'ë³´ì¦ê¸ˆ 50ë§Œì› (ë§¤ì¶œ ìˆìŒ)', depositAmount: 500000, hasSales: true },
            'ìµœì¬ì—°': { type: 'deposit_500000_returned', note: 'ë³´ì¦ê¸ˆ 50ë§Œì› í™˜ê¸‰ì™„ë£Œ', depositAmount: 500000, returnDate: '2025-07-07' },
            'ìµœì¬ì—°(ë”ì œì´ëª…í’ˆ)': { type: 'deposit_500000_returned', note: 'ë³´ì¦ê¸ˆ 50ë§Œì› í™˜ê¸‰ì™„ë£Œ', depositAmount: 500000, returnDate: '2025-07-07' },
            'ê¹€ê·œ': { type: 'deposit_2000000', note: 'ë³´ì¦ê¸ˆ 200ë§Œì› (7/14: 50ë§Œì› + 7/17: 150ë§Œì›)', depositAmount: 2000000, 
                     excludeTransactions: ['2025-07-21'], depositDate: '2025-07-14' },
            'ê¹€ì§„í˜¸': { type: 'deposit_refund_complete', note: 'ë§¤ì¶œ 576,168ì› í™•ì •. ë¯¸ê²°ì œ 94,071ì› ìƒê³„ í›„ í™˜ê¸‰ì™„ë£Œ', depositAmount: 670239, returnDate: '2025-07-06', salesAmount: 576168 },
            'ê¹€ë¯¸ì •': { type: 'deposit_2500000', note: 'ë³´ì¦ê¸ˆ 250ë§Œì› (8/14: 100ë§Œì› + 8/15: 150ë§Œì›)', depositAmount: 2500000, 
                      depositDate: '2025-08-14' },
            'ì „í™˜ìŠ¹': { type: 'deposit_300000', note: 'ë³´ì¦ê¸ˆ 30ë§Œì›', depositAmount: 300000 },
            'ë²ˆê°œì¥í„° í›„ë£¨ì¸ ': { type: 'boutique_forced', note: 'ë„ì†Œë§¤ ë§¤ì¶œ' },
            'ë²ˆê°œì¥í„°': { type: 'boutique_forced', note: 'ë„ì†Œë§¤ ë§¤ì¶œ' },
            'í›„ë£¨ì¸ íŒ¨ë°€ë¦¬': { type: 'boutique_forced', note: 'ë„ì†Œë§¤ ë§¤ì¶œ' },
            'ì¥ìœ ì€': { type: 'boutique_forced', note: 'ë„ì†Œë§¤ ë§¤ì¶œ' },
            'ê¹€ì˜ì£¼': { type: 'boutique_forced', note: 'ë„ì†Œë§¤ ë§¤ì¶œ' }
        };
        
        // 5ì›” ê¸°ì¤€ í™˜ê¸‰ì™„ë£Œ ì •ë³´
        const knownRefunds = {
            'ìµœì˜ìˆ™': { amount: 5000000, date: '2024-05-01' },
            'ì´íƒœí¬': { amount: 2000000, date: '2024-05-01' },
            'ê¹€í˜‘': { amount: 2000000, date: '2024-05-01' },
            'ë””ì–´ë¹ˆí‹°ì§€': { amount: 2000000, date: '2024-05-01' },
            'ë””ì–´ë¹ˆí‹°ì§€(ê¹€ìˆ˜ì•ˆ)': { amount: 2000000, date: '2024-05-01' },
            'ìµœì¬í›ˆ': { amount: 1080000, date: '2024-05-01' },
            'ë°±ê¸°ë ¬(ë¹ˆì§‘í„¸ì´)': { amount: 1000000, date: '2024-05-01' },
            'ë°±ê¸°ë ¬': { amount: 1000000, date: '2024-05-01' },
            'ê¹€ë™ë²”': { amount: 570000, date: '2024-05-01' },
            'ê¹€ë„í˜„': { amount: 500000, date: '2024-05-01' },
            'ì´ì‹œí›ˆ': { amount: 230000, date: '2024-05-01' },
            'ì´ì˜ˆì§„': { amount: 100000, date: '2024-05-01' }
        };
    
        // ê³ ê°ëª… ì •ê·œí™” í•¨ìˆ˜ (ê°™ì€ ì‚¬ëŒ ë‹¤ë¥¸ í‘œê¸° í†µí•©)
        function normalizeCustomerName(customerName) {
            if (!customerName) return customerName;
            
            let normalized = customerName.trim();
            
            // 1ë‹¨ê³„: ê´„í˜¸ ì•ˆì˜ ë‚´ìš© ì œê±° (ë¯¸ë‡½ë“œë¼íŒ¡(ì¡°ì£¼ìœ¤) -> ë¯¸ë‡½ë“œë¼íŒ¡)
            normalized = normalized.replace(/\([^)]*\)/g, '').trim();
            
            // 2ë‹¨ê³„: ë’¤ì— ë¶™ëŠ” ê±°ë˜ ê´€ë ¨ í‚¤ì›Œë“œë“¤ ì œê±°
            const suffixPatterns = [
                /\s*(ë‚™ì°°ê¸ˆ|ë³´ì¦ê¸ˆ|ë§¤ì¶œ|ì…ê¸ˆ|í™˜ê¸‰|ì¶œê¸ˆ|ê±°ë˜|íŒë§¤|êµ¬ë§¤)\s*$/g,
                /\s*[-\s]*(ë‚™ì°°|ë³´ì¦|ë§¤ì¶œ|ì…ê¸ˆ|í™˜ê¸‰|ì¶œê¸ˆ|ê±°ë˜|íŒë§¤|êµ¬ë§¤)\s*$/g
            ];
            
            suffixPatterns.forEach(pattern => {
                normalized = normalized.replace(pattern, '').trim();
            });
            
            // â–¼ ìë™ ë¶€ë¶„í™˜ê¸‰/ì›”ì´ìš©ë£Œ ì°¨ê°: ì§ì›ë¶„ë¥˜ê°€ ì—†ì–´ë„ ê³ ê° ì¶œê¸ˆì€ ë³´ì¦ê¸ˆì—ì„œ ì°¨ê°
            Object.values(allCustomers).forEach(customer => {
                if (customer.excluded) return;
                if (!customer.transactions || customer.transactions.length === 0) return;
                
                // ë³´ì¦ê¸ˆì´ ê°ì§€ëœ ê³ ê°ë§Œ ì²˜ë¦¬
                if ((customer.depositAmount || 0) > 0) {
                    const customerTransactions = customer.transactions;
                    const totalCustomerOut = customerTransactions
                        .filter(t => t.type === 'ì¶œê¸ˆ')
                        .reduce((sum, t) => sum + (t.outAmount || 0), 0);
                    
                    // ì§ì›ë¶„ë¥˜ ì›”ì´ìš©ë£Œ í•©ê³„(ì…ê¸ˆ/ì¶œê¸ˆ ì–´ëŠ ìª½ì´ë“  ê¸ˆì•¡ ì‚¬ìš©)
                    let totalMonthlyFee = 0;
                    let totalActualRefund = 0;
                    customerTransactions.forEach(t => {
                        const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                        if (staffClassifications[tId] === 'monthlyFee') {
                            totalMonthlyFee += (t.inAmount || t.outAmount || 0);
                        }
                        if (staffClassifications[tId] === 'actualRefund') {
                            totalActualRefund += (t.inAmount || t.outAmount || 0);
                        }
                    });
                    
                    const adjusted = Math.max(0, (customer.depositAmount || 0) - totalCustomerOut - totalMonthlyFee);
                    
                    // ì‹¤ì œ ë§¤ì¶œ ê³„ì‚° (ì´ ë§¤ì¶œ - í™˜ë¶ˆ ê¸ˆì•¡)
                    if (totalActualRefund > 0) {
                        customer.salesAmount = Math.max(0, customer.totalIncome - totalActualRefund);
                    }
                    
                    // í™˜ê¸‰ì™„ë£Œ ì—¬ë¶€ ì—…ë°ì´íŠ¸
                    if (adjusted === 0 && totalCustomerOut > 0) {
                        customer.depositStatus = 'returned';
                        const refundTx = customerTransactions.filter(t => t.type === 'ì¶œê¸ˆ').sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                        if (refundTx) customer.returnDate = refundTx.date;
                    } else if (adjusted > 0) {
                        customer.depositStatus = 'unreturned';
                        customer.returnDate = customer.returnDate || null;
                    }
                    customer.depositAmount = adjusted;
                }
            });
            
            // 3ë‹¨ê³„: ê³µë°±ê³¼ íŠ¹ìˆ˜ë¬¸ì ì •ë¦¬
            normalized = normalized.replace(/\s+/g, ' ').trim();
            
            // 4ë‹¨ê³„: íšŒì‚¬ëª… ì •ë¦¬ (ì£¼ì‹íšŒì‚¬, (ì£¼) ë“±)
            normalized = normalized.replace(/^(ì£¼ì‹íšŒì‚¬\s*|ì£¼ì‹íšŒì‚¬|ì£¼\s*|ãˆœ\s*)/g, '').trim();
            normalized = normalized.replace(/\s*ï¼ˆ\s*$/g, '').trim(); // ì „ê° ê´„í˜¸ ì œê±°
            
            // 5ë‹¨ê³„: ìµœì¢… ì´ë¦„ ë§¤í•‘ (ì™„ì „íˆ ë‹¤ë¥¸ í‘œê¸°ë²•ë“¤ë§Œ)
            const finalMapping = {
                'í…Œì´ë°ë©': 'í…Œì´ë°ë©',
                'ë””ì—”ë””': 'ë””ì—”ë””',
                'DND': 'ë””ì—”ë””',
                'ë²ˆê°œì¥í„° í›„ë£¨ì¸ ': 'ë²ˆê°œì¥í„°',
                'í›„ë£¨ì¸ íŒ¨ë°€ë¦¬': 'í›„ë£¨ì¸ íŒ¨ë°€ë¦¬'
            };
            
            return finalMapping[normalized] || normalized;
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEY = 'accountAnalysisData';
    
        // ìŠ¤ë§ˆíŠ¸í•œ ë³´ì¦ê¸ˆ ê±°ë˜ ì¸ì‹ í•¨ìˆ˜
        function isTransactionDeposit(customer, transaction) {
            if (transaction.type !== 'ì…ê¸ˆ') return false;
            
            console.log(`=== ë³´ì¦ê¸ˆ ì²´í¬: ${customer.name} ===`);
            console.log('ê±°ë˜ì¼:', transaction.date, 'ê¸ˆì•¡:', transaction.inAmount);
            console.log('ê³ ê° ë³´ì¦ê¸ˆ:', customer.depositAmount, 'ë³´ì¦ê¸ˆì¼:', customer.depositDate);
            
            // 1. ê¸°ë³¸ ë³´ì¦ê¸ˆ ê±°ë˜ (ì²« ê±°ë˜ì´ê³  100ë§Œì› ì´ìƒ)
            if (customer.depositAmount > 0 && transaction.inAmount === customer.depositAmount && transaction.date === customer.depositDate) {
                console.log('â†’ ê¸°ë³¸ ë³´ì¦ê¸ˆ ê±°ë˜ ì¸ì‹');
                return true;
            }
            
            // 2. íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ë“¤ ìë™ ì¸ì‹
            const specialCase = specialCases[customer.name];
            console.log('íŠ¹ìˆ˜ì¼€ì´ìŠ¤:', specialCase);
            
            if (specialCase) {
                // ê¹€ë¯¸ì •: 8/14(100ë§Œ) + 8/15(150ë§Œ) = 250ë§Œ ë³´ì¦ê¸ˆ
                if (specialCase.type === 'deposit_2500000') {
                    const isKimMijeongDeposit = (transaction.date === '2025-08-14' && transaction.inAmount === 1000000) ||
                           (transaction.date === '2025-08-15' && transaction.inAmount === 1500000);
                    console.log('â†’ ê¹€ë¯¸ì • ë³´ì¦ê¸ˆ ì²´í¬:', isKimMijeongDeposit);
                    if (isKimMijeongDeposit) return true;
                }
                
                // ê¹€ê·œ: 7/14(50ë§Œ) + 7/17(150ë§Œ) = 200ë§Œ ë³´ì¦ê¸ˆ
                if (specialCase.type === 'deposit_2000000') {
                    const isKimGyuDeposit = (transaction.date === '2025-07-14' && transaction.inAmount === 500000) ||
                           (transaction.date === '2025-07-17' && transaction.inAmount === 1500000);
                    console.log('â†’ ê¹€ê·œ ë³´ì¦ê¸ˆ ì²´í¬:', isKimGyuDeposit);
                    if (isKimGyuDeposit) return true;
                }
                
                // ê¹€ì„ ì˜: ë³´ì¦ê¸ˆ 200ë§Œì› (100ë§ŒÃ—2íšŒ)
                if (specialCase.type === 'deposit_2000000' && specialCase.depositAmount === 2000000) {
                    // ì²« 2ë²ˆì˜ 100ë§Œì› ê±°ë˜
                    const incomeTransactions = customer.transactions
                        .filter(t => t.type === 'ì…ê¸ˆ')
                        .sort((a, b) => a.parsedDate - b.parsedDate);
                    const firstTwoTransactions = incomeTransactions.slice(0, 2);
                    const isFirstTwoDeposits = firstTwoTransactions.some(t => 
                        t.date === transaction.date && 
                        t.inAmount === transaction.inAmount && 
                        t.inAmount === 1000000
                    );
                    console.log('â†’ ê¹€ì„ ì˜ ë³´ì¦ê¸ˆ ì²´í¬:', isFirstTwoDeposits);
                    if (isFirstTwoDeposits) return true;
                }
                
                // ê¸°íƒ€ ì§€ì •ëœ ë³´ì¦ê¸ˆ ê¸ˆì•¡
                if (specialCase.depositAmount && transaction.inAmount === specialCase.depositAmount) {
                    // ì²« ê±°ë˜ì¸ì§€ í™•ì¸
                    const sortedTransactions = customer.transactions
                        .filter(t => t.type === 'ì…ê¸ˆ')
                        .sort((a, b) => a.parsedDate - b.parsedDate);
                    const isFirstTransaction = sortedTransactions[0] && 
                           sortedTransactions[0].date === transaction.date && 
                           sortedTransactions[0].inAmount === transaction.inAmount;
                    console.log('â†’ ê¸°íƒ€ ë³´ì¦ê¸ˆ ì²´í¬:', isFirstTransaction);
                    if (isFirstTransaction) return true;
                }
            }
            
            // 3. ì¼ë°˜ì ì¸ ë³´ì¦ê¸ˆ íŒ¨í„´ (ì²« ê±°ë˜ê°€ í° ê¸ˆì•¡)
            const sortedTransactions = customer.transactions
                .filter(t => t.type === 'ì…ê¸ˆ')
                .sort((a, b) => a.parsedDate - b.parsedDate);
            
            if (sortedTransactions[0] && 
                sortedTransactions[0].date === transaction.date && 
                sortedTransactions[0].inAmount === transaction.inAmount &&
                transaction.inAmount >= 100000) { // 10ë§Œì› ì´ìƒì„ ë³´ì¦ê¸ˆìœ¼ë¡œ ê°„ì£¼
                console.log('â†’ ì¼ë°˜ ë³´ì¦ê¸ˆ íŒ¨í„´ ì¸ì‹');
                return true;
            }
            
            console.log('â†’ ë³´ì¦ê¸ˆ ì•„ë‹˜');
            return false;
        }
    
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadStoredData();
        });
    
        function initializeEventListeners() {
            const fileDrop = document.getElementById('fileDrop');
            const fileInput = document.getElementById('fileInput');
            
            // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
            if (fileDrop && fileInput) {
                fileDrop.addEventListener('click', () => fileInput.click());
                fileDrop.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileDrop.classList.add('active');
                });
                fileDrop.addEventListener('dragleave', () => {
                    fileDrop.classList.remove('active');
                });
                fileDrop.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileDrop.classList.remove('active');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFile(files[0]);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFile(e.target.files[0]);
                    }
                });
            }

            // ê²€ìƒ‰ í•„í„° ì´ë²¤íŠ¸ (ì„±ëŠ¥ ìµœì í™” - ë””ë°”ìš´ìŠ¤ ì ìš©)
            const filterElements = ['depositSearch', 'depositFilter', 'depositSort', 'tradeSearch', 'tradeFilter', 'tradeSort', 'boutiqueSearch', 'boutiqueFilter', 'boutiqueSort', 'transactionSearch', 'transactionFilter'];
            
            filterElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
                    element.removeEventListener('input', element._filterHandler);
                    element.removeEventListener('change', element._filterHandler);
                    
                    // ë””ë°”ìš´ìŠ¤ëœ í•¸ë“¤ëŸ¬ ìƒì„±
                    element._filterHandler = debounce(() => filterTable(id), 300);
                    
                    element.addEventListener('input', element._filterHandler);
                    element.addEventListener('change', element._filterHandler);
                }
            });
        }
        
        // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜ (ì„±ëŠ¥ ìµœì í™”)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    
        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showNotification('âŒ Excel íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤!');
                return;
            }
            
            document.getElementById('uploadStatus').innerHTML = `
                <div style="color: #059669; margin-top: 10px;">
                    âœ… ${file.name} ì„ íƒë¨ (${(file.size / 1024 / 1024).toFixed(2)}MB)
                </div>
            `;
            document.getElementById('analyzeBtn').disabled = false;
            window.uploadedFile = file;
            showNotification('ğŸ“‚ íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!');
        }
    
        async function analyzeData() {
            if (!window.uploadedFile) {
                showNotification('âŒ ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”!');
                return;
            }
    
            try {
                showProgress(10, 'íŒŒì¼ ì½ëŠ” ì¤‘...');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        showProgress(30, 'ë°ì´í„° íŒŒì‹± ì¤‘...');
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        showProgress(50, 'ê±°ë˜ ë‚´ì—­ ë¶„ì„ ì¤‘...');
                        
                        const newTransactions = parseTransactionData(jsonData);
                        
                        showProgress(70, 'ì¤‘ë³µ ì œê±° ë° ë°ì´í„° í†µí•© ì¤‘...');
                        
                        const beforeCount = allTransactions.length;
                        integrateTransactions(newTransactions);
                        const addedCount = allTransactions.length - beforeCount;
                        
                        showProgress(85, 'ê³ ê°ë³„ ë°ì´í„° ë¶„ì„ ì¤‘...');
                        
                        analyzeCustomerData();
                        
                        showProgress(100, 'ë¶„ì„ ì™„ë£Œ!');
                        
                        uploadHistory.push({
                            fileName: window.uploadedFile.name,
                            uploadTime: new Date(),
                            transactionCount: newTransactions.length,
                            addedCount: addedCount
                        });
                        
                        saveData();
                        updateAllTabs();
                        
                        analysisComplete = true;
                        showNotification(`âœ… ë¶„ì„ ì™„ë£Œ! ${addedCount}ê±´ì˜ ìƒˆë¡œìš´ ê±°ë˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        hideProgress();
                        
                        // ë¶„ì„ ì™„ë£Œ í›„ CEO ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                        showTab('ceoDashboard');
                        
                    } catch (error) {
                        console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
                        showNotification('âŒ íŒŒì¼ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        hideProgress();
                    }
                };
                
                reader.readAsArrayBuffer(window.uploadedFile);
                
            } catch (error) {
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                showNotification('âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                hideProgress();
            }
        }
    
        function parseTransactionData(jsonData) {
            const transactionData = jsonData.slice(7).filter(row => row && row.length > 5);
            
            const parsedTransactions = transactionData.map((row, index) => {
                const dateStr = row[1];
                const rawCustomer = row[2];
                const customer = normalizeCustomerName(rawCustomer); // ê³ ê°ëª… ì •ê·œí™” ì ìš©
                const outAmount = parseFloat(String(row[3]).replace(/,/g, '')) || 0;
                const inAmount = parseFloat(String(row[4]).replace(/,/g, '')) || 0;
                
                let parsedDate = null;
                if (dateStr && typeof dateStr === 'string') {
                    const dateMatch = dateStr.match(/(\d{4})\.(\d{1,2})\.(\d{1,2})/);
                    if (dateMatch) {
                        parsedDate = new Date(parseInt(dateMatch[1]), parseInt(dateMatch[2]) - 1, parseInt(dateMatch[3]));
                    }
                } else if (typeof dateStr === 'number') {
                     parsedDate = new Date((dateStr - 25569) * 86400 * 1000);
                }
                
                // ë” ì •í™•í•œ ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ ID ìƒì„± (ì‹œê°„ê³¼ ìˆœì„œê¹Œì§€ í¬í•¨)
                const dateForId = parsedDate ? parsedDate.toISOString().split('T')[0] : dateStr;
                const amountForId = inAmount > 0 ? `in_${inAmount}` : `out_${outAmount}`;
                const uniqueId = `${dateForId}_${customer}_${amountForId}`;
                
                return {
                    id: uniqueId,
                    date: parsedDate ? parsedDate.toISOString().split('T')[0] : dateStr,
                    parsedDate: parsedDate,
                    customer: customer,
                    outAmount: outAmount,
                    inAmount: inAmount,
                    type: inAmount > 0 ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ',
                    excluded: excludePatterns.some(exclude => customer && customer.includes(exclude))
                };
            }).filter(t => t.parsedDate && t.customer);
            
            return parsedTransactions;
        }
    
        function integrateTransactions(newTransactions) {
            const existingIds = new Set(allTransactions.map(t => t.id));
            let addedCount = 0;
            let duplicateCount = 0;
            
            newTransactions.forEach(transaction => {
                if (!existingIds.has(transaction.id)) {
                    allTransactions.push(transaction);
                    addedCount++;
                } else {
                    duplicateCount++;
                    console.log('ì¤‘ë³µ ê±°ë˜ ë°œê²¬:', transaction.date, transaction.customer, transaction.inAmount || transaction.outAmount);
                }
            });
            
            console.log(`=== ê±°ë˜ í†µí•© ê²°ê³¼ ===`);
            console.log(`ìƒˆë¡œ ì¶”ê°€: ${addedCount}ê±´`);
            console.log(`ì¤‘ë³µ ì œì™¸: ${duplicateCount}ê±´`);
            console.log(`ì „ì²´ ê±°ë˜: ${allTransactions.length}ê±´`);
            
            allTransactions.sort((a, b) => b.parsedDate - a.parsedDate);
        }
    
        // ê³ ê° ë§¤ì¶œ íƒ€ì… ë¶„ë¥˜ í•¨ìˆ˜
        function classifyCustomerSalesType(customer) {
            console.log(`=== ${customer.name} ë¶„ë¥˜ ë¶„ì„ ===`);
            console.log('ë³´ì¦ê¸ˆ:', customer.depositAmount);
            console.log('í™˜ê¸‰ìƒíƒœ:', customer.depositStatus);
            console.log('ì…ê¸ˆ ê±°ë˜:', customer.transactions.filter(t => t.type === 'ì…ê¸ˆ').length + 'ê±´');
            console.log('ì²«ê±°ë˜ì¼:', customer.firstTransactionDate);
            console.log('ë§ˆì§€ë§‰ê±°ë˜ì¼:', customer.lastTransactionDate);
            
            // 1. (ë³´ì¦ê¸ˆ) í™˜ê¸‰ì´ ìˆëŠ” ê³ ê° â†’ íŠ¸ë ˆì´ë“œ ë§¤ì¶œ
            if (customer.depositAmount > 0 && customer.depositStatus === 'returned') {
                console.log('â†’ íŠ¸ë ˆì´ë“œ (í™˜ê¸‰ì™„ë£Œ)');
                return 'trade';
            }
            
            // 2. ë³´ì¦ê¸ˆì´ ìˆê³  ë¯¸í™˜ê¸‰ì¸ ê²½ìš° â†’ íŠ¸ë ˆì´ë“œ ë§¤ì¶œ (ë³´ì¦ê¸ˆ ë„£ê³  ê±°ë˜ ì¤‘)
            if (customer.depositAmount > 0 && customer.depositStatus === 'unreturned') {
                console.log('â†’ íŠ¸ë ˆì´ë“œ (ë¯¸í™˜ê¸‰ ë³´ì¦ê¸ˆ)');
                return 'trade';
            }
            
            // 3. í™˜ê¸‰ì´ ì—†ì§€ë§Œ ê¾¸ì¤€í•œ ê±°ë˜ â†’ íŠ¸ë ˆì´ë“œ ë§¤ì¶œ
            const incomeTransactions = customer.transactions.filter(t => t.type === 'ì…ê¸ˆ');
            const hasMultipleTransactions = incomeTransactions.length >= 3;
            const recentDate = new Date();
            recentDate.setMonth(recentDate.getMonth() - 6);
            const hasRecentTransaction = customer.lastTransactionDate && customer.lastTransactionDate > recentDate;
            
            if (hasMultipleTransactions || hasRecentTransaction) {
                console.log('â†’ íŠ¸ë ˆì´ë“œ (ê¾¸ì¤€í•œ ê±°ë˜)');
                return 'trade';
            }
            
            // 4. ì…ê¸ˆ í›„ ì˜¤ë«ë™ì•ˆ í™˜ê¸‰ ì—†ìŒ â†’ ë¶€í‹°í¬ ë§¤ì¶œ
            // 1-2ê±´ ê±°ë˜í•˜ê³  ì˜¤ë«ë™ì•ˆ í™˜ê¸‰ ì—†ëŠ” ê²½ìš°
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            
            if (incomeTransactions.length <= 2 && customer.firstTransactionDate < oneYearAgo) {
                console.log('â†’ ë¶€í‹°í¬ (ì˜¤ë˜ëœ ë‹¨ë°œ ê±°ë˜)');
                return 'boutique';
            }
            
            // 5. 25ë…„ ì´ì „ ê±°ë˜ ìœ„ì£¼ â†’ ë¶€í‹°í¬ ë§¤ì¶œ
            if (customer.firstTransactionDate && customer.firstTransactionDate.getFullYear() < 2025) {
                console.log('â†’ ë¶€í‹°í¬ (25ë…„ ì´ì „)');
                return 'boutique';
            }
            
            // ê¸°ë³¸ê°’: ë¶€í‹°í¬ ë§¤ì¶œ
            console.log('â†’ ë¶€í‹°í¬ (ê¸°ë³¸ê°’)');
            return 'boutique';
        }

        function analyzeCustomerData() {
            allCustomers = {};
            
            allTransactions.forEach(transaction => {
                const customer = transaction.customer;
                
                if (!allCustomers[customer]) {
                    allCustomers[customer] = {
                        name: customer,
                        transactions: [],
                        totalIncome: 0,
                        totalOutcome: 0,
                        salesAmount: 0,
                        depositAmount: 0,
                        depositStatus: 'none',
                        depositDate: null,
                        returnDate: null,
                        firstTransactionDate: null,
                        lastTransactionDate: null,
                        excluded: excludePatterns.some(exclude => customer.includes(exclude))
                    };
                }
                
                const customerData = allCustomers[customer];
                customerData.transactions.push(transaction);
                
                if (transaction.type === 'ì…ê¸ˆ') {
                    customerData.totalIncome += transaction.inAmount;
                } else {
                    customerData.totalOutcome += transaction.outAmount;
                }
                
                if (!customerData.firstTransactionDate || transaction.parsedDate < customerData.firstTransactionDate) {
                    customerData.firstTransactionDate = transaction.parsedDate;
                }
                if (!customerData.lastTransactionDate || transaction.parsedDate > customerData.lastTransactionDate) {
                    customerData.lastTransactionDate = transaction.parsedDate;
                }
            });
            
            Object.values(allCustomers).forEach(customer => {
                if (customer.excluded) {
                    return;
                }
                
                const incomeTransactions = customer.transactions
                    .filter(t => t.type === 'ì…ê¸ˆ')
                    .sort((a, b) => a.parsedDate - b.parsedDate);
                
                if (incomeTransactions.length === 0) return;
                
                // íŠ¹ë³„ ì¼€ì´ìŠ¤ ë¨¼ì € ì²˜ë¦¬
                if (specialCases[customer.name]) {
                    const specialCase = specialCases[customer.name];
                    
                    // ==========================================================
                    // â˜…â˜…â˜… ì •ì‚° ì™„ë£Œ(settlement_complete) íŠ¹ë³„ ì²˜ë¦¬ ë¡œì§ â˜…â˜…â˜…
                    // ==========================================================
                    if (specialCase.type === 'settlement_complete') {
                        customer.depositAmount = 0; // ìµœì¢… ë³´ì¦ê¸ˆ 0ì›
                        customer.originalDepositAmount = specialCase.deposit; // ì›ë˜ ë³´ì¦ê¸ˆ ê¸°ë¡
                        customer.depositStatus = 'returned'; // í™˜ê¸‰ ì™„ë£Œ ì²˜ë¦¬
                        customer.returnDate = '2025-08-31'; // ìµœì¢… ì •ì‚°ì¼ (ì¶œê¸ˆì¼ ê¸°ì¤€)
                        customer.salesAmount = specialCase.sales; // í™•ì • ë§¤ì¶œ
                        customer.balance = 0; // ìµœì¢… ì”ì•¡ 0ì›
                        customer.salesType = 'trade';
                        customer.note = specialCase.note;
                        return; // ë‹¤ë¥¸ ë¡œì§ì„ íƒ€ì§€ ì•Šê³  ì—¬ê¸°ì„œ ë¶„ì„ ì¢…ë£Œ
                    }
                    
                    // ê¹€ê·œ íŠ¹ë³„ ì²˜ë¦¬: 200ë§Œì› ë³´ì¦ê¸ˆ (50ë§Œ+150ë§Œ), ë‚™ì°°ê¸ˆì€ ë§¤ì¶œ
                    if (customer.name === 'ê¹€ê·œ' && specialCase.type === 'deposit_2000000') {
                        customer.depositAmount = 2000000; // 50ë§Œ + 150ë§Œ
                        customer.depositDate = '2025-07-14'; // ì²« ë³´ì¦ê¸ˆ ë‚ ì§œ
                        customer.depositStatus = 'unreturned';
                        
                        // ë‚™ì°°ê¸ˆ(7/21)ì€ ë§¤ì¶œë¡œ ì²˜ë¦¬, ë³´ì¦ê¸ˆ ê±°ë˜ë§Œ ì œì™¸
                        let totalSales = 0;
                        customer.transactions.forEach(t => {
                            if (t.type === 'ì…ê¸ˆ') {
                                // ë³´ì¦ê¸ˆ ê±°ë˜ ì œì™¸ (7/14: 50ë§Œì›, 7/17: 150ë§Œì›)
                                if (t.date === '2025-07-14' && t.inAmount === 500000) return;
                                if (t.date === '2025-07-17' && t.inAmount === 1500000) return;
                                
                                // ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ë§¤ì¶œ (ë‚™ì°°ê¸ˆ í¬í•¨)
                                totalSales += t.inAmount;
                            }
                        });
                        customer.salesAmount = totalSales;
                        customer.salesType = 'trade';
                        return;
                    }
                    
                    // ê¹€ë¯¸ì • íŠ¹ë³„ ì²˜ë¦¬: 250ë§Œì› ë³´ì¦ê¸ˆ (100ë§Œ+150ë§Œ)
                    if (customer.name === 'ê¹€ë¯¸ì •' && specialCase.type === 'deposit_2500000') {
                        customer.depositAmount = 2500000; // 100ë§Œ + 150ë§Œ
                        customer.depositDate = '2025-08-14'; // ì²« ë³´ì¦ê¸ˆ ë‚ ì§œ
                        customer.depositStatus = 'unreturned';
                        
                        let totalSales = 0;
                        customer.transactions.forEach(t => {
                            if (t.type === 'ì…ê¸ˆ') {
                                // ë³´ì¦ê¸ˆ ê±°ë˜ ì œì™¸ (8/14: 100ë§Œì›, 8/15: 150ë§Œì›)
                                if (t.date === '2025-08-14' && t.inAmount === 1000000) return;
                                if (t.date === '2025-08-15' && t.inAmount === 1500000) return;
                                
                                // ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ë§¤ì¶œ
                                totalSales += t.inAmount;
                            }
                        });
                        customer.salesAmount = totalSales;
                        customer.salesType = 'trade';
                        return;
                    }

                    // ê¹€ì„ ì˜: ë³´ì¦ê¸ˆ 200ë§Œì› (100ë§ŒÃ—2íšŒ) í™˜ê¸‰ì™„ë£Œ
                    if (specialCase.type === 'deposit_2000000') {
                        customer.depositAmount = specialCase.depositAmount;
                        customer.depositDate = incomeTransactions[0].date;
                        customer.depositStatus = 'returned';
                        customer.returnDate = specialCase.returnDate;
                        customer.salesAmount = customer.totalIncome - customer.depositAmount;
                        customer.salesType = 'trade';
                        return;
                    }
                    
                    // ê°•ë¯¼êµ­: ê°•íš¨ìˆœ ëª…ì˜ ë³´ì¦ê¸ˆ í™˜ê¸‰ì™„ë£Œ
                    if (specialCase.type === 'linked_to_kanghyosoon') {
                        customer.depositAmount = specialCase.depositAmount;
                        customer.depositDate = incomeTransactions[0].date;
                        customer.depositStatus = 'returned';
                        customer.returnDate = specialCase.returnDate;
                        customer.salesAmount = customer.totalIncome - customer.depositAmount;
                        customer.salesType = 'trade';
                        return;
                    }
                    
                    // ì‹ ìˆ˜ì—°: ë¶€ë¶„í™˜ê¸‰ ì¼€ì´ìŠ¤ (1500ë§Œì› ë³´ì¦ê¸ˆ â†’ 1000ë§Œì› í™˜ê¸‰ â†’ ì”ì•¡ 500ë§Œì›)
                    if (specialCase.type === 'partial_refund') {
                        customer.depositAmount = specialCase.remainingDeposit; // ì”ì•¡ 500ë§Œì›
                        customer.depositDate = incomeTransactions[0].date; // ì²« ë³´ì¦ê¸ˆ ë‚ ì§œ
                        customer.depositStatus = 'unreturned'; // ì•„ì§ 500ë§Œì› ì”ì•¡ ìˆìŒ
                        customer.returnDate = null; // ë¶€ë¶„í™˜ê¸‰ì´ë¯€ë¡œ ì™„ì „í™˜ê¸‰ì¼ ì—†ìŒ
                        customer.salesAmount = customer.totalIncome - specialCase.totalDeposit; // ì „ì²´ ë§¤ì¶œì—ì„œ ì´ ë³´ì¦ê¸ˆ ì œì™¸
                        customer.salesType = 'trade';
                        customer.partialRefundInfo = {
                            totalDeposit: specialCase.totalDeposit,
                            partialRefund: specialCase.partialRefund,
                            refundDate: specialCase.refundDate,
                            remainingDeposit: specialCase.remainingDeposit
                        };
                        return;
                    }
                    
                    // ì´ìœ ì§„: ë³µì¡í•œ ë³´ì¦ê¸ˆ ì¼€ì´ìŠ¤ (ë³´ì¦ê¸ˆ 50ë§Œì›, ì›”ì´ìš©ë£Œ ì°¨ê° 104,000ì›, í™˜ë¶ˆ 1,009,475ì›)
                    if (specialCase.type === 'complex_deposit_case') {
                        customer.depositAmount = specialCase.depositAmount; // 50ë§Œì› ë³´ì¦ê¸ˆ
                        customer.depositDate = incomeTransactions[0].date; // ì²« ë³´ì¦ê¸ˆ ë‚ ì§œ
                        customer.depositStatus = 'unreturned'; // ì›”ì´ìš©ë£Œ ì°¨ê° í›„ ì”ì•¡ ìˆìŒ
                        customer.returnDate = null;
                        
                        // ì‹¤ì œ ë§¤ì¶œ = ì´ ë§¤ì¶œ - í™˜ë¶ˆ ê¸ˆì•¡
                        customer.salesAmount = Math.max(0, customer.totalIncome - specialCase.actualRefund);
                        customer.salesType = 'trade';
                        
                        // ë³µì¡í•œ ì¼€ì´ìŠ¤ ì •ë³´ ì €ì¥
                        customer.complexCaseInfo = {
                            originalDeposit: specialCase.depositAmount,
                            monthlyFeeDeduction: specialCase.monthlyFeeDeduction,
                            actualRefund: specialCase.actualRefund,
                            remainingDeposit: Math.max(0, specialCase.depositAmount - specialCase.monthlyFeeDeduction),
                            actualSales: customer.salesAmount
                        };
                        return;
                    }
                    
                    // ì´ìœ ì§„: ë³´ì¦ê¸ˆ 50ë§Œì› ë¯¸í™˜ê¸‰
                    if (specialCase.type === 'deposit_500000_unreturned') {
                        customer.depositAmount = specialCase.depositAmount;
                        customer.depositDate = null; // ì´ì „ ê¸°ê°„ ë³´ì¦ê¸ˆ
                        customer.depositStatus = 'unreturned';
                        customer.salesAmount = customer.totalIncome; // í˜„ì¬ ê¸°ê°„ ê±°ë˜ëŠ” ëª¨ë‘ ë§¤ì¶œ
                        customer.salesType = 'trade';
                        return;
                    }
                    
                    // ê¹€ê·œ, ì „í™˜ìŠ¹, ì •ìµë§Œ: ì§€ì •ëœ ë³´ì¦ê¸ˆ + ë‚˜ë¨¸ì§€ ë§¤ì¶œ
                    if (specialCase.type === 'deposit_500000' || specialCase.type === 'deposit_100000' || specialCase.type === 'deposit_300000') {
                        customer.depositAmount = specialCase.depositAmount;
                        customer.depositDate = incomeTransactions[0].date;
                        customer.depositStatus = 'unreturned';
                        customer.salesAmount = Math.max(0, customer.totalIncome - customer.depositAmount);
                        customer.salesType = 'trade';
                        
                        // ì •ìµë§Œì˜ ê²½ìš° ë§¤ì¶œì´ ì¶©ë¶„íˆ ìˆë‹¤ê³  ê°€ì • (hasSales í”Œë˜ê·¸)
                        if (specialCase.hasSales && customer.salesAmount === 0) {
                            customer.salesAmount = Math.max(100000, customer.totalIncome * 0.1); // ìµœì†Œ ë§¤ì¶œ ë³´ì¥
                        }
                        
                        return;
                    }
                    
                    // ê¹€ì§„í˜¸: ë³´ì¦ê¸ˆ í™˜ê¸‰ì™„ë£Œ - ì‹¤ì œ ë§¤ì¶œì€ 94,071ì›
                    if (specialCase.type === 'deposit_refund_complete') {
                        customer.depositAmount = 0; // í™˜ê¸‰ì™„ë£Œì´ë¯€ë¡œ ë³´ì¦ê¸ˆ 0
                        customer.depositDate = incomeTransactions[0].date;
                        customer.depositStatus = 'returned';
                        customer.returnDate = specialCase.returnDate;
                        customer.salesAmount = specialCase.salesAmount; // ì‹¤ì œ ë§¤ì¶œ ì§ì ‘ ì§€ì •
                        customer.salesType = 'trade';
                        customer.originalDepositAmount = specialCase.depositAmount; // ì›ë˜ ë³´ì¦ê¸ˆ ê¸°ë¡ìš©
                        return;
                    }
                    
                    // ìµœì¬ì—°: ë³´ì¦ê¸ˆ 50ë§Œì› í™˜ê¸‰ì™„ë£Œ
                    if (specialCase.type === 'deposit_500000_returned') {
                        customer.depositAmount = specialCase.depositAmount;
                        customer.depositDate = incomeTransactions[0].date;
                        customer.depositStatus = 'returned';
                        customer.returnDate = specialCase.returnDate;
                        customer.salesAmount = customer.totalIncome - customer.depositAmount;
                        customer.salesType = 'trade';
                        return;
                    }
                    
                    if (specialCase.type === 'deposit_500') {
                        // ì¡°íƒœë ¨: ì²˜ìŒ 3ë²ˆ ì…ê¸ˆ (ì´ 500ë§Œì›)ì´ ë³´ì¦ê¸ˆ, ë‚˜ë¨¸ì§€ëŠ” ë§¤ì¶œ
                        let depositSum = 0;
                        let depositTransactions = 0;
                        
                        for (let i = 0; i < incomeTransactions.length && depositSum < 5000000; i++) {
                            depositSum += incomeTransactions[i].inAmount;
                            depositTransactions++;
                            if (depositSum >= 5000000) break;
                        }
                        
                        customer.depositAmount = Math.min(depositSum, 5000000); // ìµœëŒ€ 500ë§Œì›
                        customer.depositDate = incomeTransactions[0].date;
                        customer.depositStatus = 'unreturned';
                        customer.salesAmount = customer.totalIncome - customer.depositAmount;
                        customer.salesType = 'trade';
                        return;
                    } else if (specialCase.type === 'boutique_forced') {
                        // ë²ˆì¥ í›„ë£¨ì¶”, ì¥ìœ ì€, ê¹€ì˜ì£¼ ë“±: ê°•ì œ ë¶€í‹°í¬ ë§¤ì¶œ
                        customer.depositAmount = 0; // ë³´ì¦ê¸ˆ ì—†ìŒ
                        customer.salesAmount = customer.totalIncome; // ì „ë¶€ ë§¤ì¶œ
                        customer.salesType = 'boutique'; // ê°•ì œ ë¶€í‹°í¬
                        return;
                    } else if (specialCase.type === 'pre_deposit') {
                        // ë””ì—”ë””: ì „ë¶€ ë§¤ì¶œ (ì˜ˆì¹˜ê¸ˆ í˜•íƒœ, ë³´ì¦ê¸ˆ ì ˆëŒ€ ì—†ìŒ)
                        customer.depositAmount = 0; // ë³´ì¦ê¸ˆ ì ˆëŒ€ ì—†ìŒ
                        customer.depositStatus = 'none'; // ë³´ì¦ê¸ˆ ìƒíƒœ ì—†ìŒ
                        customer.depositDate = null; // ë³´ì¦ê¸ˆ ë‚ ì§œ ì—†ìŒ
                        customer.returnDate = null; // í™˜ê¸‰ ë‚ ì§œ ì—†ìŒ
                        customer.salesAmount = customer.totalIncome; // ì „ë¶€ ë§¤ì¶œ
                        customer.salesType = 'trade'; // íŠ¸ë ˆì´ë“œ ë§¤ì¶œ
                        return;
                    } else if (specialCase.type === 'full_refund') {
                        // í…Œì´ë°ë©: ì „ì•¡ í™˜ë¶ˆ
                        customer.depositAmount = customer.totalIncome; // ì…ê¸ˆì•¡ ì „ì²´ê°€ ë³´ì¦ê¸ˆ
                        customer.depositDate = incomeTransactions[0].date;
                        customer.depositStatus = 'returned'; // í™˜ê¸‰ì™„ë£Œë¡œ ì²˜ë¦¬
                        customer.returnDate = '2024-05-01';
                        customer.salesAmount = 0; // ë§¤ì¶œ 0
                        customer.salesType = 'trade';
                        return;
                    } else if (specialCase.type === 'deposit_1000000') {
                        // ê°•íš¨ìˆœ: ê°•ë¯¼êµ­ ë³´ì¦ê¸ˆ(ì—„ë§ˆëª…ì˜)
                        customer.depositAmount = 1000000;
                        customer.depositDate = incomeTransactions[0].date;
                        customer.depositStatus = 'unreturned';
                        customer.salesAmount = customer.totalIncome - customer.depositAmount;
                        customer.salesType = 'trade'; // ë³´ì¦ê¸ˆì´ ìˆìœ¼ë¯€ë¡œ íŠ¸ë ˆì´ë“œ
                        return;
                    } else if (specialCase.type === 'deposit_management') {
                        customer.salesAmount = customer.totalIncome - customer.totalOutcome;
                        customer.salesType = 'trade'; // ì˜ˆì¹˜ê¸ˆ ê´€ë¦¬ì´ë¯€ë¡œ íŠ¸ë ˆì´ë“œ
                        return;
                    }
                }
                
                const firstTransaction = incomeTransactions[0];
                
                // ë³´ì¦ê¸ˆ íŒë³„ ë¡œì§ (100ë§Œì› ì´ìƒ ì²« ì…ê¸ˆ)
                if (firstTransaction.inAmount >= 1000000) {
                    customer.depositAmount = firstTransaction.inAmount;
                    customer.depositDate = firstTransaction.date;
                    customer.depositStatus = 'unreturned';
                    
                    customer.salesAmount = customer.totalIncome - customer.depositAmount;
                    
                    const outcomeTransactions = customer.transactions.filter(t => t.type === 'ì¶œê¸ˆ');
                    const refundTransaction = outcomeTransactions.find(t => 
                        Math.abs(t.outAmount - customer.depositAmount) < 50000
                    );
                    
                    if (refundTransaction) {
                        customer.depositStatus = 'returned';
                        customer.returnDate = refundTransaction.date;
                    }
                } else {
                    customer.salesAmount = customer.totalIncome;
                }
                
                // ë§¤ì¶œ íƒ€ì… ë¶„ë¥˜ (íŠ¸ë ˆì´ë“œ vs ë¶€í‹°í¬)
                customer.salesType = classifyCustomerSalesType(customer);
                
                // 5ì›” ê¸°ì¤€ í™˜ê¸‰ì™„ë£Œ ì •ë³´ ì ìš©
                const refundInfo = knownRefunds[customer.name];
                if (refundInfo && customer.name !== 'í…Œì´ë°ë©') { // í…Œì´ë°ë©ì€ specialCaseì—ì„œ ì²˜ë¦¬
                    if (customer.depositAmount === 0 && refundInfo.amount > 0) {
                        // ë³´ì¦ê¸ˆì´ ìë™ ê°ì§€ë˜ì§€ ì•Šì€ ê²½ìš° ìˆ˜ë™ ì„¤ì •
                        customer.depositAmount = refundInfo.amount;
                        customer.depositDate = customer.firstTransactionDate ? customer.firstTransactionDate.toISOString().split('T')[0] : refundInfo.date;
                    }
                    customer.depositStatus = 'returned';
                    customer.returnDate = refundInfo.date;
                    customer.salesAmount = Math.max(0, customer.totalIncome - customer.depositAmount);
                    customer.salesType = 'trade';
                }
            });
            
            // â˜…â˜…â˜… ì¤‘ìš”: ìë™ë¶„ì„ ì™„ë£Œ í›„ ì§ì›ë¶„ë¥˜ ì ìš© â˜…â˜…â˜…
            console.log('=== ì§ì›ë¶„ë¥˜ ì ìš© ì‹œì‘ ===');
            Object.values(allCustomers).forEach(customer => {
                if (customer.excluded) return;
                
                // ì´ ê³ ê°ì˜ ê±°ë˜ ì¤‘ ì§ì›ë¶„ë¥˜ê°€ ìˆëŠ”ì§€ í™•ì¸
                const hasManualClassification = customer.transactions.some(t => {
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    return staffClassifications[tId];
                });
                
                if (hasManualClassification) {
                    console.log(`${customer.name}ì— ì§ì›ë¶„ë¥˜ ë°œê²¬ - ì¬ê³„ì‚° ì§„í–‰`);
                    recalculateCustomerData(customer);
                }
            });
            console.log('=== ì§ì›ë¶„ë¥˜ ì ìš© ì™„ë£Œ ===');
            
            // =================================================================
            // â˜…â˜…â˜…â˜…â˜… ê¹€ì§„í˜¸ ë°ì´í„° ê°•ì œ ìˆ˜ì • ì½”ë“œ (v2) ì‹œì‘ â˜…â˜…â˜…â˜…â˜…
            // =================================================================
            if (allCustomers['ê¹€ì§„í˜¸']) {
                const customer = allCustomers['ê¹€ì§„í˜¸'];
                console.log('=== ê¹€ì§„í˜¸ ê°•ì œ ìˆ˜ì • ì‹œì‘ ===');

                // 1. ëŒ€í‘œë‹˜ì´ í™•ì¸í•œ ìµœì¢… ê°’ìœ¼ë¡œ ê°•ì œ ì„¤ì •
                const realSales = 576168; // ì´ê²ƒì´ ì§„ì§œ ë§¤ì¶œì•¡
                const unpaidDebt = 94071;   // í™˜ê¸‰ ì‹œ ì°¨ê°í•œ ë¯¸ê²°ì œê¸ˆ

                // 2. ì´ ê³ ê°ì˜ ì´ ì…ê¸ˆì•¡ì„ 'ë§¤ì¶œ + ë¯¸ê²°ì œê¸ˆ'ì˜ í•©ìœ¼ë¡œ ì¬ì •ì˜
                const totalValue = realSales + unpaidDebt; // 670,239

                // 3. ê³ ê° ê°ì²´ì˜ ëª¨ë“  ê°’ì„ ì´ ê¸°ì¤€ì— ë§ì¶° ê°•ì œë¡œ ë®ì–´ì“°ê¸°
                customer.salesAmount = realSales;             // ìµœì¢… ë§¤ì¶œì•¡ í‘œì‹œ
                customer.depositStatus = 'returned';          // ìƒíƒœ: í™˜ê¸‰ ì™„ë£Œ
                customer.returnDate = '2025-07-06';           // í™˜ê¸‰ ì²˜ë¦¬ì¼
                customer.depositAmount = 0;                   // í˜„ì¬ ë‚¨ì€ ë³´ì¦ê¸ˆ: 0ì›
                customer.originalDepositAmount = totalValue;  // ìµœì´ˆ ë³´ì¦ê¸ˆ ì´ì•¡
                customer.totalIncome = totalValue;            // ì´ ì…ê¸ˆì•¡ ê°•ì œ ì„¤ì •
                customer.totalOutcome = totalValue;           // ì´ ì¶œê¸ˆì•¡(ë§¤ì¶œ+ìƒê³„) ê°•ì œ ì„¤ì •
                customer.balance = 0;                         // ìµœì¢… ì”ì•¡: 0ì›
                customer.salesType = 'trade';
                customer.note = 'ë§¤ì¶œ 576,168ì› í™•ì •. ë¯¸ê²°ì œ 94,071ì› ìƒê³„ í›„ í™˜ê¸‰ ì™„ë£Œ ì²˜ë¦¬.';
                
                console.log('ê¹€ì§„í˜¸ ê°•ì œ ìˆ˜ì • ì™„ë£Œ:', customer);
            }
            // =================================================================
            // â˜…â˜…â˜…â˜…â˜… ê¹€ì§„í˜¸ ë°ì´í„° ê°•ì œ ìˆ˜ì • ì½”ë“œ ì¢…ë£Œ â˜…â˜…â˜…â˜…â˜…
            // =================================================================
        }
    
            function safeUpdate(fn, name) {
            try { fn(); }
            catch (e) { console.error(`íƒ­ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${name}`, e); }
        }

        function updateAllTabs() {
            // =================================================================
        // =================================================================
        // â˜…â˜…â˜…â˜…â˜… ê¹€ì§„í˜¸ ë°ì´í„° ìµœì¢… ê°•ì œ ìˆ˜ì • ì½”ë“œ v4 (ì™„ê²°íŒ) â˜…â˜…â˜…â˜…â˜…
        // =================================================================
        if (allCustomers['ê¹€ì§„í˜¸']) {
            console.log('ê¹€ì§„í˜¸ ë°ì´í„° v4 ìµœì¢… ë®ì–´ì“°ê¸° ë¡œì§ ì‹¤í–‰!');
            const customer = allCustomers['ê¹€ì§„í˜¸'];

            const realSales = 576168;
            const fee = 94071;
            const originalDeposit = 5000000;
            const refundSent = 4905929;

            // 1. 'ë©ì²­í•œ ê³„ì‚°ê¸°'ë¥¼ ì†ì´ê¸° ìœ„í•´ ì´ ì…ì¶œê¸ˆì•¡ ìì²´ë¥¼ ì¬ì •ì˜
            customer.totalIncome = originalDeposit + realSales; // 5,576,168
            customer.totalOutcome = refundSent + realSales + fee; // 5,576,168 (í™˜ê¸‰ì•¡+ë§¤ì¶œ+ìˆ˜ìˆ˜ë£Œ)
            customer.balance = 0; // ìµœì¢… ì”ì•¡ 0ìœ¼ë¡œ ê°•ì œ

            // 2. 'ë˜‘ë˜‘í•œ ê³„ì‚°ê¸°'ë¥¼ ìœ„í•œ ìƒì„¸ ì •ë³´ ì¬ì •ì˜
            customer.salesAmount = realSales;
            customer.depositAmount = 0; // í˜„ì¬ ë‚¨ì€ ë³´ì¦ê¸ˆ 0
            customer.originalDepositAmount = originalDeposit; // ì›ë˜ ë³´ì¦ê¸ˆ 500ë§Œ
            customer.depositStatus = 'returned';
            customer.returnDate = '2025-08-31';
            customer.note = 'ë³´ì¦ê¸ˆ 500ë§Œì› ì •ì‚° ì™„ë£Œ (ìµœì¢… ìˆ˜ì •)';
        }
        // =================================================================
        // â˜…â˜…â˜…â˜…â˜… ê¹€ì§„í˜¸ ë°ì´í„° ìµœì¢… ê°•ì œ ìˆ˜ì • ì½”ë“œ ì¢…ë£Œ â˜…â˜…â˜…â˜…â˜…
        // =================================================================
            safeUpdate(updateHeaderStats, 'header');
            safeUpdate(updateCEODashboard, 'ceoDashboard');
            safeUpdate(updateDepositsTab, 'deposits');
            safeUpdate(updateTradeSalesTab, 'tradeSales');
            safeUpdate(updateBoutiqueSalesTab, 'boutiqueSales');
            safeUpdate(updateMonthlyTab, 'monthly');
            safeUpdate(updateTransactionsTab, 'transactions');
        }
    
        function updateHeaderStats() {
            const incomeTransactions = allTransactions.filter(t => t.type === 'ì…ê¸ˆ' && !t.excluded);
            const totalIncome = incomeTransactions.reduce((sum, t) => sum + t.inAmount, 0);
            const totalCustomers = Object.keys(allCustomers).filter(name => !allCustomers[name].excluded).length;
            
            const totalSales = Object.values(allCustomers)
                .filter(c => !c.excluded)
                .reduce((sum, c) => sum + c.salesAmount, 0);
            
            document.getElementById('totalTransactions').textContent = allTransactions.length.toLocaleString() + 'ê±´';
            document.getElementById('totalIncome').textContent = 'â‚©' + totalIncome.toLocaleString();
            document.getElementById('totalCustomers').textContent = totalCustomers + 'ëª…';
            document.getElementById('finalSalesAmount').textContent = 'â‚©' + totalSales.toLocaleString();
        }
    
        function updateCEODashboard() {
            // ì§ì›ì´ ì œì™¸ë¡œ ë¶„ë¥˜í•œ ê³ ê°ë“¤ì„ í•„í„°ë§
            const staffExcludedCustomers = Object.keys(staffClassifications)
                .filter(transactionId => staffClassifications[transactionId] === 'exclude')
                .map(transactionId => {
                    const parts = transactionId.split('_');
                    return parts.length >= 2 ? parts[1] : null;
                })
                .filter(name => name);
            
            const nonExcludedCustomers = Object.values(allCustomers).filter(c => {
                // ê¸°ë³¸ ì œì™¸ ê³ ê°
                if (c.excluded) return false;
                
                // ì§ì›ì´ ì œì™¸ë¡œ ë¶„ë¥˜í•œ ê³ ê°ë„ ì œì™¸
                if (staffExcludedCustomers.includes(c.name)) return false;
                
                return true;
            });
            
            const totalDeposits = nonExcludedCustomers.reduce((sum, c) => sum + c.depositAmount, 0);
            const totalSales = nonExcludedCustomers.reduce((sum, c) => sum + c.salesAmount, 0);
            
            // ì§„ì •í•œ ì´íƒˆ ìœ„í—˜ ê³ ê° (ë³´ì¦ê¸ˆ ìˆìœ¼ë‚˜ ë§¤ì¶œ ì—†ëŠ” ê³ ê°, BUT í™˜ê¸‰ì™„ë£ŒëŠ” ì œì™¸!)
            const riskCustomers = nonExcludedCustomers.filter(c => {
                // ë³´ì¦ê¸ˆì´ ìˆì–´ì•¼ í•¨
                if (c.depositAmount <= 0) return false;
                
                // í™˜ê¸‰ì™„ë£Œëœ ê³ ê°ì€ ìœ„í—˜í•˜ì§€ ì•ŠìŒ (ì •ìƒì ì¸ ê±°ë˜ ì™„ë£Œ)
                if (c.depositStatus === 'returned') return false;
                
                // ê°•íš¨ìˆœì€ ê°•ë¯¼êµ­ê³¼ ê°™ì€ ì‚¬ëŒì´ë¯€ë¡œ ì œì™¸ (ì¤‘ë³µ ë°©ì§€)
                if (specialCases[c.name] && specialCases[c.name].excludeFromDepositManagement) return false;
                
                // ì •ìµë§Œì€ ì‹¤ì œë¡œ ë§¤ì¶œì´ ìˆìœ¼ë¯€ë¡œ ìœ„í—˜ê³ ê°ì—ì„œ ì œì™¸
                if (specialCases[c.name] && specialCases[c.name].hasSales) return false;
                
                // í•µì‹¬ ë¡œì§: ë³´ì¦ê¸ˆì€ ìˆì§€ë§Œ ë§¤ì¶œì´ ì „í˜€ ì—†ëŠ” ê²½ìš°ë§Œ ìœ„í—˜
                // (ë§¤ì¶œì´ ìˆë‹¤ë©´ ë³´ì¦ê¸ˆì„ ì˜ í™œìš©í•˜ê³  ìˆëŠ” ê²ƒì´ë¯€ë¡œ ê±´ì „í•œ ê³ ê°)
                if (c.salesAmount > 0) return false;
                
                // ì¶”ê°€ ì¡°ê±´: ë³´ì¦ê¸ˆ ì…ê¸ˆ í›„ 90ì¼ ì´ìƒ ê²½ê³¼í–ˆëŠ”ë°ë„ ë§¤ì¶œì´ ì—†ëŠ” ê²½ìš°
                if (c.depositDate) {
                    const daysSinceDeposit = Math.floor((new Date() - new Date(c.depositDate)) / (1000 * 60 * 60 * 24));
                    if (daysSinceDeposit < 90) return false; // 90ì¼ ë¯¸ë§Œì´ë©´ ì•„ì§ ìœ„í—˜í•˜ì§€ ì•ŠìŒ
                }
                
                return true;
            });
            
            // ë³´ì¦ê¸ˆ íš¨ìœ¨ì„± (ë§¤ì¶œ / ë³´ì¦ê¸ˆ ë¹„ìœ¨)
            const efficiency = totalDeposits > 0 ? ((totalSales / totalDeposits) * 100).toFixed(1) : 0;
            
            // íŠ¸ë ˆì´ë“œ vs ë¶€í‹°í¬ ë§¤ì¶œ
            const tradeCustomers = nonExcludedCustomers.filter(c => c.salesType === 'trade');
            const boutiqueCustomers = nonExcludedCustomers.filter(c => c.salesType === 'boutique');
            const tradeSales = tradeCustomers.reduce((sum, c) => sum + c.salesAmount, 0);
            const boutiqueSales = boutiqueCustomers.reduce((sum, c) => sum + c.salesAmount, 0);
            
            document.getElementById('ceoDashboardTotalDeposits').textContent = 'â‚©' + totalDeposits.toLocaleString();
            document.getElementById('ceoDashboardTotalSales').textContent = 'â‚©' + totalSales.toLocaleString();
            document.getElementById('ceoDashboardRiskCustomers').textContent = riskCustomers.length + 'ëª…';
            document.getElementById('ceoDashboardEfficiency').textContent = efficiency + '%';
            
            document.getElementById('ceoDashboardDepositDetail').textContent = `ë¯¸í™˜ê¸‰ ${nonExcludedCustomers.filter(c => c.depositStatus === 'unreturned').length}ëª… + í™˜ê¸‰ì™„ë£Œ ${nonExcludedCustomers.filter(c => c.depositStatus === 'returned').length}ëª…`;
            document.getElementById('ceoDashboardSalesDetail').textContent = `íŠ¸ë ˆì´ë“œ â‚©${tradeSales.toLocaleString()} + ë¶€í‹°í¬ â‚©${boutiqueSales.toLocaleString()}`;
            document.getElementById('ceoDashboardRiskDetail').textContent = riskCustomers.length > 0 ? `ì´ ë³´ì¦ê¸ˆ â‚©${riskCustomers.reduce((sum, c) => sum + c.depositAmount, 0).toLocaleString()}` : 'ìœ„í—˜ ê³ ê° ì—†ìŒ';
            document.getElementById('ceoDashboardEfficiencyDetail').textContent = totalDeposits > 0 ? `ë³´ì¦ê¸ˆ â‚©${totalDeposits.toLocaleString()} ëŒ€ë¹„ ë§¤ì¶œ íš¨ìœ¨ì„±` : 'ë³´ì¦ê¸ˆ ì—†ìŒ';
            
            // ì›”ë³„ ì„±ì¥ ì°¨íŠ¸ (ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ í˜•íƒœ)
            updateMonthlyGrowthChart();
            
            // ê³ ê° ì„±ì¥ íŒ¨í„´ (ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ í˜•íƒœ)
            updateCustomerGrowthChart();
            
            // ì´íƒˆ ìœ„í—˜ ê³ ê° ëª©ë¡
            updateRiskCustomersList(riskCustomers);
            
            // ì—…ë¡œë“œ íˆìŠ¤í† ë¦¬
            updateUploadHistory();
        }
    
        function updateMonthlyGrowthChart() {
            const salesTransactions = allTransactions.filter(t => {
                if (t.type !== 'ì…ê¸ˆ' || t.excluded) return false;
                const customer = allCustomers[t.customer];
                if (!customer || customer.salesAmount <= 0) return false;
                
                // ë³´ì¦ê¸ˆ ê±°ë˜ ì™„ì „ ì œì™¸
                const isDepositTransaction = customer.depositAmount > 0 && t.inAmount === customer.depositAmount && t.date === customer.depositDate;
                if (isDepositTransaction) return false;
                
                // íŠ¹ë³„ ì¼€ì´ìŠ¤ ë³´ì¦ê¸ˆë„ ì œì™¸
                if (specialCases[customer.name]) {
                    const specialCase = specialCases[customer.name];
                    if (specialCase.type === 'deposit_2000000' && t.inAmount >= 1000000) return false;
                    if (specialCase.type === 'linked_to_kanghyosoon' && t.inAmount >= 500000) return false;
                    if (specialCase.type === 'deposit_500000' && t.inAmount === 500000) return false;
                    if (specialCase.type === 'deposit_100000' && t.inAmount === 100000) return false;
                    if (specialCase.type === 'deposit_300000' && t.inAmount === 300000) return false;
                    if (specialCase.type === 'deposit_500000_returned' && t.inAmount === 500000) return false;
                    if (specialCase.type === 'deposit_refund_complete' && t.inAmount === specialCase.depositAmount) return false;
                    if (specialCase.type === 'deposit_500' && t.inAmount >= 1000000) return false;
                    if (specialCase.type === 'deposit_1000000' && t.inAmount >= 1000000) return false;
                    if (specialCase.type === 'deposit_1000000_for_kangminguk' && t.inAmount >= 1000000) return false;
                    if (specialCase.type === 'full_refund') return false;
                }
                
                return true;
            });
            
            const monthlyData = {};
            salesTransactions.forEach(t => {
                const yearMonth = `${t.parsedDate.getFullYear()}-${String(t.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = 0;
                }
                monthlyData[yearMonth] += t.inAmount;
            });
            
            const recentMonths = Object.keys(monthlyData).sort().slice(-3);
            let chartHTML = '';
            
            recentMonths.forEach((month, index) => {
                const amount = monthlyData[month];
                const prevMonth = recentMonths[index - 1];
                const growth = prevMonth ? ((amount - monthlyData[prevMonth]) / monthlyData[prevMonth] * 100).toFixed(1) : 0;
                
                chartHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${month}</span>
                        <span>â‚©${amount.toLocaleString()}</span>
                        <span style="color: ${growth >= 0 ? '#059669' : '#dc2626'}">${growth >= 0 ? 'â–²' : 'â–¼'}${growth}%</span>
                    </div>
                `;
            });
            
            document.getElementById('monthlyGrowthChart').innerHTML = chartHTML || '<p>ë§¤ì¶œ ë°ì´í„° ì—†ìŒ</p>';
        }
        
        function updateCustomerGrowthChart() {
            const monthlyNewCustomers = {};
            
            Object.values(allCustomers).forEach(customer => {
                if (customer.excluded || !customer.firstTransactionDate || customer.salesAmount <= 0) return;
                
                const yearMonth = `${customer.firstTransactionDate.getFullYear()}-${String(customer.firstTransactionDate.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyNewCustomers[yearMonth]) {
                    monthlyNewCustomers[yearMonth] = [];
                }
                monthlyNewCustomers[yearMonth].push(customer.name);
            });
            
            const recentMonths = Object.keys(monthlyNewCustomers).sort().slice(-3);
            let chartHTML = '';
            
            recentMonths.forEach(month => {
                const customers = monthlyNewCustomers[month];
                const count = customers.length;
                const customerList = customers.slice(0, 5).join(', ') + (customers.length > 5 ? ` ì™¸ ${customers.length - 5}ëª…` : '');
                
                chartHTML += `
                    <div style="margin-bottom: 15px; padding: 8px; background: #f8fafc; border-radius: 5px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>${month}</strong></span>
                            <span><strong>${count}ëª… ì‹ ê·œ</strong></span>
                        </div>
                        <div style="font-size: 0.8em; color: #6b7280;">
                            ${customerList}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('customerGrowthChart').innerHTML = chartHTML || '<p>ì‹ ê·œ ê³ ê° ì—†ìŒ</p>';
        }
        
        function updateRiskCustomersList(riskCustomers) {
            let listHTML = '';
            
            if (riskCustomers.length === 0) {
                listHTML = '<p style="color: #059669; text-align: center; padding: 20px;">ğŸ‰ í˜„ì¬ ì´íƒˆ ìœ„í—˜ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤!</p>';
            } else {
                listHTML = `
                    <table style="width: 100%; font-size: 0.9em;">
                        <thead>
                            <tr><th>ê³ ê°ëª…</th><th>ë³´ì¦ê¸ˆ</th><th>ë³´ì¦ê¸ˆ ë‚ ì§œ</th><th>ê²½ê³¼ì¼ìˆ˜</th><th>ì•¡ì…˜</th></tr>
                        </thead>
                        <tbody>
                `;
                
                riskCustomers.forEach(customer => {
                    const daysSinceDeposit = customer.depositDate ? 
                        Math.floor((new Date() - new Date(customer.depositDate)) / (1000 * 60 * 60 * 24)) : 0;
                    
                    listHTML += `
                        <tr>
                            <td><strong>${customer.name}</strong></td>
                            <td class="amount-negative">â‚©${customer.depositAmount.toLocaleString()}</td>
                            <td>${customer.depositDate || '-'}</td>
                            <td>${daysSinceDeposit}ì¼</td>
                            <td><button class="btn" style="padding: 4px 8px; font-size: 0.8em;" onclick="showTab('deposits')">ê´€ë¦¬</button></td>
                        </tr>
                    `;
                });
                
                listHTML += '</tbody></table>';
            }
            
            document.getElementById('riskCustomersList').innerHTML = listHTML;
        }
    
        function updateTradeSalesTab() {
            const tbody = document.querySelector('#tradeTable tbody');
            tbody.innerHTML = '';
            
            // ê±°ë˜ ë‹¨ìœ„ ìµœì‹ ìˆœ í…Œì´ë¸”ë¡œ ë³€ê²½ (ì…ê¸ˆ ì¤‘ ë³´ì¦ê¸ˆ/ì›”ì´ìš©ë£Œ/ì œì™¸ ì œì™¸, ì§ì›ë¶„ë¥˜ 'trade' í¬í•¨)
            const tradeTransactions = allTransactions
                .filter(t => {
                    if (t.type !== 'ì…ê¸ˆ' || t.excluded) return false;
                    const customer = allCustomers[t.customer];
                    if (!customer) return false;
                    // ë³´ì¦ê¸ˆ ê±°ë˜ ì œì™¸
                    if (isTransactionDeposit(customer, t)) return false;
                    // ì§ì›ë¶„ë¥˜ ì‹ë³„
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    const staffClass = staffClassifications[tId];
                    // ì›”ì´ìš©ë£Œ ì œì™¸
                    if (staffClass === 'monthlyFee') return false;
                    // íŠ¸ë ˆì´ë“œ íŒì •: ê³ ê°ì´ íŠ¸ë ˆì´ë“œì´ê±°ë‚˜, ë³´ì¦ê¸ˆ ê³ ê°ì´ê±°ë‚˜, ì§ì›ë¶„ë¥˜ê°€ trade
                    return customer.salesType === 'trade' || customer.depositAmount > 0 || staffClass === 'trade';
                })
                .sort((a, b) => b.parsedDate - a.parsedDate);
            
            const totalTradeSales = tradeTransactions.reduce((sum, t) => sum + (t.inAmount || 0), 0);
            const avgTradeSales = tradeTransactions.length > 0 ? Math.round(totalTradeSales / tradeTransactions.length) : 0;
            const highValueCustomers = Array.from(new Set(tradeTransactions.filter(t => (t.inAmount || 0) >= 5000000).map(t => t.customer)));
            const tradeWithDeposits = Array.from(new Set(tradeTransactions.filter(t => (allCustomers[t.customer]?.depositAmount || 0) > 0).map(t => t.customer)));
            const uniqueTradeCustomers = Array.from(new Set(tradeTransactions.map(t => t.customer)));
            
            // ìš”ì•½ ì •ë³´ í‘œì‹œ
            const summaryGrid = document.getElementById('tradeSummaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">ğŸª ì´ íŠ¸ë ˆì´ë“œ ë§¤ì¶œ</div>
                    <div class="summary-value">â‚©${totalTradeSales.toLocaleString()}</div>
                    <div class="summary-detail">${uniqueTradeCustomers.length}ëª… íŠ¸ë ˆì´ë“œ ê³ ê°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ğŸ’° í‰ê·  ë§¤ì¶œ</div>
                    <div class="summary-value">â‚©${avgTradeSales.toLocaleString()}</div>
                    <div class="summary-detail">ê³ ê°ë‹¹ í‰ê·  íŠ¸ë ˆì´ë“œ ë§¤ì¶œ</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">â­ ê³ ë§¤ì¶œ ê³ ê°</div>
                    <div class="summary-value">${highValueCustomers.length}ëª…</div>
                    <div class="summary-detail">500ë§Œì› ì´ìƒ ë§¤ì¶œ ê³ ê°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ğŸ¦ ë³´ì¦ê¸ˆ ì—°ê³„</div>
                    <div class="summary-value">${tradeWithDeposits.length}ëª…</div>
                    <div class="summary-detail">ë³´ì¦ê¸ˆì´ ìˆëŠ” íŠ¸ë ˆì´ë“œ ê³ ê°</div>
                </div>
            `;
            
            // ê³ ê°ë³„ ëˆ„ì  ë§¤ì¶œ ê³„ì‚°ìš©
            const customerRunningTotal = {};
            tradeTransactions.forEach(t => {
                const customer = allCustomers[t.customer];
                const row = tbody.insertRow();
                row.className = 'customer-row';
                const statusBadge = (customer.depositAmount || 0) > 0 ? (customer.depositStatus === 'returned' ? '<span class="status-badge status-returned">í™˜ê¸‰ì™„ë£Œ</span>' : '<span class="status-badge status-unreturned">ë¯¸í™˜ê¸‰</span>') : '<span class="status-badge status-sales">ë§¤ì¶œë§Œ</span>';
                customerRunningTotal[t.customer] = (customerRunningTotal[t.customer] || 0) + (t.inAmount || 0);
                row.innerHTML = `
                    <td>${t.date}</td>
                    <td><strong>${t.customer}</strong></td>
                    <td class="amount-large">â‚©${(t.inAmount || 0).toLocaleString()}</td>
                    <td>íŠ¸ë ˆì´ë“œ</td>
                    <td class="amount-positive">â‚©${customerRunningTotal[t.customer].toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td><button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); showTradeDetails('${t.customer.replace(/'/g, "\\'")}')">ìƒì„¸ë³´ê¸°</button></td>
                `;
                row.setAttribute('data-customer', t.customer);
            });
        }

        function updateBoutiqueSalesTab() {
            const tbody = document.querySelector('#boutiqueTable tbody');
            tbody.innerHTML = '';
            
            const boutiqueCustomers = Object.values(allCustomers)
                .filter(c => !c.excluded && c.salesAmount > 0 && c.salesType === 'boutique')
                .sort((a, b) => b.salesAmount - a.salesAmount);
            
            const totalBoutiqueSales = boutiqueCustomers.reduce((sum, c) => sum + c.salesAmount, 0);
            const avgBoutiqueSales = boutiqueCustomers.length > 0 ? Math.round(totalBoutiqueSales / boutiqueCustomers.length) : 0;
            const highValueCustomers = boutiqueCustomers.filter(c => c.salesAmount >= 2000000);
            const oneTimeCustomers = boutiqueCustomers.filter(c => c.transactions.filter(t => t.type === 'ì…ê¸ˆ').length === 1);
            
            // ìš”ì•½ ì •ë³´ í‘œì‹œ
            const summaryGrid = document.getElementById('boutiqueSummaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">ğŸ›ï¸ ì´ ë¶€í‹°í¬ ë§¤ì¶œ</div>
                    <div class="summary-value">â‚©${totalBoutiqueSales.toLocaleString()}</div>
                    <div class="summary-detail">${boutiqueCustomers.length}ëª… ë¶€í‹°í¬ ê³ ê°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ğŸ’° í‰ê·  ë§¤ì¶œ</div>
                    <div class="summary-value">â‚©${avgBoutiqueSales.toLocaleString()}</div>
                    <div class="summary-detail">ê³ ê°ë‹¹ í‰ê·  ë¶€í‹°í¬ ë§¤ì¶œ</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">â­ ê³ ë§¤ì¶œ ê³ ê°</div>
                    <div class="summary-value">${highValueCustomers.length}ëª…</div>
                    <div class="summary-detail">200ë§Œì› ì´ìƒ ë§¤ì¶œ ê³ ê°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ğŸ”„ ë‹¨ë°œ ê³ ê°</div>
                    <div class="summary-value">${oneTimeCustomers.length}ëª…</div>
                    <div class="summary-detail">1íšŒì„± êµ¬ë§¤ ê³ ê°</div>
                </div>
            `;
            
            boutiqueCustomers.forEach(customer => {
                const row = tbody.insertRow();
                row.className = 'customer-row';
                
                const period = customer.firstTransactionDate && customer.lastTransactionDate ? 
                    (customer.firstTransactionDate.getTime() === customer.lastTransactionDate.getTime() ? 
                        customer.firstTransactionDate.toLocaleDateString('ko-KR', {year: '2-digit', month: 'numeric', day: 'numeric'}) :
                        `${customer.firstTransactionDate.toLocaleDateString('ko-KR', {year: '2-digit', month: 'numeric', day: 'numeric'})} ~ ${customer.lastTransactionDate.toLocaleDateString('ko-KR', {year: '2-digit', month: 'numeric', day: 'numeric'})}`) : 
                    '-';
                
                const incomeCount = customer.transactions.filter(t => t.type === 'ì…ê¸ˆ').length;
                
                // ì›”í‰ê·  ë§¤ì¶œ ê³„ì‚°
                let monthlyAverage = 0;
                if (customer.firstTransactionDate && customer.lastTransactionDate) {
                    const monthsDiff = Math.max(1, Math.ceil((customer.lastTransactionDate - customer.firstTransactionDate) / (1000 * 60 * 60 * 24 * 30)));
                    monthlyAverage = Math.round(customer.salesAmount / monthsDiff);
                }
                
                row.innerHTML = `
                    <td><strong>${customer.name}</strong></td>
                    <td class="amount-large">â‚©${customer.salesAmount.toLocaleString()}</td>
                    <td>${incomeCount}ê±´</td>
                    <td style="font-size: 0.9em;">${period}</td>
                    <td class="amount-positive">â‚©${monthlyAverage.toLocaleString()}</td>
                    <td>${customer.firstTransactionDate ? customer.firstTransactionDate.toLocaleDateString('ko-KR') : '-'}</td>
                    <td><button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); showBoutiqueDetails('${customer.name.replace(/'/g, "\\'")}')">ìƒì„¸ë³´ê¸°</button></td>
                `;
                
                row.setAttribute('data-customer', customer.name);
            });
        }
        
        function showTradeDetails(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            // ìƒˆë¡œìš´ ìƒì„¸ ê³ ê° í”„ë¡œí•„ ìœˆë„ìš° ìƒì„±
            const detailWindow = document.createElement('div');
            detailWindow.id = 'customerDetailWindow';
            detailWindow.style.cssText = `
                position: fixed; top: 5%; left: 10%; width: 80%; height: 85%; 
                background: white; border-radius: 15px; box-shadow: 0 10px 50px rgba(0,0,0,0.3);
                z-index: 1000; overflow-y: auto; padding: 0;
            `;
            
            // ì‹œê°„ìˆœ ê±°ë˜ ë‚´ì—­ ìƒì„±
            const sortedTransactions = customer.transactions
                .map(t => ({
                    ...t,
                    classification: getTransactionClassification(customer, t)
                }))
                .sort((a, b) => b.parsedDate - a.parsedDate);
            
            // ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ ê³„ì‚°
            const monthlyTrend = calculateMonthlyTrend(customer);
            
            detailWindow.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px 15px 0 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>${customerName} ê³ ê° ì™„ì „ í”„ë¡œí•„</h2>
                        <button onclick="closeCustomerDetail()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer;">âœ• ë‹«ê¸°</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 15px;">
                        <div><strong>ì´ ë³´ì¦ê¸ˆ ì…ê¸ˆ:</strong><br>â‚©${customer.transactions.filter(t => getTransactionClassification(customer, t) === 'deposit').reduce((sum, t) => sum + t.inAmount, 0).toLocaleString()}</div>
                        <div><strong>í˜„ì¬ ë³´ì¦ê¸ˆ ì”ì•¡:</strong><br>â‚©${customer.depositAmount.toLocaleString()}</div>
                        <div><strong>ì´ ë§¤ì¶œ:</strong><br>â‚©${customer.salesAmount.toLocaleString()}</div>
                        <div><strong>ê±°ë˜ í™œë™ë„:</strong><br>${customer.transactions.length}ê±´ (${Math.round((new Date() - customer.firstTransactionDate) / (1000*60*60*24))}ì¼ê°„)</div>
                    </div>
                </div>
                
                <div style="padding: 25px;">
                    <!-- ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
                        <h4 style="margin-bottom: 15px;">ğŸ“ˆ ì›”ë³„ ë§¤ì¶œ íŠ¸ë Œë“œ</h4>
                        <div style="display: flex; gap: 15px; align-items: end; height: 100px;">
                            ${monthlyTrend.map(month => `
                                <div style="flex: 1; text-align: center;">
                                    <div style="background: #2563eb; width: 100%; height: ${Math.max(5, (month.amount / Math.max(...monthlyTrend.map(m => m.amount))) * 80)}px; margin-bottom: 5px; border-radius: 3px;"></div>
                                    <div style="font-size: 0.8em;">${month.month}</div>
                                    <div style="font-size: 0.7em; color: #059669;">â‚©${month.amount.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- ê±°ë˜ ë‚´ì—­ íƒ€ì„ë¼ì¸ -->
                    <h4 style="margin-bottom: 15px;">ğŸ•’ ì „ì²´ ê±°ë˜ íƒ€ì„ë¼ì¸ (ìµœì‹ ìˆœ)</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${sortedTransactions.map(t => {
                            const isIncome = t.type === 'ì…ê¸ˆ';
                            const bgColor = t.classification === 'deposit' ? '#fef3c7' : 
                                           t.classification === 'sales' ? '#f0fdf4' : 
                                           t.classification === 'refund' ? '#fef2f2' : '#f9fafb';
                            const icon = t.classification === 'deposit' ? 'ğŸ¦' :
                                        t.classification === 'sales' ? 'ğŸ’°' :
                                        t.classification === 'refund' ? 'â†©ï¸' : 'ğŸ“';
                            
                            return `
                                <div style="background: ${bgColor}; padding: 15px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid ${isIncome ? '#059669' : '#dc2626'};">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 1.2em;">${icon}</span>
                                            <div>
                                                <div style="font-weight: bold;">${t.date}</div>
                                                <div style="font-size: 0.9em; color: #6b7280;">${t.classification === 'deposit' ? 'ë³´ì¦ê¸ˆ ì…ê¸ˆ' : t.classification === 'sales' ? 'ë§¤ì¶œ (ìƒí’ˆêµ¬ë§¤)' : t.classification === 'refund' ? 'ë³´ì¦ê¸ˆ í™˜ê¸‰' : 'ì¼ë°˜ ' + t.type}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 1.2em; font-weight: bold; color: ${isIncome ? '#059669' : '#dc2626'};">
                                                ${isIncome ? '+' : '-'}â‚©${(t.inAmount || t.outAmount).toLocaleString()}
                                            </div>
                                            <div style="font-size: 0.8em; color: #6b7280;">${t.type}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ ìƒì„¸ì°½ì´ ìˆìœ¼ë©´ ì œê±°
            const existing = document.getElementById('customerDetailWindow');
            if (existing) existing.remove();
            
            document.body.appendChild(detailWindow);
        }
        
        function getTransactionClassification(customer, transaction) {
            if (transaction.type === 'ì¶œê¸ˆ') {
                if (customer.returnDate && transaction.date === customer.returnDate) {
                    return 'refund';
                }
                // ì§ì› ë¶„ë¥˜ í™•ì¸í•´ ì›”ì´ìš©ë£Œ ì²˜ë¦¬
                const tId = `${transaction.date}_${transaction.customer}_${transaction.inAmount || transaction.outAmount}`;
                if (staffClassifications[tId] === 'monthlyFee') return 'monthlyFee';
                if (staffClassifications[tId] === 'actualRefund') return 'actualRefund';
                return 'outgoing';
            }
            
            // ë³´ì¦ê¸ˆ íŒë³„
            if (isTransactionDeposit(customer, transaction)) {
                return 'deposit';
            }
            
            // ì§ì› ë¶„ë¥˜ í™•ì¸ (ì›”ì´ìš©ë£Œê°€ ì…ê¸ˆìœ¼ë¡œ í‘œì‹œëœ ê²½ìš° ë“±)
            const tId2 = `${transaction.date}_${transaction.customer}_${transaction.inAmount || transaction.outAmount}`;
            if (staffClassifications[tId2] === 'monthlyFee') return 'monthlyFee';
            if (staffClassifications[tId2] === 'actualRefund') return 'actualRefund';

            // ë‚˜ë¨¸ì§€ëŠ” ë§¤ì¶œ
            return 'sales';
        }
        
        function calculateMonthlyTrend(customer) {
            const monthlyData = {};
            
            customer.transactions
                .filter(t => t.type === 'ì…ê¸ˆ' && getTransactionClassification(customer, t) === 'sales')
                .forEach(t => {
                    const month = `${t.parsedDate.getFullYear()}-${String(t.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[month]) monthlyData[month] = 0;
                    monthlyData[month] += t.inAmount;
                });
            
            return Object.keys(monthlyData)
                .sort()
                .slice(-6) // ìµœê·¼ 6ê°œì›”
                .map(month => ({
                    month: month.substring(5), // MMë§Œ í‘œì‹œ
                    amount: monthlyData[month]
                }));
        }
        
        function closeCustomerDetail() {
            const detailWindow = document.getElementById('customerDetailWindow');
            if (detailWindow) detailWindow.remove();
        }
        
        // ê³ ê° ë³‘í•© ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showCustomerMergeModal() {
            const existingModal = document.getElementById('customerMergeModal');
            if (existingModal) existingModal.remove();
            
            const customerNames = Object.keys(allCustomers).filter(name => !allCustomers[name].excluded).sort();
            
            const modal = document.createElement('div');
            modal.id = 'customerMergeModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 2000; 
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px;">ğŸ”— ê³ ê° ë³‘í•© (ê°™ì€ ì‚¬ëŒì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°)</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        ì˜ˆ: "ê¹€íƒœìœ¤"ê³¼ "ê¹€íƒœìœ¤(ì„¸ì§„í™˜ì¦ˆì—‘ì„œ)"ì²˜ëŸ¼ ê°™ì€ ì‚¬ëŒì´ì§€ë§Œ ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ê±°ë˜í•œ ê²½ìš°
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë³‘í•©í•  ê³ ê° 1 (ë©”ì¸)</label>
                            <select id="mergeCustomer1" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                                <option value="">ê³ ê° ì„ íƒ...</option>
                                ${customerNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                            <div id="customer1Info" style="font-size: 0.8em; color: #6b7280; margin-top: 5px;"></div>
                        </div>
                        
                        <div style="text-align: center; font-size: 1.5em; color: #7c3aed;">â†’</div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë³‘í•©í•  ê³ ê° 2 (ë³‘í•©ë¨)</label>
                            <select id="mergeCustomer2" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                                <option value="">ê³ ê° ì„ íƒ...</option>
                                ${customerNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                            <div id="customer2Info" style="font-size: 0.8em; color: #6b7280; margin-top: 5px;"></div>
                        </div>
                    </div>
                    
                    <div id="mergePreview" style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                        <h4 style="margin-bottom: 10px;">ë³‘í•© ë¯¸ë¦¬ë³´ê¸°:</h4>
                        <div id="mergePreviewContent"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeCustomerMergeModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
                        <button onclick="executeCustomerMerge()" class="btn" id="executeMergeBtn" disabled>ë³‘í•© ì‹¤í–‰</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ê³ ê° ì„ íƒ ì‹œ ì •ë³´ í‘œì‹œ
            document.getElementById('mergeCustomer1').addEventListener('change', updateMergePreview);
            document.getElementById('mergeCustomer2').addEventListener('change', updateMergePreview);
        }
        
        function updateMergePreview() {
            const customer1Name = document.getElementById('mergeCustomer1').value;
            const customer2Name = document.getElementById('mergeCustomer2').value;
            
            const customer1Info = document.getElementById('customer1Info');
            const customer2Info = document.getElementById('customer2Info');
            const mergePreview = document.getElementById('mergePreview');
            const executeMergeBtn = document.getElementById('executeMergeBtn');
            
            if (customer1Name && allCustomers[customer1Name]) {
                const c1 = allCustomers[customer1Name];
                customer1Info.textContent = `ë³´ì¦ê¸ˆ: â‚©${c1.depositAmount.toLocaleString()}, ë§¤ì¶œ: â‚©${c1.salesAmount.toLocaleString()}, ê±°ë˜: ${c1.transactions.length}ê±´`;
            } else {
                customer1Info.textContent = '';
            }
            
            if (customer2Name && allCustomers[customer2Name]) {
                const c2 = allCustomers[customer2Name];
                customer2Info.textContent = `ë³´ì¦ê¸ˆ: â‚©${c2.depositAmount.toLocaleString()}, ë§¤ì¶œ: â‚©${c2.salesAmount.toLocaleString()}, ê±°ë˜: ${c2.transactions.length}ê±´`;
            } else {
                customer2Info.textContent = '';
            }
            
            if (customer1Name && customer2Name && customer1Name !== customer2Name) {
                const c1 = allCustomers[customer1Name];
                const c2 = allCustomers[customer2Name];
                
                mergePreview.style.display = 'block';
                document.getElementById('mergePreviewContent').innerHTML = `
                    <strong>"${customer2Name}"ì˜ ëª¨ë“  ê±°ë˜ê°€ "${customer1Name}"ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤:</strong><br>
                    â€¢ ì´ ê±°ë˜: ${c1.transactions.length + c2.transactions.length}ê±´<br>
                    â€¢ í•©ê³„ ë³´ì¦ê¸ˆ: â‚©${(c1.depositAmount + c2.depositAmount).toLocaleString()}<br>
                    â€¢ í•©ê³„ ë§¤ì¶œ: â‚©${(c1.salesAmount + c2.salesAmount).toLocaleString()}<br>
                    <div style="color: #dc2626; margin-top: 10px;">âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</div>
                `;
                executeMergeBtn.disabled = false;
            } else {
                mergePreview.style.display = 'none';
                executeMergeBtn.disabled = true;
            }
        }
        
        function executeCustomerMerge() {
            const customer1Name = document.getElementById('mergeCustomer1').value;
            const customer2Name = document.getElementById('mergeCustomer2').value;
            
            if (!customer1Name || !customer2Name || customer1Name === customer2Name) {
                showNotification('âŒ ì˜¬ë°”ë¥¸ ê³ ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (!confirm(`ì •ë§ë¡œ "${customer2Name}"ì„ "${customer1Name}"ìœ¼ë¡œ ë³‘í•©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                return;
            }
            
            const customer1 = allCustomers[customer1Name];
            const customer2 = allCustomers[customer2Name];
            
            if (!customer1 || !customer2) {
                showNotification('âŒ ê³ ê° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ë³‘í•© ì‹¤í–‰
            console.log(`=== ê³ ê° ë³‘í•© ì‹¤í–‰: ${customer2Name} â†’ ${customer1Name} ===`);
            
            // 1. customer2ì˜ ëª¨ë“  ê±°ë˜ë¥¼ customer1ìœ¼ë¡œ ì´ë™
            customer2.transactions.forEach(transaction => {
                // ê±°ë˜ì˜ ê³ ê°ëª…ì„ customer1Nameìœ¼ë¡œ ë³€ê²½
                transaction.customer = customer1Name;
                customer1.transactions.push(transaction);
            });
            
            // 2. allTransactionsì—ì„œë„ ê³ ê°ëª… ë³€ê²½
            allTransactions.forEach(transaction => {
                if (transaction.customer === customer2Name) {
                    transaction.customer = customer1Name;
                }
            });
            
            // 3. staffClassificationsì—ì„œë„ í‚¤ ë³€ê²½
            const newStaffClassifications = {};
            Object.keys(staffClassifications).forEach(transactionId => {
                if (transactionId.includes(`_${customer2Name}_`)) {
                    const newTransactionId = transactionId.replace(`_${customer2Name}_`, `_${customer1Name}_`);
                    newStaffClassifications[newTransactionId] = staffClassifications[transactionId];
                } else {
                    newStaffClassifications[transactionId] = staffClassifications[transactionId];
                }
            });
            staffClassifications = newStaffClassifications;
            
            // 4. customer2 ì‚­ì œ
            delete allCustomers[customer2Name];
            
            // 5. ì „ì²´ ë°ì´í„° ì¬ë¶„ì„
            analyzeCustomerData();
            
            // 6. ëª¨ë“  íƒ­ ì—…ë°ì´íŠ¸
            updateAllTabs();
            
            // 7. ì €ì¥
            saveData();
            
            showNotification(`âœ… "${customer2Name}"ì´ "${customer1Name}"ìœ¼ë¡œ ì„±ê³µì ìœ¼ë¡œ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            closeCustomerMergeModal();
        }
        
        function closeCustomerMergeModal() {
            const modal = document.getElementById('customerMergeModal');
            if (modal) modal.remove();
        }
        
        // ESC í‚¤ë¡œ ëª¨ë“  ëª¨ë‹¬ì°½ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCustomerDetail();
                closeCustomerMergeModal();
            }
        });
        
        function showBoutiqueDetails(customerName) {
            // íŠ¸ë ˆì´ë“œì™€ ë™ì¼í•œ ìƒì„¸ í”„ë¡œí•„ ì°½ ì‚¬ìš©
            showTradeDetails(customerName);
        }
    
        function toggleCustomerDepositDetails(customerName, row) {
            const customer = allCustomers[customerName];
            
            // í˜„ì¬ í–‰ì´ ì´ë¯¸ í™•ì¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            const isCurrentlyExpanded = row.classList.contains('expanded');
            
            // ëª¨ë“  ê¸°ì¡´ ìƒì„¸í–‰ê³¼ expanded ìƒíƒœ ì œê±°
            document.querySelectorAll('#depositsTable .detail-row').forEach(detailRow => {
                detailRow.remove();
            });
            document.querySelectorAll('#depositsTable .customer-row.expanded').forEach(expandedRow => {
                expandedRow.classList.remove('expanded');
            });

            // ê°™ì€ ê³ ê°ì„ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš° ë‹«ê¸°
            if (isCurrentlyExpanded) {
                return;
            }
            
            // ìƒˆë¡œìš´ ìƒì„¸í–‰ ìƒì„±
            const table = row.parentNode.parentNode; // tbodyì˜ ë¶€ëª¨ table
            const tbody = table.querySelector('tbody');
            const newRow = tbody.insertRow(row.rowIndex);
            newRow.className = 'detail-row';
            
            // ì§ì› ë¶„ë¥˜ê°€ ìˆëŠ” ê±°ë˜ë“¤ í™•ì¸
            const manualClassifications = customer.transactions.map(t => {
                const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                const staffClass = staffClassifications[tId];
                return { ...t, staffClass };
            });
            
            let detailHTML = `
                <td colspan="7">
                    <div style="padding: 15px;">
                        <h5 style="margin-bottom: 15px;">${customerName} ìƒì„¸ ê±°ë˜ ë‚´ì—­</h5>
                        
                        <!-- ìš”ì•½ ì •ë³´ -->
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                                <div><strong>ë³´ì¦ê¸ˆ:</strong> â‚©${customer.depositAmount.toLocaleString()}</div>
                                <div><strong>ë§¤ì¶œ:</strong> â‚©${customer.salesAmount.toLocaleString()}</div>
                                <div><strong>í™˜ê¸‰ìƒíƒœ:</strong> ${customer.depositStatus === 'returned' ? 'í™˜ê¸‰ì™„ë£Œ' : 'ë¯¸í™˜ê¸‰'}</div>
                                <div><strong>ê±°ë˜íƒ€ì…:</strong> ${customer.salesType === 'trade' ? 'íŠ¸ë ˆì´ë“œ' : 'ë¶€í‹°í¬'}</div>
                            </div>
                            ${customer.partialRefundInfo ? `
                            <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 5px;">
                                <strong>ğŸ”„ ë¶€ë¶„í™˜ê¸‰ ì •ë³´:</strong><br>
                                ì´ ë³´ì¦ê¸ˆ: â‚©${customer.partialRefundInfo.totalDeposit.toLocaleString()}, 
                                í™˜ê¸‰: â‚©${customer.partialRefundInfo.partialRefund.toLocaleString()} (${customer.partialRefundInfo.refundDate}), 
                                ì”ì•¡: â‚©${customer.partialRefundInfo.remainingDeposit.toLocaleString()}
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- ìƒì„¸ ê±°ë˜ í…Œì´ë¸” -->
                        <table style="width: 100%; font-size: 0.9em;">
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ</th>
                                    <th>ìœ í˜•</th>
                                    <th>ê¸ˆì•¡</th>
                                    <th>ìë™ë¶„ë¥˜</th>
                                    <th>ì§ì›ë¶„ë¥˜</th>
                                    <th>ìµœì¢…ë¶„ë¥˜</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            customer.transactions.forEach(t => {
                let autoClassification = '';
                let finalClassification = '';
                
                if (t.type === 'ì…ê¸ˆ') {
                    if (isTransactionDeposit(customer, t)) {
                        autoClassification = '<span class="status-badge status-deposit">ë³´ì¦ê¸ˆ</span>';
                    } else {
                        autoClassification = customer.salesType === 'trade' ? 
                            '<span class="status-badge status-sales">íŠ¸ë ˆì´ë“œë§¤ì¶œ</span>' : 
                            '<span class="status-badge status-sales">ë¶€í‹°í¬ë§¤ì¶œ</span>';
                    }
                } else {
                    if (customer.returnDate && t.date === customer.returnDate) {
                        autoClassification = '<span class="status-badge status-returned">í™˜ê¸‰</span>';
                    } else {
                        autoClassification = '<span>ì¼ë°˜ì¶œê¸ˆ</span>';
                    }
                }
                
                // ì§ì›ë¶„ë¥˜ í™•ì¸
                const staffClass = t.staffClass;
                let staffClassBadge = '<span style="color: #6b7280;">ì—†ìŒ</span>';
                if (staffClass) {
                    const classLabels = {
                        'trade': '<span class="status-badge status-sales">íŠ¸ë ˆì´ë“œë§¤ì¶œ</span>',
                        'boutique': '<span class="status-badge status-sales">ë¶€í‹°í¬ë§¤ì¶œ</span>',
                        'deposit': '<span class="status-badge status-deposit">ë³´ì¦ê¸ˆ</span>',
                        'refund': '<span class="status-badge status-returned">í™˜ê¸‰</span>',
                        'actualRefund': '<span class="status-badge status-refund">í™˜ë¶ˆ</span>',
                        'monthlyFee': '<span class="status-badge status-excluded">ì›”ì´ìš©ë£Œ</span>',
                        'exclude': '<span class="status-badge status-excluded">ì œì™¸</span>'
                    };
                    staffClassBadge = classLabels[staffClass] || staffClassBadge;
                }
                
                // ìµœì¢… ë¶„ë¥˜ (ì§ì›ë¶„ë¥˜ê°€ ìˆìœ¼ë©´ ì§ì›ë¶„ë¥˜, ì—†ìœ¼ë©´ ìë™ë¶„ë¥˜)
                finalClassification = staffClass ? staffClassBadge : autoClassification;
                
                detailHTML += `
                    <tr class="transaction-type-${t.type === 'ì…ê¸ˆ' ? 'income' : 'outcome'}">
                        <td>${t.date}</td>
                        <td>${t.type}</td>
                        <td class="amount-${t.type === 'ì…ê¸ˆ' ? 'positive' : 'negative'}">â‚©${(t.inAmount || t.outAmount).toLocaleString()}</td>
                        <td>${autoClassification}</td>
                        <td>${staffClassBadge}</td>
                        <td><strong>${finalClassification}</strong></td>
                    </tr>
                `;
            });
            
            detailHTML += `
                            </tbody>
                        </table>
                    </div>
                </td>
            `;
            
            newRow.innerHTML = detailHTML;
            row.classList.add('expanded');
        }
    
        function updateDepositsTab() {
            const tbody = document.querySelector('#depositsTable tbody');
            tbody.innerHTML = '';
            
            const depositCustomers = Object.values(allCustomers).filter(c => {
                if (c.excluded) return false;
                
                // ê°•íš¨ìˆœì€ ë³´ì¦ê¸ˆ ê´€ë¦¬ì—ì„œ ì œì™¸ (ê°•ë¯¼êµ­ê³¼ ì¤‘ë³µì´ë¯€ë¡œ)
                if (specialCases[c.name] && specialCases[c.name].excludeFromDepositManagement) return false;
                
                // ì§ì›ë¶„ë¥˜ê°€ ìˆëŠ” ê²½ìš° ì§ì›ë¶„ë¥˜ë¥¼ ìš°ì„ ìœ¼ë¡œ íŒë‹¨
                const hasManualDeposit = c.transactions.some(t => {
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    return staffClassifications[tId] === 'deposit';
                });
                
                const hasManualClassification = c.transactions.some(t => {
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    return staffClassifications[tId]; // ì•„ë¬´ ë¶„ë¥˜ë“  ìˆìœ¼ë©´
                });
                
                // ì§ì›ë¶„ë¥˜ê°€ ìˆìœ¼ë©´ ë³´ì¦ê¸ˆ ë¶„ë¥˜ê°€ ìˆëŠ” ê²½ìš°ë§Œ
                if (hasManualClassification) {
                    return hasManualDeposit;
                }
                
                // ì§ì›ë¶„ë¥˜ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë¡œì§ (ë³´ì¦ê¸ˆì´ ìˆê±°ë‚˜ í™˜ê¸‰ì™„ë£Œ ì´ë ¥ì´ ìˆëŠ” ê²½ìš°)
                return c.depositAmount > 0 || c.depositStatus === 'returned' || c.originalDepositAmount > 0;
            });
            let unreturnedAmount = 0;
            let returnedAmount = 0;
            let unreturnedCount = 0;
            let returnedCount = 0;
            let warningCount = 0;
            let warningCustomersList = [];
            
            depositCustomers.forEach(customer => {
                const row = tbody.insertRow();
                
                // í™˜ê¸‰ì™„ë£Œ ê³ ê°ì˜ ê²½ìš° ì›ë˜ ë³´ì¦ê¸ˆ ê¸ˆì•¡ í‘œì‹œ (ê¹€ì§„í˜¸ ì¼€ì´ìŠ¤)
                const displayDepositAmount = customer.depositStatus === 'returned' ? 
                    (customer.originalDepositAmount || specialCases[customer.name]?.depositAmount || customer.depositAmount) : 
                    customer.depositAmount;
                
                let statusBadge, returnDateText;
                if (customer.depositStatus === 'returned') {
                    statusBadge = '<span class="status-badge status-returned">í™˜ê¸‰ì™„ë£Œ</span>';
                    returnDateText = customer.returnDate ? customer.returnDate : '-';
                    returnedAmount += displayDepositAmount;
                    returnedCount++;
                } else {
                    statusBadge = '<span class="status-badge status-unreturned">ë¯¸í™˜ê¸‰</span>';
                    returnDateText = '-';
                    unreturnedAmount += customer.depositAmount;
                    unreturnedCount++;
                }
                
                // ì£¼ì˜ê³ ê° íŒë³„: ë³´ì¦ê¸ˆì€ ìˆì§€ë§Œ ë§¤ì¶œì´ ì—†ëŠ” ê²½ìš°
                if (customer.salesAmount === 0 && customer.depositStatus === 'unreturned') {
                    // ì •ìµë§Œì€ ì‹¤ì œë¡œ ë§¤ì¶œì´ ìˆìœ¼ë¯€ë¡œ ì£¼ì˜ê³ ê°ì—ì„œ ì œì™¸
                    if (!(specialCases[customer.name] && specialCases[customer.name].hasSales)) {
                        warningCount++;
                        warningCustomersList.push(`${customer.name}(â‚©${customer.depositAmount.toLocaleString()})`);
                    }
                }
                
                row.innerHTML = `
                    <td><strong>${customer.name}</strong></td>
                    <td class="amount-negative">â‚©${displayDepositAmount.toLocaleString()}</td>
                    <td>${customer.depositDate || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${returnDateText}</td>
                    <td class="amount-positive">â‚©${customer.salesAmount.toLocaleString()}</td>
                    <td>${specialCases[customer.name]?.note || 'ì¼ë°˜ ë³´ì¦ê¸ˆ'}</td>
                `;
                
                // í´ë¦­ ì‹œ ìƒì„¸ ê±°ë˜ ë‚´ì—­ ë³´ê¸°
                row.style.cursor = 'pointer';
                row.addEventListener('click', () => toggleCustomerDepositDetails(customer.name, row));
            });
            
            const efficiency = unreturnedAmount > 0 ? ((depositCustomers.filter(c => c.depositStatus === 'unreturned').reduce((sum, c) => sum + c.salesAmount, 0) / unreturnedAmount) * 100).toFixed(1) : 0;
            
            document.getElementById('unreturnedDepositAmount').textContent = 'â‚©' + unreturnedAmount.toLocaleString();
            document.getElementById('returnedDepositAmount').textContent = 'â‚©' + returnedAmount.toLocaleString();
            document.getElementById('unreturnedDepositCount').textContent = unreturnedCount + 'ëª… ê³ ê°';
            document.getElementById('returnedDepositCount').textContent = returnedCount + 'ëª… ê³ ê°';
            document.getElementById('depositEfficiency').textContent = efficiency + '%';
            document.getElementById('depositEfficiencyDetail').textContent = `ë¯¸í™˜ê¸‰ ë³´ì¦ê¸ˆ ëŒ€ë¹„ ë§¤ì¶œ ë¹„ìœ¨`;
            document.getElementById('warningCustomers').textContent = warningCount + 'ëª…';
            
            // ì£¼ì˜ê³ ê° ìƒì„¸ ì •ë³´ í‘œì‹œ
            const warningDetail = warningCustomersList.length > 0 ? 
                `${warningCustomersList.slice(0, 3).join(', ')}${warningCustomersList.length > 3 ? ` ì™¸ ${warningCustomersList.length - 3}ëª…` : ''}` : 
                'ì£¼ì˜ê³ ê° ì—†ìŒ';
            document.getElementById('warningCustomersDetail').textContent = warningDetail;
        }
    
        function updateSalesTab() {
            const tbody = document.querySelector('#salesTable tbody');
            tbody.innerHTML = '';
            
            const salesCustomers = Object.values(allCustomers)
                .filter(c => !c.excluded && c.salesAmount > 0) // ë§¤ì¶œì´ 0 ì´í•˜ë©´ ì œì™¸
                .sort((a, b) => b.salesAmount - a.salesAmount);
            
            // ë§¤ì¶œ ìš”ì•½ ì •ë³´ ê³„ì‚°
            const tradeSales = salesCustomers.filter(c => c.salesType === 'trade');
            const boutiqueSales = salesCustomers.filter(c => c.salesType === 'boutique');
            const totalTradeSales = tradeSales.reduce((sum, c) => sum + c.salesAmount, 0);
            const totalBoutiqueSales = boutiqueSales.reduce((sum, c) => sum + c.salesAmount, 0);
            const totalSales = totalTradeSales + totalBoutiqueSales;
            
            // ìš”ì•½ ì •ë³´ í‘œì‹œ
            const summaryGrid = document.getElementById('salesSummaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">ğŸª íŠ¸ë ˆì´ë“œ ë§¤ì¶œ</div>
                    <div class="summary-value">â‚©${totalTradeSales.toLocaleString()}</div>
                    <div class="summary-detail">${tradeSales.length}ëª… ê³ ê° (${totalSales > 0 ? ((totalTradeSales/totalSales)*100).toFixed(1) : 0}%)</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ğŸ›ï¸ ë¶€í‹°í¬ ë§¤ì¶œ</div>
                    <div class="summary-value">â‚©${totalBoutiqueSales.toLocaleString()}</div>
                    <div class="summary-detail">${boutiqueSales.length}ëª… ê³ ê° (${totalSales > 0 ? ((totalBoutiqueSales/totalSales)*100).toFixed(1) : 0}%)</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ğŸ“Š ì „ì²´ ë§¤ì¶œ</div>
                    <div class="summary-value">â‚©${totalSales.toLocaleString()}</div>
                    <div class="summary-detail">${salesCustomers.length}ëª… ì´ ê³ ê°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">ğŸ’° í‰ê·  ë§¤ì¶œ</div>
                    <div class="summary-value">â‚©${salesCustomers.length > 0 ? Math.round(totalSales/salesCustomers.length).toLocaleString() : '0'}</div>
                    <div class="summary-detail">ê³ ê°ë‹¹ í‰ê·  ë§¤ì¶œì•¡</div>
                </div>
            `;
            
            salesCustomers.forEach(customer => {
                const row = tbody.insertRow();
                row.className = 'customer-row';
                
                const period = customer.firstTransactionDate && customer.lastTransactionDate ? 
                    (customer.firstTransactionDate.getTime() === customer.lastTransactionDate.getTime() ? 
                        customer.firstTransactionDate.toLocaleDateString('ko-KR', {year: '2-digit', month: 'numeric', day: 'numeric'}) :
                        `${customer.firstTransactionDate.toLocaleDateString('ko-KR', {year: '2-digit', month: 'numeric', day: 'numeric'})} ~ ${customer.lastTransactionDate.toLocaleDateString('ko-KR', {year: '2-digit', month: 'numeric', day: 'numeric'})}`) : 
                    '-';
                
                const incomeCount = customer.transactions.filter(t => t.type === 'ì…ê¸ˆ').length;
                
                // ì›”í‰ê·  ë§¤ì¶œ ê³„ì‚°
                let monthlyAverage = 0;
                if (customer.firstTransactionDate && customer.lastTransactionDate) {
                    const monthsDiff = Math.max(1, Math.ceil((customer.lastTransactionDate - customer.firstTransactionDate) / (1000 * 60 * 60 * 24 * 30)));
                    monthlyAverage = Math.round(customer.salesAmount / monthsDiff);
                }
                
                let typeClass = customer.salesType || 'boutique';
                let typeBadge = typeClass === 'trade' ? 
                    '<span class="status-badge status-deposit">íŠ¸ë ˆì´ë“œë§¤ì¶œ</span>' : 
                    '<span class="status-badge status-sales">ë¶€í‹°í¬ë§¤ì¶œ</span>';
                
                row.innerHTML = `
                    <td><strong>${customer.name}</strong></td>
                    <td class="amount-large">â‚©${customer.salesAmount.toLocaleString()}</td>
                    <td>${incomeCount}ê±´</td>
                    <td style="font-size: 0.9em;">${period}</td>
                    <td>${typeBadge}</td>
                    <td class="amount-positive">â‚©${monthlyAverage.toLocaleString()}</td>
                    <td>${customer.depositAmount > 0 ? 'â‚©' + customer.depositAmount.toLocaleString() : '-'}</td>
                    <td><button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="event.stopPropagation(); showSalesDetails('${customer.name.replace(/'/g, "\\'")}')">ìƒì„¸ë³´ê¸°</button></td>
                `;
                
                row.setAttribute('data-type', typeClass);
                row.setAttribute('data-customer', customer.name);
                row.addEventListener('click', () => {
                     showTab('customers');
                     document.getElementById('customerSearch').value = customer.name;
                     filterCustomersTable(customer.name.toLowerCase(), 'all');
                });
            });
        }
    
        function showSalesDetails(customerName) {
            try {
                showTab('tradeSales');
                document.getElementById('tradeSearch').value = customerName;
                filterTradeTable(customerName.toLowerCase(), 'all');
                
                setTimeout(() => {
                    const rows = document.querySelectorAll('#tradeTable tbody tr[data-customer]');
                    const targetRow = Array.from(rows).find(r => r.getAttribute('data-customer') === customerName);
                    if (targetRow) {
                        targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            } catch (error) {
                console.error('ìƒì„¸ë³´ê¸° ì˜¤ë¥˜:', error);
                showNotification('âŒ ìƒì„¸ë³´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    
        // ==========================================================
        // â–¼â–¼â–¼ ì›”ë³„ ë¶„ì„ ê¸°ëŠ¥ ê°œì„  â–¼â–¼â–¼
        // ==========================================================
    
        function updateMonthlyTab() {
            const tbody = document.querySelector('#monthlyTable tbody');
            tbody.innerHTML = '';
            
            const salesTransactions = allTransactions.filter(t => {
                if (t.type !== 'ì…ê¸ˆ' || t.excluded) return false;
                const customer = allCustomers[t.customer];
                if (!customer) return false;
                
                // ë³´ì¦ê¸ˆ ê±°ë˜ ì™„ì „ ì œì™¸ (100ë§Œì› ì´ìƒ ì²« ì…ê¸ˆ)
                const isDepositTransaction = customer.depositAmount > 0 && t.inAmount === customer.depositAmount && t.date === customer.depositDate;
                if (isDepositTransaction) return false;
                
                // ì›”ë³„ ë¶„ì„ì—ì„œ íŠ¹ë³„ ì¼€ì´ìŠ¤ ë³´ì¦ê¸ˆë„ ì œì™¸
                if (specialCases[customer.name]) {
                    const specialCase = specialCases[customer.name];
                    if (specialCase.type === 'deposit_2000000' && t.inAmount >= 1000000) {
                        return false; // ê¹€ì„ ì˜ 200ë§Œì› ë³´ì¦ê¸ˆ (100ë§ŒÃ—2íšŒ) ì œì™¸
                    }
                    if (specialCase.type === 'linked_to_kanghyosoon' && t.inAmount >= 500000) {
                        return false; // ê°•ë¯¼êµ­ ë³´ì¦ê¸ˆ ì œì™¸
                    }
                    if (specialCase.type === 'deposit_500000' && t.inAmount === 500000) {
                        return false; // ì‹ ë²”ìˆ˜, ì •ìµë§Œ ë³´ì¦ê¸ˆ ì œì™¸
                    }
                    if (specialCase.type === 'deposit_100000' && t.inAmount === 100000) {
                        return false; // ê¹€ìœ ë¹ˆ ë³´ì¦ê¸ˆ ì œì™¸
                    }
                    if (specialCase.type === 'deposit_300000' && t.inAmount === 300000) {
                        return false; // ì „í™˜ìŠ¹ ë³´ì¦ê¸ˆ ì œì™¸
                    }
                    if (specialCase.type === 'deposit_500000_returned' && t.inAmount === 500000) {
                        return false; // ìµœì¬ì—° ë³´ì¦ê¸ˆ ì œì™¸
                    }
                    if (specialCase.type === 'deposit_refund_complete' && t.inAmount === specialCase.depositAmount) {
                        return false; // ê¹€ì§„í˜¸ ë³´ì¦ê¸ˆ ì œì™¸
                    }
                    if (specialCase.type === 'deposit_500' && t.inAmount >= 1000000) {
                        return false; // ì¡°íƒœë ¨ ë³´ì¦ê¸ˆ ì œì™¸
                    }
                    if (specialCase.type === 'deposit_1000000' && t.inAmount >= 1000000) {
                        return false; // ê°•íš¨ìˆœ ë³´ì¦ê¸ˆ ì œì™¸
                    }
                    if (specialCase.type === 'full_refund') {
                        return false; // í…Œì´ë°ë© ì „ì•¡í™˜ë¶ˆ ì œì™¸
                    }
                }
                
                // ë§¤ì¶œì´ 0 ì´í•˜ì¸ ê³ ê°ì˜ ê±°ë˜ ì œì™¸ (í™˜ê¸‰ë§Œ ë°›ê³  ë§¤ì¶œ ì—†ëŠ” ê²½ìš°)
                if (customer.salesAmount <= 0) return false;
                
                return true;
            });
            
            const monthlyData = {};
            
            salesTransactions.forEach(t => {
                const yearMonth = `${t.parsedDate.getFullYear()}-${String(t.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = { 
                        transactions: 0, 
                        amount: 0, 
                        customers: new Set(), 
                        newCustomers: new Set(),
                        tradeAmount: 0,
                        boutiqueAmount: 0,
                        tradeCount: 0,
                        boutiqueCount: 0
                    };
                }
                
                const customer = allCustomers[t.customer];
                const isTradeTransaction = customer && (customer.salesType === 'trade' || customer.depositAmount > 0);
                
                monthlyData[yearMonth].transactions++;
                monthlyData[yearMonth].amount += t.inAmount;
                monthlyData[yearMonth].customers.add(t.customer);
                
                if (isTradeTransaction) {
                    monthlyData[yearMonth].tradeAmount += t.inAmount;
                    monthlyData[yearMonth].tradeCount++;
                } else {
                    monthlyData[yearMonth].boutiqueAmount += t.inAmount;
                    monthlyData[yearMonth].boutiqueCount++;
                }
                
                if (customer && customer.firstTransactionDate && customer.firstTransactionDate.getFullYear() === t.parsedDate.getFullYear() && customer.firstTransactionDate.getMonth() === t.parsedDate.getMonth()) {
                    monthlyData[yearMonth].newCustomers.add(t.customer);
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            let previousAmount = 0;
            
            sortedMonths.forEach((month, index) => {
                const data = monthlyData[month];
                const prevMonthKey = sortedMonths[index + 1];
                previousAmount = prevMonthKey ? monthlyData[prevMonthKey].amount : 0;
                const avgAmount = data.transactions > 0 ? data.amount / data.transactions : 0;
                const growthRate = previousAmount > 0 ? ((data.amount - previousAmount) / previousAmount * 100).toFixed(1) : '0.0';
                
                const row = tbody.insertRow();
                row.className = 'customer-row'; // í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ìŠ¤íƒ€ì¼ ì ìš©
                row.setAttribute('data-month', month);
    
                const tradeVsBoutique = `T:â‚©${data.tradeAmount.toLocaleString()} / B:â‚©${data.boutiqueAmount.toLocaleString()}`;
                
                row.innerHTML = `
                    <td><strong>${month}</strong></td>
                    <td>${data.transactions}ê±´</td>
                    <td class="amount-positive">â‚©${data.amount.toLocaleString()}</td>
                    <td style="font-size: 0.8em;">${tradeVsBoutique}</td>
                    <td>${data.newCustomers.size}ëª…</td>
                    <td>â‚©${Math.round(avgAmount).toLocaleString()}</td>
                    <td style="color: ${parseFloat(growthRate) >= 0 ? '#059669' : '#dc2626'}">${growthRate >= 0 ? 'â–²' : 'â–¼'} ${growthRate}%</td>
                `;
                
                // ì›”ë³„ ìƒì„¸ë³´ê¸°ë¥¼ ìœ„í•œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                row.addEventListener('click', () => toggleMonthDetails(month, row));
            });
        }
    
        // ì›”ë³„ ìƒì„¸ ê±°ë˜ë‚´ì—­ì„ ë³´ì—¬ì£¼ëŠ” ìƒˆë¡œìš´ í•¨ìˆ˜
        function toggleMonthDetails(month, row) {
            // í˜„ì¬ í–‰ì´ ì´ë¯¸ í™•ì¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            const isCurrentlyExpanded = row.classList.contains('expanded');
            
            // ëª¨ë“  ê¸°ì¡´ ìƒì„¸í–‰ê³¼ expanded ìƒíƒœ ì œê±°
            document.querySelectorAll('#monthlyTable .detail-row').forEach(detailRow => {
                detailRow.remove();
            });
            document.querySelectorAll('#monthlyTable .customer-row.expanded').forEach(expandedRow => {
                expandedRow.classList.remove('expanded');
            });

            // ê°™ì€ ì›”ì„ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš° ë‹«ê¸°
            if (isCurrentlyExpanded) {
                return;
            }

            const [year, monthNum] = month.split('-').map(Number);
    
            const monthSalesTransactions = allTransactions.filter(t => {
                if (t.type !== 'ì…ê¸ˆ' || t.excluded || !t.parsedDate) return false;
                if (t.parsedDate.getFullYear() !== year || t.parsedDate.getMonth() + 1 !== monthNum) return false;
                
                const customer = allCustomers[t.customer];
                if (!customer) return false;
                
                // ë³´ì¦ê¸ˆ ê±°ë˜ ì œì™¸
                return !(customer.depositAmount > 0 && t.inAmount === customer.depositAmount && t.date === customer.depositDate);
            }).sort((a,b) => b.parsedDate - a.parsedDate);
    
            let detailHTML = `<td colspan="7"><div style="padding: 15px;">
                <h5 style="margin-bottom: 10px;">${month} ë§¤ì¶œ ìƒì„¸ ë‚´ì—­ (${monthSalesTransactions.length}ê±´)</h5>
                <table style="width: 100%; font-size: 0.9em;">
                    <thead><tr><th>ë‚ ì§œ</th><th>ê³ ê°ëª…</th><th>ë§¤ì¶œì•¡</th><th>íƒ€ì…</th></tr></thead>
                    <tbody>`;
    
            monthSalesTransactions.forEach(t => {
                const customer = allCustomers[t.customer];
                const isTradeTransaction = customer && (customer.salesType === 'trade' || customer.depositAmount > 0);
                const typeLabel = isTradeTransaction ? 'T' : 'B';
                
                detailHTML += `
                    <tr class="transaction-type-income">
                        <td>${t.date}</td>
                        <td><strong>${t.customer}</strong></td>
                        <td class="amount-positive">â‚©${t.inAmount.toLocaleString()}</td>
                        <td style="font-weight: bold; color: ${isTradeTransaction ? '#7c3aed' : '#059669'}">${typeLabel}</td>
                    </tr>
                `;
            });
    
            detailHTML += `</tbody></table></div></td>`;
            
            // ìƒˆë¡œìš´ ìƒì„¸í–‰ ìƒì„± (ê¸°ì¡´ ë°©ì‹ ëŒ€ì‹ )
            const table = row.parentNode.parentNode; // tbodyì˜ ë¶€ëª¨ table
            const tbody = table.querySelector('tbody');
            const newRow = tbody.insertRow(row.rowIndex);
            newRow.className = 'detail-row';
            newRow.innerHTML = detailHTML;
            
            row.classList.add('expanded');
        }
        
        // ==========================================================
        // â–²â–²â–² ì›”ë³„ ë¶„ì„ ê¸°ëŠ¥ ê°œì„  â–²â–²â–²
        // ==========================================================
        
        function updateTransactionsTab() {
            const tbody = document.querySelector('#transactionsTable tbody');
            tbody.innerHTML = '';
            
            let classifiedCount = 0;
            let unclassifiedCount = 0;
            let tradeClassifiedCount = 0;
            let boutiqueClassifiedCount = 0;
            
            // ì„±ëŠ¥ ìµœì í™”: ê±°ë˜ ë¶„ë¥˜ ì •ë³´ë¥¼ ë¯¸ë¦¬ ìºì‹œ
            const transactionClassificationCache = {};
            
            console.log('ê±°ë˜ íƒ­ ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            // ë°°ì¹˜ ì²˜ë¦¬ë¡œ DOM ì—…ë°ì´íŠ¸ ìµœì í™”
            const fragment = document.createDocumentFragment();
            
            allTransactions.forEach((t, index) => {
                try {
                    const row = document.createElement('tr');
                    row.className = `transaction-type-${t.type === 'ì…ê¸ˆ' ? 'income' : 'outcome'}`;
                    
                    let autoClassification = '';
                    let staffClassification = '';
                    
                    // ìºì‹œëœ ë¶„ë¥˜ ì •ë³´ ì‚¬ìš© ë˜ëŠ” ê³„ì‚°
                    const cacheKey = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    
                    if (!transactionClassificationCache[cacheKey]) {
                        if (t.excluded) {
                            autoClassification = '<span class="status-badge status-excluded">ì œì™¸</span>';
                            classifiedCount++;
                        } else {
                            const customer = allCustomers[t.customer];
                            if (customer) {
                                if (t.type === 'ì…ê¸ˆ') {
                                    // ì„±ëŠ¥ ìµœì í™”: ê°„ë‹¨í•œ ë³´ì¦ê¸ˆ íŒë³„ (ë³µì¡í•œ ë¡œì§ ìµœì†Œí™”)
                                    const isDeposit = customer.depositAmount > 0 && 
                                                    t.inAmount >= 100000 && 
                                                    t.date === customer.depositDate;
                                    
                                    if (isDeposit) {
                                        autoClassification = '<span class="status-badge status-deposit">ë³´ì¦ê¸ˆ</span>';
                                    } else {
                                        if (customer.salesType === 'trade') {
                                            autoClassification = '<span class="status-badge status-sales">íŠ¸ë ˆì´ë“œë§¤ì¶œ</span>';
                                            tradeClassifiedCount++;
                                        } else {
                                            autoClassification = '<span class="status-badge status-sales">ë¶€í‹°í¬ë§¤ì¶œ</span>';
                                            boutiqueClassifiedCount++;
                                        }
                                    }
                                    classifiedCount++;
                                } else if (t.type === 'ì¶œê¸ˆ' && customer.returnDate && t.date === customer.returnDate) {
                                    autoClassification = '<span class="status-badge status-returned">í™˜ê¸‰</span>';
                                    classifiedCount++;
                                } else {
                                    // ì§ì›ë¶„ë¥˜ì— ì›”ì´ìš©ë£Œê°€ ì§€ì •ëœ ì¶œê¸ˆ/ì…ê¸ˆ ì²˜ë¦¬
                                    const tIdTmp = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                                    if (staffClassifications[tIdTmp] === 'monthlyFee') {
                                        autoClassification = '<span class="status-badge status-excluded">ì›”ì´ìš©ë£Œ</span>';
                                    } else {
                                        autoClassification = '<span>ì¼ë°˜ì¶œê¸ˆ</span>';
                                    }
                                    classifiedCount++;
                                }
                            } else {
                                unclassifiedCount++;
                            }
                        }
                        
                        // ê²°ê³¼ ìºì‹œ
                        transactionClassificationCache[cacheKey] = autoClassification;
                    } else {
                        autoClassification = transactionClassificationCache[cacheKey];
                        if (autoClassification.includes('ì œì™¸')) classifiedCount++;
                        else if (autoClassification.includes('íŠ¸ë ˆì´ë“œë§¤ì¶œ')) { classifiedCount++; tradeClassifiedCount++; }
                        else if (autoClassification.includes('ë¶€í‹°í¬ë§¤ì¶œ')) { classifiedCount++; boutiqueClassifiedCount++; }
                        else if (autoClassification.includes('ë³´ì¦ê¸ˆ') || autoClassification.includes('í™˜ê¸‰') || autoClassification.includes('ì¼ë°˜ì¶œê¸ˆ') || autoClassification.includes('ì›”ì´ìš©ë£Œ')) classifiedCount++;
                        else unclassifiedCount++;
                    }
                    
                    // ì§ì› ë¶„ë¥˜ ìˆ˜ì • ê°€ëŠ¥í•œ ë“œë¡­ë‹¤ìš´
                    const transactionId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`.replace(/'/g, "\\'");
                    const currentClassification = staffClassifications[transactionId] || '';
                    
                    // ì§ì› ë¶„ë¥˜ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„ ìœ¼ë¡œ í‘œì‹œ
                    if (currentClassification) {
                        const classificationLabels = {
                            'trade': '<span class="status-badge status-sales">íŠ¸ë ˆì´ë“œë§¤ì¶œ</span>',
                            'boutique': '<span class="status-badge status-sales">ë¶€í‹°í¬ë§¤ì¶œ</span>',
                            'deposit': '<span class="status-badge status-deposit">ë³´ì¦ê¸ˆ</span>',
                            'refund': '<span class="status-badge status-returned">í™˜ê¸‰</span>',
                            'actualRefund': '<span class="status-badge status-refund">í™˜ë¶ˆ</span>',
                            'monthlyFee': '<span class="status-badge status-excluded">ì›”ì´ìš©ë£Œ</span>',
                            'exclude': '<span class="status-badge status-excluded">ì œì™¸</span>'
                        };
                        autoClassification = classificationLabels[currentClassification] || autoClassification;
                    }
                    
                    staffClassification = `
                        <select id="staff_${transactionId}" onchange="updateStaffClassification('${transactionId}', this.value)" style="font-size: 0.8em;">
                            <option value="" ${currentClassification === '' ? 'selected' : ''}>ìë™ë¶„ë¥˜</option>
                            <option value="trade" ${currentClassification === 'trade' ? 'selected' : ''}>íŠ¸ë ˆì´ë“œë§¤ì¶œ</option>
                            <option value="boutique" ${currentClassification === 'boutique' ? 'selected' : ''}>ë¶€í‹°í¬ë§¤ì¶œ</option>
                            <option value="deposit" ${currentClassification === 'deposit' ? 'selected' : ''}>ë³´ì¦ê¸ˆ</option>
                            <option value="refund" ${currentClassification === 'refund' ? 'selected' : ''}>í™˜ê¸‰</option>
                            <option value="actualRefund" ${currentClassification === 'actualRefund' ? 'selected' : ''}>í™˜ë¶ˆ</option>
                            <option value="monthlyFee" ${currentClassification === 'monthlyFee' ? 'selected' : ''}>ì›”ì´ìš©ë£Œ</option>
                            <option value="exclude" ${currentClassification === 'exclude' ? 'selected' : ''}>ì œì™¸</option>
                        </select>
                    `;
                    
                    row.innerHTML = `
                        <td>${t.date}</td>
                        <td><strong>${t.customer}</strong></td>
                        <td class="amount-positive">${t.type === 'ì…ê¸ˆ' ? 'â‚©' + t.inAmount.toLocaleString() : '-'}</td>
                        <td class="amount-negative">${t.type === 'ì¶œê¸ˆ' ? 'â‚©' + t.outAmount.toLocaleString() : '-'}</td>
                        <td>${autoClassification}</td>
                        <td>${staffClassification}</td>
                        <td><input type="text" placeholder="ë¹„ê³ " style="width: 100px; font-size: 0.8em;"></td>
                        <td><span style="font-size: 0.8em; color: #059669;">ì‹¤ì‹œê°„ ë°˜ì˜</span></td>
                    `;
                    
                    row.setAttribute('data-type', t.type.replace('ê¸ˆ',''));
                    row.setAttribute('data-customer', t.customer);
                    row.setAttribute('data-amount', t.inAmount || t.outAmount);
                    row.setAttribute('data-date', t.date);
                    row.setAttribute('data-id', transactionId);
                    
                    fragment.appendChild(row);
                } catch (error) {
                    console.warn('ê±°ë˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error, t);
                    unclassifiedCount++;
                }
            });
            
            // í•œ ë²ˆì— DOMì— ì¶”ê°€ (ì„±ëŠ¥ ìµœì í™”)
            tbody.appendChild(fragment);
            
            // ë¶„ë¥˜ í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('classifiedCount').textContent = classifiedCount.toLocaleString() + 'ê±´';
            document.getElementById('unclassifiedCount').textContent = unclassifiedCount.toLocaleString() + 'ê±´';
            document.getElementById('tradeClassifiedCount').textContent = tradeClassifiedCount.toLocaleString() + 'ê±´';
            document.getElementById('boutiqueClassifiedCount').textContent = boutiqueClassifiedCount.toLocaleString() + 'ê±´';
            
            console.log('ê±°ë˜ íƒ­ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }
    
        // ì§ì› ë¶„ë¥˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ (ì„±ëŠ¥ ìµœì í™”)
        function updateStaffClassification(transactionId, classification) {
            console.log(`=== ì§ì›ë¶„ë¥˜ ë³€ê²½: ${transactionId} â†’ ${classification} ===`);
            
            // ì§ì› ë¶„ë¥˜ ì €ì¥
            staffClassifications[transactionId] = classification;
            
            // ê±°ë˜ IDì—ì„œ ê³ ê°ëª… ì¶”ì¶œ
            const parts = transactionId.split('_');
            if (parts.length >= 2) {
                const customerName = parts[1];
                console.log(`ê³ ê°ëª…: ${customerName} ì²˜ë¦¬ ì‹œì‘`);
                
                // í•´ë‹¹ ê³ ê°ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if (allCustomers[customerName]) {
                    // ì¦‰ì‹œ í•´ë‹¹ ê³ ê°ë§Œ ì¬ê³„ì‚° (ìµœì í™”)
                    recalculateCustomerDataOnly(allCustomers[customerName]);
                    console.log(`${customerName} ì¬ê³„ì‚° ì™„ë£Œ`);
                    
                    // í•´ë‹¹ ê³ ê°ì´ ê´€ë ¨ëœ í…Œì´ë¸”ë§Œ ì—…ë°ì´íŠ¸ (ì „ì²´ ì—…ë°ì´íŠ¸ ëŒ€ì‹ )
                    updateSpecificCustomerInTables(customerName);
                }
            }
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            saveData();
            
            console.log(`ê±°ë˜ ${transactionId}ì˜ ë¶„ë¥˜ë¥¼ ${classification || 'ìë™ë¶„ë¥˜'}ë¡œ ë³€ê²½ - ì™„ë£Œ`);
            
            // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            const displayClassification = classification || 'ìë™ë¶„ë¥˜';
            const customerName = parts.length >= 2 ? parts[1] : 'ê³ ê°';
            showNotification(`âœ… ${customerName} ë¶„ë¥˜ê°€ ${displayClassification}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }
        
        // íŠ¹ì • ê³ ê°ë§Œ í…Œì´ë¸”ì—ì„œ ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ ìµœì í™”)
        function updateSpecificCustomerInTables(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            // ë³´ì¦ê¸ˆ ê´€ë¦¬ í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ê³ ê° í–‰ë§Œ ì—…ë°ì´íŠ¸
            const depositRows = document.querySelectorAll('#depositsTable tbody tr');
            depositRows.forEach(row => {
                const rowCustomerName = row.cells[0].textContent.trim();
                if (rowCustomerName === customerName) {
                    // í•´ë‹¹ í–‰ë§Œ ì—…ë°ì´íŠ¸
                    row.cells[1].innerHTML = `<span class="amount-negative">â‚©${customer.depositAmount.toLocaleString()}</span>`;
                    row.cells[5].innerHTML = `<span class="amount-positive">â‚©${customer.salesAmount.toLocaleString()}</span>`;
                }
            });
            
            // CEO ëŒ€ì‹œë³´ë“œ ìš”ì•½ ìˆ˜ì¹˜ë§Œ ì—…ë°ì´íŠ¸
            updateHeaderStatsOnly();
        }
        
        // í—¤ë” í†µê³„ë§Œ ì—…ë°ì´íŠ¸ (ë¹ ë¥¸ ì—…ë°ì´íŠ¸)
        function updateHeaderStatsOnly() {
            const nonExcludedCustomers = Object.values(allCustomers).filter(c => !c.excluded);
            const totalSales = nonExcludedCustomers.reduce((sum, c) => sum + c.salesAmount, 0);
            const totalDeposits = nonExcludedCustomers.reduce((sum, c) => sum + c.depositAmount, 0);
            
            document.getElementById('finalSalesAmount').textContent = 'â‚©' + totalSales.toLocaleString();
            
            // CEO ëŒ€ì‹œë³´ë“œ ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
            if (document.getElementById('ceoDashboardTotalSales')) {
                document.getElementById('ceoDashboardTotalSales').textContent = 'â‚©' + totalSales.toLocaleString();
                document.getElementById('ceoDashboardTotalDeposits').textContent = 'â‚©' + totalDeposits.toLocaleString();
            }
        }
        
        // ê°œë³„ ê³ ê°ë§Œ ì¬ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜ (analyzeCustomerData í˜¸ì¶œ ì•ˆ í•¨)
        function recalculateCustomerDataOnly(customer) {
            console.log(`=== ${customer.name} ë‹¨ë… ì¬ê³„ì‚° ì‹œì‘ ===`);
            
            // ì´ìœ ì§„ ë³µì¡í•œ ì¼€ì´ìŠ¤ íŠ¹ë³„ ì²˜ë¦¬
            if (customer.name === 'ì´ìœ ì§„' && specialCases[customer.name] && specialCases[customer.name].type === 'complex_deposit_case') {
                console.log('ì´ìœ ì§„ ë³µì¡í•œ ì¼€ì´ìŠ¤ - íŠ¹ë³„ ì²˜ë¦¬');
                const specialCase = specialCases[customer.name];
                
                // ì‹¤ì œ ë§¤ì¶œ = ì´ ë§¤ì¶œ - í™˜ë¶ˆ ê¸ˆì•¡
                customer.salesAmount = Math.max(0, customer.totalIncome - specialCase.actualRefund);
                customer.salesType = 'trade';
                customer.depositAmount = specialCase.depositAmount;
                customer.depositStatus = 'unreturned';
                customer.returnDate = null;
                
                // ë³µì¡í•œ ì¼€ì´ìŠ¤ ì •ë³´ ì €ì¥
                customer.complexCaseInfo = {
                    originalDeposit: specialCase.depositAmount,
                    monthlyFeeDeduction: specialCase.monthlyFeeDeduction,
                    actualRefund: specialCase.actualRefund,
                    remainingDeposit: Math.max(0, specialCase.depositAmount - specialCase.monthlyFeeDeduction),
                    actualSales: customer.salesAmount
                };
                
                console.log(`ì´ìœ ì§„ ë³µì¡í•œ ì¼€ì´ìŠ¤ ìµœì¢…: ë³´ì¦ê¸ˆ=${customer.depositAmount}, ì‹¤ì œë§¤ì¶œ=${customer.salesAmount}, í™˜ë¶ˆ=${specialCase.actualRefund}`);
                return;
            }
            
            // ì‹ ìˆ˜ì—° ë¶€ë¶„í™˜ê¸‰ íŠ¹ë³„ ì²˜ë¦¬
            if (customer.name === 'ì‹ ìˆ˜ì—°' && specialCases[customer.name] && specialCases[customer.name].type === 'partial_refund') {
                console.log('ì‹ ìˆ˜ì—° ë¶€ë¶„í™˜ê¸‰ ì¼€ì´ìŠ¤ - íŠ¹ë³„ ì²˜ë¦¬');
                const specialCase = specialCases[customer.name];
                
                let manualDepositAmount = 0;
                let manualSalesAmount = 0;
                let hasManualClassification = false;
                
                // ì§ì›ë¶„ë¥˜ í™•ì¸
                customer.transactions.forEach(t => {
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    const staffClass = staffClassifications[tId];
                    
                    if (staffClass) {
                        hasManualClassification = true;
                        console.log(`ê±°ë˜ ${t.date} ${t.inAmount || t.outAmount}: ${staffClass}`);
                        
                        if (staffClass === 'deposit' && t.type === 'ì…ê¸ˆ') {
                            manualDepositAmount += t.inAmount;
                        } else if ((staffClass === 'trade' || staffClass === 'boutique') && t.type === 'ì…ê¸ˆ') {
                            manualSalesAmount += t.inAmount;
                        }
                    }
                });
                
                if (hasManualClassification) {
                    // ë¶€ë¶„í™˜ê¸‰ ì •ë³´ ì ìš©
                    customer.depositAmount = specialCase.remainingDeposit; // ì”ì•¡ 500ë§Œì› (ê³ ì •)
                    customer.salesAmount = manualSalesAmount; // ì§ì›ì´ ë§¤ì¶œë¡œ ë¶„ë¥˜í•œ ê¸ˆì•¡
                    customer.depositStatus = 'unreturned';
                    customer.depositDate = customer.transactions.find(t => t.type === 'ì…ê¸ˆ').date;
                    customer.salesType = 'trade';
                    customer.partialRefundInfo = {
                        totalDeposit: specialCase.totalDeposit,
                        partialRefund: specialCase.partialRefund,
                        refundDate: specialCase.refundDate,
                        remainingDeposit: specialCase.remainingDeposit
                    };
                    
                    console.log(`ì‹ ìˆ˜ì—° ë¶€ë¶„í™˜ê¸‰ ìµœì¢…: ë³´ì¦ê¸ˆ=${customer.depositAmount}, ë§¤ì¶œ=${customer.salesAmount}`);
                    return;
                }
            }
            
            // ì¼ë°˜ ê³ ê° ì²˜ë¦¬
            let manualDepositAmount = 0;
            let manualSalesAmount = 0;
            let manualMonthlyFeeAmount = 0;
            let manualRefundAmount = 0;
            let hasManualClassification = false;
            let depositTransactionDate = null;
            
            // ëª¨ë“  ê±°ë˜ì— ëŒ€í•´ ì§ì› ë¶„ë¥˜ í™•ì¸
            customer.transactions.forEach(t => {
                const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                const staffClass = staffClassifications[tId];
                
                if (staffClass) {
                    hasManualClassification = true;
                    console.log(`ê±°ë˜ ${t.date} ${t.inAmount || t.outAmount}: ${staffClass}`);
                    
                    if (staffClass === 'deposit' && t.type === 'ì…ê¸ˆ') {
                        manualDepositAmount += t.inAmount;
                        if (!depositTransactionDate) depositTransactionDate = t.date;
                    } else if ((staffClass === 'trade' || staffClass === 'boutique') && t.type === 'ì…ê¸ˆ') {
                        manualSalesAmount += t.inAmount;
                    } else if (staffClass === 'monthlyFee') {
                        manualMonthlyFeeAmount += (t.inAmount || t.outAmount || 0);
                    } else if (staffClass === 'refund') {
                        manualRefundAmount += (t.outAmount || t.inAmount || 0);
                    }
                    // excludeëŠ” ì•„ë¬´ê²ƒë„ ë”í•˜ì§€ ì•ŠìŒ
                }
            });
            
            // ì§ì› ë¶„ë¥˜ê°€ ìˆìœ¼ë©´ ì™„ì „íˆ ë®ì–´ì“°ê¸°
            if (hasManualClassification) {
                console.log(`ì§ì›ë¶„ë¥˜ ì ìš©: ë³´ì¦ê¸ˆ=${manualDepositAmount}, ë§¤ì¶œ=${manualSalesAmount}`);
                
                // ê¸°ì¡´ ìë™ë¶„ë¥˜ ë°ì´í„° ì™„ì „ ì´ˆê¸°í™”
                customer.depositAmount = manualDepositAmount;
                // ë³´ì¦ê¸ˆ ì”ì•¡ = ë³´ì¦ê¸ˆ - í™˜ë¶ˆ - ì›”ì´ìš©ë£Œ
                customer.depositAmount = Math.max(0, manualDepositAmount - manualRefundAmount - manualMonthlyFeeAmount);
                customer.salesAmount = manualSalesAmount;
                customer.depositDate = depositTransactionDate;
                
                // ë³´ì¦ê¸ˆ ìƒíƒœ ì¬ì„¤ì •
                if (customer.depositAmount > 0) {
                    customer.depositStatus = 'unreturned';
                } else {
                    customer.depositStatus = 'none';
                    customer.depositDate = null;
                }
                
                // ë§¤ì¶œ íƒ€ì… ê²°ì •
                const hasTradeClass = customer.transactions.some(t => {
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    return staffClassifications[tId] === 'trade';
                });
                const hasBoutiqueClass = customer.transactions.some(t => {
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    return staffClassifications[tId] === 'boutique';
                });
                
                if (hasTradeClass) customer.salesType = 'trade';
                else if (hasBoutiqueClass) customer.salesType = 'boutique';
                else customer.salesType = 'boutique'; // ê¸°ë³¸ê°’
                
                console.log(`${customer.name} ìµœì¢… ê²°ê³¼: ë³´ì¦ê¸ˆ=${customer.depositAmount}, ë§¤ì¶œ=${customer.salesAmount}, íƒ€ì…=${customer.salesType}`);
            }
        }
        
        // ê³ ê°ë³„ ë¶„ë¥˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCustomerClassification(customerName, transactionId, classification, amount) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            // í•´ë‹¹ ê±°ë˜ë¥¼ ì°¾ì•„ì„œ ìˆ˜ë™ ë¶„ë¥˜ í‘œì‹œ ì¶”ê°€
            const transaction = customer.transactions.find(t => {
                const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                return tId === transactionId;
            });
            
            if (transaction) {
                transaction.manualClassification = classification;
            }
            
            // ì§ì› ë¶„ë¥˜ì— ë”°ë¼ ê³ ê° ë°ì´í„° ì™„ì „íˆ ì¬ê³„ì‚°
            recalculateCustomerData(customer);
        }
        
        // ê³ ê° ë°ì´í„° ì™„ì „ ì¬ê³„ì‚° í•¨ìˆ˜
        function recalculateCustomerData(customer) {
            console.log(`=== ${customer.name} ë°ì´í„° ì¬ê³„ì‚° (ì§ì›ë¶„ë¥˜ ìš°ì„ ) ===`);
            
            let manualDepositAmount = 0;
            let manualSalesAmount = 0;
            let manualMonthlyFeeAmount = 0;
            let manualRefundAmount = 0;
            let hasManualClassification = false;
            let depositTransactionDate = null;
            
            // ëª¨ë“  ê±°ë˜ì— ëŒ€í•´ ì§ì› ë¶„ë¥˜ í™•ì¸
            customer.transactions.forEach(t => {
                const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                const staffClass = staffClassifications[tId];
                
                if (staffClass) {
                    hasManualClassification = true;
                    console.log(`ê±°ë˜ ${t.date} ${t.inAmount || t.outAmount}: ${staffClass}`);
                    
                    if (staffClass === 'deposit' && t.type === 'ì…ê¸ˆ') {
                        manualDepositAmount += t.inAmount;
                        if (!depositTransactionDate) depositTransactionDate = t.date;
                    } else if ((staffClass === 'trade' || staffClass === 'boutique') && t.type === 'ì…ê¸ˆ') {
                        manualSalesAmount += t.inAmount;
                    } else if (staffClass === 'monthlyFee') {
                        manualMonthlyFeeAmount += (t.inAmount || t.outAmount || 0);
                    } else if (staffClass === 'refund') {
                        manualRefundAmount += (t.outAmount || t.inAmount || 0);
                    }
                    // excludeëŠ” ì•„ë¬´ê²ƒë„ ë”í•˜ì§€ ì•ŠìŒ
                }
            });
            
            // ì§ì› ë¶„ë¥˜ê°€ ìˆìœ¼ë©´ ì™„ì „íˆ ë®ì–´ì“°ê¸°
            if (hasManualClassification) {
                console.log(`ì§ì›ë¶„ë¥˜ ì ìš©: ë³´ì¦ê¸ˆ=${manualDepositAmount}, ë§¤ì¶œ=${manualSalesAmount}`);
                
                // ê¸°ì¡´ ìë™ë¶„ë¥˜ ë°ì´í„° ì™„ì „ ì´ˆê¸°í™”
                customer.depositAmount = Math.max(0, manualDepositAmount - manualRefundAmount - manualMonthlyFeeAmount);
                customer.salesAmount = manualSalesAmount;
                customer.depositDate = depositTransactionDate;
                
                // ë³´ì¦ê¸ˆ ìƒíƒœ ì¬ì„¤ì •
                if (customer.depositAmount > 0) {
                    customer.depositStatus = 'unreturned';
                } else {
                    customer.depositStatus = 'none';
                    customer.depositDate = null;
                }
                
                // ë§¤ì¶œ íƒ€ì… ê²°ì •
                const hasTradeClass = customer.transactions.some(t => {
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    return staffClassifications[tId] === 'trade';
                });
                const hasBoutiqueClass = customer.transactions.some(t => {
                    const tId = `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`;
                    return staffClassifications[tId] === 'boutique';
                });
                
                if (hasTradeClass) customer.salesType = 'trade';
                else if (hasBoutiqueClass) customer.salesType = 'boutique';
                else customer.salesType = 'boutique'; // ê¸°ë³¸ê°’
                
                console.log(`ìµœì¢… ê²°ê³¼: ë³´ì¦ê¸ˆ=${customer.depositAmount}, ë§¤ì¶œ=${customer.salesAmount}, íƒ€ì…=${customer.salesType}`);
            }
        }
        
        function saveTransactionClassification(transactionId) {
            const selectElement = document.getElementById(`staff_${transactionId}`);
            const noteElement = document.querySelector(`tr[data-id="${transactionId}"] input[type="text"]`);
            
            if (selectElement) {
                const classification = selectElement.value;
                const note = noteElement ? noteElement.value : '';
                
                // ì§ì› ë¶„ë¥˜ ì €ì¥
                staffClassifications[transactionId] = classification;
                
                // ë¹„ê³ ë„ ì €ì¥ (í•„ìš”ì‹œ)
                if (note) {
                    if (!window.transactionNotes) window.transactionNotes = {};
                    window.transactionNotes[transactionId] = note;
                }
                
                // ê±°ë˜ IDì—ì„œ ê³ ê°ëª… ì¶”ì¶œí•˜ì—¬ ë°ì´í„° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                const parts = transactionId.split('_');
                if (parts.length >= 2) {
                    const customerName = parts[1];
                    if (allCustomers[customerName]) {
                        // ì „ì²´ ë°ì´í„° ì¬ë¶„ì„ ë° ëª¨ë“  íƒ­ ì—…ë°ì´íŠ¸
                        analyzeCustomerData();
                        updateAllTabs();
                        
                        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                        saveData();
                        
                        console.log(`âœ… ${customerName} ê±°ë˜ ë¶„ë¥˜ë¥¼ ${classification || 'ìë™ë¶„ë¥˜'}ë¡œ ë³€ê²½í•˜ì—¬ ì „ì²´ì— ë°˜ì˜`);
                        showNotification(`âœ… ${customerName} ê±°ë˜ê°€ ${classification || 'ìë™ë¶„ë¥˜'}ë¡œ ë³€ê²½ë˜ì–´ ëª¨ë“  íƒ­ì— ì¦‰ì‹œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        return;
                    }
                }
            }
            
            showNotification('âœ… ë¶„ë¥˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        function exportClassificationData() {
            const classificationData = {
                timestamp: new Date().toISOString(),
                classifications: []
            };
            
            const blob = new Blob([JSON.stringify(classificationData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ê±°ë˜ë¶„ë¥˜_${new Date().toISOString().substring(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('âœ… ë¶„ë¥˜ ë°ì´í„°ê°€ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
        }
        
        function importClassificationData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            console.log('ë¶„ë¥˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°:', data);
                            showNotification('âœ… ë¶„ë¥˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!');
                        } catch (error) {
                            showNotification('âŒ íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function updateUploadHistory() {
            const historyContainer = document.getElementById('uploadHistory');
            if (uploadHistory.length === 0) {
                historyContainer.innerHTML = '<p style="color: #6b7280;">ì•„ì§ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const historyHTML = uploadHistory.map((upload, index) => `
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${upload.fileName}</strong>
                            <span style="color: #6b7280; margin-left: 10px;">
                                ${upload.uploadTime.toLocaleString()}
                            </span>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #059669;">+${upload.addedCount}ê±´ ì¶”ê°€</div>
                            <div style="font-size: 0.9em; color: #6b7280;">ì´ ${upload.transactionCount}ê±´</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            historyContainer.innerHTML = historyHTML;
        }
    
        function filterTable(filterId) {
            if (filterId.includes('deposit')) {
                const searchInput = document.getElementById('depositSearch');
                const filterSelect = document.getElementById('depositFilter');
                
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const filterValue = filterSelect ? filterSelect.value : 'all';
                
                filterDepositsTable(searchTerm, filterValue);
            } else if (filterId.includes('trade')) {
                const searchInput = document.getElementById('tradeSearch');
                const filterSelect = document.getElementById('tradeFilter');
                
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const filterValue = filterSelect ? filterSelect.value : 'all';
                
                filterTradeTable(searchTerm, filterValue);
            } else if (filterId.includes('boutique')) {
                const searchInput = document.getElementById('boutiqueSearch');
                const filterSelect = document.getElementById('boutiqueFilter');
                
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const filterValue = filterSelect ? filterValue.value : 'all';
                
                filterBoutiqueTable(searchTerm, filterValue);
            } else if (filterId.includes('transaction')) {
                const searchInput = document.getElementById('transactionSearch');
                const filterSelect = document.getElementById('transactionFilter');
                
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const filterValue = filterSelect ? filterSelect.value : 'all';
                
                filterTransactionsTable(searchTerm, filterValue);
            }
        }
    
        function filterDepositsTable(searchTerm, filterValue) {
            const sortValue = document.getElementById('depositSort')?.value || 'deposit_desc';
            const rows = Array.from(document.querySelectorAll('#depositsTable tbody tr'));
            
            // ë¨¼ì € í•„í„°ë§ (ë¹ ë¥¸ ì²˜ë¦¬)
            const visibleRows = rows.filter(row => {
                if (!row.cells || row.cells.length < 2) return false;
                
                const customerName = row.cells[0].textContent.toLowerCase();
                const depositAmountText = row.cells[1].textContent;
                const depositAmount = parseInt(depositAmountText.replace(/[â‚©,]/g, '')) || 0;
                const statusText = row.cells[3]?.textContent || '';
                
                let showRow = true;
                if (searchTerm && !customerName.includes(searchTerm)) showRow = false;
                
                switch (filterValue) {
                    case 'active': if (!statusText.includes('ë¯¸í™˜ê¸‰')) showRow = false; break;
                    case 'returned': if (!statusText.includes('í™˜ê¸‰ì™„ë£Œ')) showRow = false; break;
                    case 'large': if (depositAmount < 5000000) showRow = false; break;
                }
                
                if (showRow) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
                
                return showRow;
            });
            
            // ì •ë ¬ ì ìš© (í‘œì‹œë˜ëŠ” í–‰ë“¤ë§Œ)
            if (visibleRows.length > 0) {
                visibleRows.sort((a, b) => {
                    try {
                        switch (sortValue) {
                            case 'deposit_desc':
                                const amountA = parseInt(a.cells[1].textContent.replace(/[â‚©,]/g, '')) || 0;
                                const amountB = parseInt(b.cells[1].textContent.replace(/[â‚©,]/g, '')) || 0;
                                return amountB - amountA;
                            case 'deposit_asc':
                                const amountA2 = parseInt(a.cells[1].textContent.replace(/[â‚©,]/g, '')) || 0;
                                const amountB2 = parseInt(b.cells[1].textContent.replace(/[â‚©,]/g, '')) || 0;
                                return amountA2 - amountB2;
                            case 'date_desc':
                            case 'deposit_date_desc':
                                const dateA = new Date(a.cells[2].textContent || '1900-01-01');
                                const dateB = new Date(b.cells[2].textContent || '1900-01-01');
                                return dateB - dateA;
                            case 'date_asc':
                            case 'deposit_date_asc':
                                const dateA2 = new Date(a.cells[2].textContent || '1900-01-01');
                                const dateB2 = new Date(b.cells[2].textContent || '1900-01-01');
                                return dateA2 - dateB2;
                            default:
                                return 0;
                        }
                    } catch (error) {
                        console.warn('ì •ë ¬ ì˜¤ë¥˜:', error);
                        return 0;
                    }
                });
                
                // í…Œì´ë¸”ì— ë‹¤ì‹œ ì‚½ì…
                const tbody = document.querySelector('#depositsTable tbody');
                if (tbody) {
                    visibleRows.forEach(row => tbody.appendChild(row));
                }
            }
        }
        
        function filterTradeTable(searchTerm, filterValue) {
            const rows = document.querySelectorAll('#tradeTable tbody tr');
            rows.forEach(row => {
                const customerName = row.cells[0].textContent.toLowerCase();
                const salesAmount = parseInt(row.cells[1].textContent.replace(/[â‚©,]/g, ''));
                
                let showRow = true;
                if (searchTerm && !customerName.includes(searchTerm)) showRow = false;
                
                switch (filterValue) {
                    case 'high': if (salesAmount < 5000000) showRow = false; break;
                    case 'medium': if (salesAmount < 1000000 || salesAmount >= 5000000) showRow = false; break;
                    case 'low': if (salesAmount >= 1000000) showRow = false; break;
                }
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        function filterBoutiqueTable(searchTerm, filterValue) {
            const rows = document.querySelectorAll('#boutiqueTable tbody tr');
            rows.forEach(row => {
                const customerName = row.cells[0].textContent.toLowerCase();
                const salesAmount = parseInt(row.cells[1].textContent.replace(/[â‚©,]/g, ''));
                
                let showRow = true;
                if (searchTerm && !customerName.includes(searchTerm)) showRow = false;
                
                switch (filterValue) {
                    case 'high': if (salesAmount < 2000000) showRow = false; break;
                    case 'medium': if (salesAmount < 500000 || salesAmount >= 2000000) showRow = false; break;
                    case 'low': if (salesAmount >= 500000) showRow = false; break;
                }
                row.style.display = showRow ? '' : 'none';
            });
        }
    
        function filterTransactionsTable(searchTerm, filterValue) {
            const rows = document.querySelectorAll('#transactionsTable tbody tr');
            let visibleCount = 0;
            
            // ë¹ ë¥¸ í•„í„°ë§ (DOM ì¡°ì‘ ìµœì†Œí™”)
            rows.forEach(row => {
                try {
                    const date = row.getAttribute('data-date') || '';
                    const customerName = (row.getAttribute('data-customer') || '').toLowerCase();
                    const type = row.getAttribute('data-type') || '';
                    const amount = parseInt(row.getAttribute('data-amount')) || 0;
                    
                    let showRow = true;
                    
                    // ê²€ìƒ‰ì–´ í•„í„° (ë¹ ë¥¸ ì²´í¬)
                    if (searchTerm && !customerName.includes(searchTerm) && !date.includes(searchTerm)) {
                        showRow = false;
                    }
                    
                    // íƒ€ì… í•„í„°
                    if (showRow) {
                        switch (filterValue) {
                            case 'income': 
                                if (type !== 'ì…') showRow = false; 
                                break;
                            case 'outcome': 
                                if (type !== 'ì¶œ') showRow = false; 
                                break;
                            case 'large': 
                                if (amount < 1000000) showRow = false; 
                                break;
                            case 'recent':
                                const transactionDate = new Date(date);
                                const thirtyDaysAgo = new Date();
                                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                                if (transactionDate < thirtyDaysAgo) showRow = false;
                                break;
                            case 'unclassified':
                                // ë¯¸ë¶„ë¥˜ ì¡°ê±´ ì²´í¬ëŠ” ë” ë³µì¡í•˜ë¯€ë¡œ ìƒëµí•˜ê³  ë¹ ë¥¸ ì²˜ë¦¬
                                break;
                        }
                    }
                    
                    // DOM ì—…ë°ì´íŠ¸ (í•œ ë²ˆë§Œ)
                    if (showRow) {
                        if (row.style.display === 'none') row.style.display = '';
                        visibleCount++;
                    } else {
                        if (row.style.display !== 'none') row.style.display = 'none';
                    }
                } catch (error) {
                    console.warn('í•„í„°ë§ ì˜¤ë¥˜:', error);
                    row.style.display = '';
                }
            });
            
            console.log(`ê±°ë˜ í•„í„°ë§ ì™„ë£Œ: ${visibleCount}/${rows.length}ê±´ í‘œì‹œ`);
        }
            function showTab(tabName) {
                // ëª¨ë“  íƒ­ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // ëª¨ë“  íƒ­ ì½˜í…ì¸ ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // í´ë¦­ëœ íƒ­ì— active í´ë˜ìŠ¤ ì¶”ê°€
                const activeTab = document.querySelector(`.tab[onclick*="'${tabName}'"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                // í•´ë‹¹ íƒ­ ì½˜í…ì¸  í™œì„±í™”
                const activeContent = document.getElementById(tabName);
                if (activeContent) {
                    activeContent.classList.add('active');
                }
                
                // íƒ­ ë³€ê²½ ì‹œ í•„ìš”í•œ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
                if (analysisComplete) {
                    switch(tabName) {
                        case 'ceoDashboard':
                            updateCEODashboard();
                            break;
                        case 'deposits':
                            updateDepositsTab();
                            break;
                        case 'tradeSales':
                            updateTradeSalesTab();
                            break;
                        case 'boutiqueSales':
                            updateBoutiqueSalesTab();
                            break;
                        case 'monthly':
                            updateMonthlyTab();
                            break;
                        case 'transactions':
                            updateTransactionsTab();
                            break;
                    }
                }
            }
    
            function clearData() {
                if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    allTransactions = [];
                    allCustomers = {};
                    uploadHistory = [];
                    staffClassifications = {};
                    analysisComplete = false;
                    
                    localStorage.removeItem(STORAGE_KEY);
                    
                    updateAllTabs();
                    document.getElementById('uploadStatus').innerHTML = '';
                    document.getElementById('analyzeBtn').disabled = true;
                    
                    showNotification('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
    
            function saveData() {
                const dataToSave = {
                    transactions: allTransactions,
                    customers: allCustomers,
                    uploadHistory: uploadHistory,
                    staffClassifications: staffClassifications,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                } catch (error) {
                    console.warn('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                    showNotification('âš ï¸ ë°ì´í„°ê°€ ë„ˆë¬´ ì»¤ì„œ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
            }
    
            function loadStoredData() {
                try {
                    const storedData = localStorage.getItem(STORAGE_KEY);
                    if (storedData) {
                        const data = JSON.parse(storedData);
                        
                        allTransactions = data.transactions || [];
                        allCustomers = data.customers || {};
                        uploadHistory = data.uploadHistory || [];
                        staffClassifications = data.staffClassifications || {};
                        
                        allTransactions.forEach(t => {
                            if (t.parsedDate) t.parsedDate = new Date(t.parsedDate);
                        });
                        
                        Object.values(allCustomers).forEach(customer => {
                            if (customer.firstTransactionDate) customer.firstTransactionDate = new Date(customer.firstTransactionDate);
                            if (customer.lastTransactionDate) customer.lastTransactionDate = new Date(customer.lastTransactionDate);
                            if(customer.transactions) {
                               customer.transactions.forEach(t => { if(t.parsedDate) t.parsedDate = new Date(t.parsedDate) });
                            }
                        });
                        
                        uploadHistory.forEach(upload => {
                            upload.uploadTime = new Date(upload.uploadTime);
                        });
                        
                        if (allTransactions.length > 0) {
                            analysisComplete = true;
                            updateAllTabs();
                            showNotification('ğŸ’¾ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                        }
                    }
                } catch (error) {
                    console.warn('ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    showNotification('âš ï¸ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
            }
    
            function exportData() {
                if (!analysisComplete || allTransactions.length === 0) {
                    showNotification('âŒ ë¨¼ì € ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì„¸ìš”!');
                    return;
                }
                
                const nonExcludedCustomers = Object.values(allCustomers).filter(c => !c.excluded);
                const totalDeposits = nonExcludedCustomers.reduce((sum, c) => sum + c.depositAmount, 0);
                const totalSales = nonExcludedCustomers.reduce((sum, c) => sum + c.salesAmount, 0);
                const excludedAmount = Object.values(allCustomers).filter(c => c.excluded).reduce((sum, c) => sum + c.totalIncome, 0);
                
                const exportData = {
                    timestamp: new Date().toISOString(),
                    summary: {
                        totalTransactions: allTransactions.length,
                        totalCustomers: Object.keys(allCustomers).length,
                        totalIncome: allTransactions.filter(t => t.type === 'ì…ê¸ˆ').reduce((sum, t) => sum + t.inAmount, 0),
                        totalSales: totalSales,
                        totalDeposits: totalDeposits,
                        excludedAmount: excludedAmount,
                    },
                    customers: Object.values(allCustomers)
                        .filter(c => !c.excluded)
                        .map(c => ({
                            name: c.name,
                            totalIncome: c.totalIncome,
                            depositAmount: c.depositAmount,
                            salesAmount: c.salesAmount,
                            depositStatus: c.depositStatus,
                            transactionCount: c.transactions.filter(t => t.type === 'ì…ê¸ˆ').length
                        }))
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ê¹Œì‚¬íŠ¸ë ˆì´ë“œ_ê³„ì¢Œë¶„ì„_${new Date().toISOString().substring(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('âœ… ë¶„ì„ ê²°ê³¼(JSON)ê°€ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
            }
    
            function showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            }
    
            function showProgress(percentage, message) {
                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('progressFill').style.width = percentage + '%';
                document.getElementById('processStatus').textContent = message;
            }
    
            function hideProgress() {
                setTimeout(() => {
                    document.getElementById('progressContainer').style.display = 'none';
                    document.getElementById('processStatus').textContent = '';
                }, 1000);
            }   
    </script>
</body>
</html>
