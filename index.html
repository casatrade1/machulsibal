<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>까사트레이드 계좌분석 시스템</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; 
        }
        .header h1 { margin-bottom: 10px; }
        
        .upload-section { 
            background: white; padding: 25px; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px; 
        }
        .file-drop { 
            border: 2px dashed #d1d5db; border-radius: 10px; padding: 40px 20px; 
            text-align: center; cursor: pointer; transition: all 0.2s; 
        }
        .file-drop:hover { border-color: #2563eb; background: #f8fafc; }
        .file-drop.active { border-color: #059669; background: #f0fdf4; }
        
        .tabs {
            display: flex; background: white; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px; overflow: hidden;
        }
        .tab {
            padding: 15px 20px; background: #f9fafb; border: none; 
            cursor: pointer; font-weight: 500; flex: 1; transition: all 0.2s;
        }
        .tab.active { background: #2563eb; color: white; }
        .tab:hover:not(.active) { background: #e5e7eb; }
        
        .content-section { 
            background: white; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px;
        }
        .section-header { 
            background: #f8fafc; padding: 20px; border-bottom: 1px solid #e5e7eb; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .section-title { font-size: 1.3em; font-weight: bold; color: #1f2937; }
        .section-body { padding: 20px; }
        
        .summary-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; margin-bottom: 25px; 
        }
        .summary-card { 
            background: #f9fafb; padding: 20px; border-radius: 15px; 
            border-left: 4px solid #2563eb; 
        }
        .summary-title { font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .summary-value { color: #2563eb; font-size: 1.3em; font-weight: 600; margin-bottom: 5px; }
        .summary-detail { font-size: 0.9em; color: #6b7280; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { 
            background: #f9fafb; font-weight: 600; color: #374151; 
            position: sticky; top: 0; z-index: 10;
        }
        td { font-size: 14px; }
        
        .amount-positive { color: #059669; font-weight: 600; }
        .amount-negative { color: #dc2626; font-weight: 600; }
        .amount-large { color: #7c3aed; font-weight: bold; }
        
        .status-badge { 
            padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; 
        }
        .status-maintained { background: #f0fdf4; color: #059669; }
        .status-churned { background: #fef2f2; color: #dc2626; }
        .status-refund { background: #fef3c7; color: #d97706; }
        .status-return { background: #dbeafe; color: #2563eb; }
        .status-deposit { background: #fef3c7; color: #d97706; }
        .status-sales { background: #dbeafe; color: #2563eb; }
        .status-boutique { background: #ede9fe; color: #7c3aed; }
        
        .btn {
            background: #2563eb; color: white; border: none; padding: 10px 20px; 
            border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 2000; 
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px; 
            width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto;
        }
        
        .progress-bar {
            width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; 
            overflow: hidden; margin: 20px 0;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #2563eb, #059669); 
            transition: width 0.3s ease; width: 0%;
        }
        
        .customer-row { cursor: pointer; transition: background 0.2s; }
        .customer-row:hover { background: #f9fafb; }
        .customer-row.selected { background: #e0f2fe; }
        
        .classification-controls {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .classification-controls select, .classification-controls input {
            padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏦 까사트레이드 계좌분석 시스템</h1>
            <p>엑셀 파일 업로드로 자동 고객 분류 및 매출 분석</p>
        </div>

        <div class="upload-section">
            <div class="file-drop" id="fileDrop">
                <div style="font-size: 2em; margin-bottom: 10px;">📁</div>
                <div style="font-size: 1.2em; margin-bottom: 5px;">엑셀 파일을 드래그하거나 클릭하여 업로드</div>
                <div style="color: #6b7280;">.xls, .xlsx 파일만 지원</div>
                <input type="file" id="fileInput" accept=".xls,.xlsx" style="display: none;">
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText" style="text-align: center; margin-top: 10px; display: none;"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">📊 전체 개요</button>
            <button class="tab" onclick="showTab('customers')">👥 고객 관리</button>
            <button class="tab" onclick="showTab('tradesales')">💼 트레이드 매출</button>
            <button class="tab" onclick="showTab('boutiquesales')">🛍️ 부티크 매출</button>
            <button class="tab" onclick="showTab('deposits')">💰 보증금 관리</button>
        </div>

        <!-- 전체 개요 탭 -->
        <div id="overviewTab" class="content-section">
            <div class="section-header">
                <h2 class="section-title">📊 전체 개요</h2>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="overviewGrid">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>
        </div>

        <!-- 고객 관리 탭 -->
        <div id="customersTab" class="content-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">👥 고객 관리</h2>
                <div class="classification-controls">
                    <select id="customerFilter">
                        <option value="all">전체 고객</option>
                        <option value="trade">트레이드 고객</option>
                        <option value="boutique">부티크 고객</option>
                        <option value="maintained">유지고객</option>
                        <option value="churned">이탈고객</option>
                    </select>
                    <input type="text" id="customerSearch" placeholder="고객명 검색...">
                    <button class="btn" onclick="exportCustomerData()">📊 JSON 내보내기</button>
                    <button class="btn" onclick="exportToExcel()">📈 엑셀 내보내기</button>
                    <button class="btn" onclick="showCustomerMergeModal()" style="background: #7c3aed;">🔗 고객 통합</button>
                    <button class="btn" onclick="createSampleData()" style="background: #059669;">🧪 샘플 데이터</button>
                </div>
            </div>
            <div class="section-body">
                <table>
                    <thead>
                        <tr>
                            <th>고객명</th>
                            <th>분류</th>
                            <th>보증금</th>
                            <th>매출액</th>
                            <th>상태</th>
                            <th>거래수</th>
                            <th>최근거래</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="customersTable">
                        <!-- 동적으로 생성됨 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 트레이드 매출 탭 -->
        <div id="tradesalesTab" class="content-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">💼 트레이드 매출 (보증금 제외)</h2>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="tradeSalesGrid">
                    <!-- 동적으로 생성됨 -->
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>고객명</th>
                            <th>거래일</th>
                            <th>금액</th>
                            <th>분류</th>
                        </tr>
                    </thead>
                    <tbody id="tradeSalesTable">
                        <!-- 동적으로 생성됨 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 부티크 매출 탭 -->
        <div id="boutiquesalesTab" class="content-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">🛍️ 부티크 매출</h2>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="boutiqueSalesGrid">
                    <!-- 동적으로 생성됨 -->
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>고객명</th>
                            <th>거래일</th>
                            <th>금액</th>
                            <th>분류</th>
                        </tr>
                    </thead>
                    <tbody id="boutiqueSalesTable">
                        <!-- 동적으로 생성됨 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 보증금 관리 탭 -->
        <div id="depositsTab" class="content-section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">💰 보증금 관리</h2>
            </div>
            <div class="section-body">
                <div class="summary-grid" id="depositsGrid">
                    <!-- 동적으로 생성됨 -->
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>고객명</th>
                            <th>보증금</th>
                            <th>환급액</th>
                            <th>상태</th>
                            <th>차액</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody id="depositsTable">
                        <!-- 동적으로 생성됨 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 전역 데이터 저장소
        let allTransactions = [];
        let allCustomers = {};
        let customerMerges = {}; // 고객 통합 정보
        let manualClassifications = {}; // 수동 분류 정보

        // 보증금 금액 패턴 (깔끔한 금액)
        const DEPOSIT_AMOUNTS = [500000, 1000000, 2000000, 3000000, 5000000];

        // 파일 업로드 처리
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('fileDrop').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileDrop').addEventListener('dragover', (e) => {
            e.preventDefault();
            document.getElementById('fileDrop').classList.add('active');
        });
        document.getElementById('fileDrop').addEventListener('dragleave', () => {
            document.getElementById('fileDrop').classList.remove('active');
        });
        document.getElementById('fileDrop').addEventListener('drop', (e) => {
            e.preventDefault();
            document.getElementById('fileDrop').classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.match(/\.(xls|xlsx)$/)) {
                alert('엑셀 파일만 업로드 가능합니다.');
                return;
            }

            showProgress(0, '파일 읽는 중...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    showProgress(30, '거래 내역 분석 중...');
                    parseTransactionData(jsonData);
                    
                    showProgress(60, '고객 분류 중...');
                    classifyCustomers();
                    
                    showProgress(80, '데이터 통합 중...');
                    mergeCustomers();
                    
                    showProgress(100, '분석 완료!');
                    updateAllTabs();
                    
                    setTimeout(() => {
                        document.getElementById('progressBar').style.display = 'none';
                        document.getElementById('progressText').style.display = 'none';
                    }, 1000);
                    
                } catch (error) {
                    console.error('파일 처리 오류:', error);
                    alert('파일 처리 중 오류가 발생했습니다.');
                    hideProgress();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showProgress(percent, text) {
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('progressText').style.display = 'block';
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('progressText').style.display = 'none';
        }

        function parseTransactionData(jsonData) {
            allTransactions = [];
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length < 4) continue;
                
                let date = row[0];
                const customer = row[1];
                const inAmount = row[2] ? parseFloat(row[2]) : 0;
                const outAmount = row[3] ? parseFloat(row[3]) : 0;
                
                if (!date || !customer) continue;
                
                // 날짜 형식 처리
                let parsedDate;
                if (typeof date === 'number') {
                    // 엑셀 날짜 숫자 형식 (1900년 기준)
                    parsedDate = new Date((date - 25569) * 86400 * 1000);
                } else if (typeof date === 'string') {
                    // 문자열 날짜
                    parsedDate = new Date(date);
                } else {
                    parsedDate = new Date(date);
                }
                
                // 유효하지 않은 날짜 처리
                if (isNaN(parsedDate.getTime())) {
                    console.warn('유효하지 않은 날짜:', date);
                    continue;
                }
                
                const transaction = {
                    id: `${date}_${customer}_${inAmount || outAmount}`,
                    date: date,
                    customer: customer.toString().trim(),
                    inAmount: inAmount || 0,
                    outAmount: outAmount || 0,
                    type: inAmount > 0 ? '입금' : '출금',
                    parsedDate: parsedDate
                };
                
                allTransactions.push(transaction);
            }
            
            // 날짜순 정렬
            allTransactions.sort((a, b) => b.parsedDate - a.parsedDate);
            console.log('파싱된 거래 수:', allTransactions.length);
        }

        function classifyCustomers() {
            allCustomers = {};
            
            allTransactions.forEach(transaction => {
                const customer = transaction.customer;
                
                if (!allCustomers[customer]) {
                    allCustomers[customer] = {
                        name: customer,
                        transactions: [],
                        totalIncome: 0,
                        totalOutcome: 0,
                        depositAmount: 0,
                        salesAmount: 0,
                        depositDate: null,
                        refundAmount: 0,
                        refundDate: null,
                        status: 'unknown',
                        classification: 'unknown',
                        firstTransactionDate: null,
                        lastTransactionDate: null
                    };
                }
                
                const customerData = allCustomers[customer];
                customerData.transactions.push(transaction);
                
                if (transaction.type === '입금') {
                    customerData.totalIncome += transaction.inAmount;
                } else {
                    customerData.totalOutcome += transaction.outAmount;
                }
                
                if (!customerData.firstTransactionDate || transaction.parsedDate < customerData.firstTransactionDate) {
                    customerData.firstTransactionDate = transaction.parsedDate;
                }
                if (!customerData.lastTransactionDate || transaction.parsedDate > customerData.lastTransactionDate) {
                    customerData.lastTransactionDate = transaction.parsedDate;
                }
            });
            
            // 고객별 분류
            Object.values(allCustomers).forEach(customer => {
                classifyCustomer(customer);
            });
        }

        function classifyCustomer(customer) {
            // 수동 분류가 있으면 우선 적용
            if (manualClassifications[customer.name] && manualClassifications[customer.name].modified) {
                const manual = manualClassifications[customer.name];
                customer.classification = manual.classification || customer.classification;
                customer.status = manual.status || customer.status;
                customer.depositAmount = manual.depositAmount !== undefined ? manual.depositAmount : customer.depositAmount;
                customer.refundAmount = manual.refundAmount !== undefined ? manual.refundAmount : customer.refundAmount;
                customer.salesAmount = manual.salesAmount !== undefined ? manual.salesAmount : customer.salesAmount;
                if (manual.refundDate) customer.refundDate = manual.refundDate;
                return;
            }
            
            const incomeTransactions = customer.transactions.filter(t => t.type === '입금');
            const outcomeTransactions = customer.transactions.filter(t => t.type === '출금');
            
            // 보증금 찾기 (깔끔한 금액의 첫 입금)
            let depositTransaction = null;
            for (let transaction of incomeTransactions) {
                if (DEPOSIT_AMOUNTS.includes(transaction.inAmount)) {
                    depositTransaction = transaction;
                    break;
                }
            }
            
            if (depositTransaction) {
                customer.depositAmount = depositTransaction.inAmount;
                customer.depositDate = depositTransaction.date;
                customer.classification = 'trade';
                
                // 보증금 제외한 매출 계산
                customer.salesAmount = incomeTransactions
                    .filter(t => t !== depositTransaction)
                    .reduce((sum, t) => sum + t.inAmount, 0);
                
                // 환급 확인
                const refundTransaction = outcomeTransactions.find(t => 
                    Math.abs(t.outAmount - customer.depositAmount) < 1000
                );
                
                if (refundTransaction) {
                    customer.refundAmount = refundTransaction.outAmount;
                    customer.refundDate = refundTransaction.date;
                    
                    if (refundTransaction.outAmount >= customer.depositAmount * 0.95) {
                        customer.status = 'churned'; // 이탈고객
                    } else {
                        customer.status = 'refund'; // 환불
                    }
                } else {
                    customer.status = 'maintained'; // 유지고객
                }
            } else {
                // 보증금이 없으면 부티크 고객
                customer.classification = 'boutique';
                customer.salesAmount = customer.totalIncome;
                customer.status = 'boutique';
            }
        }

        function mergeCustomers() {
            // 유사한 이름 자동 인식 및 통합
            const customerNames = Object.keys(allCustomers);
            
            for (let i = 0; i < customerNames.length; i++) {
                for (let j = i + 1; j < customerNames.length; j++) {
                    const name1 = customerNames[i];
                    const name2 = customerNames[j];
                    
                    if (isSimilarName(name1, name2)) {
                        mergeCustomerData(name1, name2);
                    }
                }
            }
        }

        function isSimilarName(name1, name2) {
            // 괄호 제거 후 비교
            const clean1 = name1.replace(/\([^)]*\)/g, '').trim();
            const clean2 = name2.replace(/\([^)]*\)/g, '').trim();
            
            // 완전 일치
            if (clean1 === clean2) return true;
            
            // 부분 일치 (한쪽이 다른 쪽을 포함)
            if (clean1.includes(clean2) || clean2.includes(clean1)) return true;
            
            // 유사도 계산 (간단한 버전)
            const similarity = calculateSimilarity(clean1, clean2);
            return similarity > 0.7;
        }

        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        function mergeCustomerData(mainCustomer, mergeCustomer) {
            const main = allCustomers[mainCustomer];
            const merge = allCustomers[mergeCustomer];
            
            if (!main || !merge) return;
            
            // 메인 고객에 병합
            main.transactions = [...main.transactions, ...merge.transactions];
            main.totalIncome += merge.totalIncome;
            main.totalOutcome += merge.totalOutcome;
            main.salesAmount += merge.salesAmount;
            
            // 보증금이 더 큰 쪽으로 설정
            if (merge.depositAmount > main.depositAmount) {
                main.depositAmount = merge.depositAmount;
                main.depositDate = merge.depositDate;
            }
            
            // 환급 정보 업데이트
            if (merge.refundAmount > 0) {
                main.refundAmount += merge.refundAmount;
                if (!main.refundDate || (merge.refundDate && merge.refundDate > main.refundDate)) {
                    main.refundDate = merge.refundDate;
                }
            }
            
            // 날짜 업데이트
            if (merge.firstTransactionDate < main.firstTransactionDate) {
                main.firstTransactionDate = merge.firstTransactionDate;
            }
            if (merge.lastTransactionDate > main.lastTransactionDate) {
                main.lastTransactionDate = merge.lastTransactionDate;
            }
            
            // 거래 정렬
            main.transactions.sort((a, b) => b.parsedDate - a.parsedDate);
            
            // 병합된 고객 제거
            delete allCustomers[mergeCustomer];
            
            // 고객 통합 정보 저장
            if (!customerMerges[mainCustomer]) {
                customerMerges[mainCustomer] = [];
            }
            customerMerges[mainCustomer].push(mergeCustomer);
        }

        function updateAllTabs() {
            console.log('=== 탭 업데이트 시작 ===');
            console.log('전체 고객 수:', Object.keys(allCustomers).length);
            console.log('전체 거래 수:', allTransactions.length);
            
            updateOverviewTab();
            updateCustomersTab();
            updateTradeSalesTab();
            updateBoutiqueSalesTab();
            updateDepositsTab();
            
            console.log('=== 탭 업데이트 완료 ===');
        }

        function updateOverviewTab() {
            const totalCustomers = Object.keys(allCustomers).length;
            const tradeCustomers = Object.values(allCustomers).filter(c => c.classification === 'trade').length;
            const boutiqueCustomers = Object.values(allCustomers).filter(c => c.classification === 'boutique').length;
            const maintainedCustomers = Object.values(allCustomers).filter(c => c.status === 'maintained').length;
            const churnedCustomers = Object.values(allCustomers).filter(c => c.status === 'churned').length;
            
            const totalSales = Object.values(allCustomers).reduce((sum, c) => sum + (c.salesAmount || 0), 0);
            const totalDeposits = Object.values(allCustomers).reduce((sum, c) => sum + (c.depositAmount || 0), 0);
            const totalRefunds = Object.values(allCustomers).reduce((sum, c) => sum + (c.refundAmount || 0), 0);
            
            document.getElementById('overviewGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">총 고객수</div>
                    <div class="summary-value">${totalCustomers.toLocaleString()}명</div>
                    <div class="summary-detail">트레이드: ${tradeCustomers}명, 부티크: ${boutiqueCustomers}명</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">총 매출액</div>
                    <div class="summary-value">₩${totalSales.toLocaleString()}</div>
                    <div class="summary-detail">보증금 제외</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">총 보증금</div>
                    <div class="summary-value">₩${totalDeposits.toLocaleString()}</div>
                    <div class="summary-detail">환급액: ₩${totalRefunds.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">고객 상태</div>
                    <div class="summary-value">유지: ${maintainedCustomers}명</div>
                    <div class="summary-detail">이탈: ${churnedCustomers}명</div>
                </div>
            `;
        }

        function updateCustomersTab() {
            const customers = Object.values(allCustomers);
            const filter = document.getElementById('customerFilter').value;
            const search = document.getElementById('customerSearch').value.toLowerCase();
            
            let filteredCustomers = customers;
            
            if (filter !== 'all') {
                filteredCustomers = customers.filter(c => {
                    if (filter === 'trade') return c.classification === 'trade';
                    if (filter === 'boutique') return c.classification === 'boutique';
                    if (filter === 'maintained') return c.status === 'maintained';
                    if (filter === 'churned') return c.status === 'churned';
                    return true;
                });
            }
            
            if (search) {
                filteredCustomers = filteredCustomers.filter(c => 
                    c.name.toLowerCase().includes(search)
                );
            }
            
            const tbody = document.getElementById('customersTable');
            tbody.innerHTML = '';
            
            if (filteredCustomers.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="8" style="text-align: center; padding: 20px; color: #6b7280;">데이터가 없습니다. 엑셀 파일을 업로드하거나 샘플 데이터를 로드해주세요.</td>';
                return;
            }
            
            filteredCustomers.forEach(customer => {
                const row = tbody.insertRow();
                row.className = 'customer-row';
                
                const statusBadge = getStatusBadge(customer);
                const classificationBadge = getClassificationBadge(customer);
                
                // 날짜 형식 처리
                let lastTransactionDate = '-';
                if (customer.lastTransactionDate && !isNaN(customer.lastTransactionDate.getTime())) {
                    lastTransactionDate = customer.lastTransactionDate.toLocaleDateString('ko-KR');
                }
                
                // 고객명 안전 처리
                const customerName = customer.name || '알 수 없음';
                
                row.innerHTML = `
                    <td>${customerName}</td>
                    <td>${classificationBadge}</td>
                    <td class="amount-positive">₩${(customer.depositAmount || 0).toLocaleString()}</td>
                    <td class="amount-positive">₩${(customer.salesAmount || 0).toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td>${customer.transactions.length}건</td>
                    <td>${lastTransactionDate}</td>
                    <td>
                        <button class="btn" onclick="editCustomer('${customerName.replace(/'/g, "\\'")}')">수정</button>
                    </td>
                `;
            });
        }

        function getStatusBadge(customer) {
            switch (customer.status) {
                case 'maintained': return '<span class="status-badge status-maintained">유지고객</span>';
                case 'churned': return '<span class="status-badge status-churned">이탈고객</span>';
                case 'refund': return '<span class="status-badge status-refund">환불</span>';
                case 'boutique': return '<span class="status-badge status-boutique">부티크</span>';
                default: return '<span class="status-badge">미분류</span>';
            }
        }

        function getClassificationBadge(customer) {
            switch (customer.classification) {
                case 'trade': return '<span class="status-badge status-sales">트레이드</span>';
                case 'boutique': return '<span class="status-badge status-boutique">부티크</span>';
                default: return '<span class="status-badge">미분류</span>';
            }
        }

        function updateTradeSalesTab() {
            const tradeTransactions = allTransactions.filter(t => {
                const customer = allCustomers[t.customer];
                if (!customer || customer.classification !== 'trade') return false;
                if (t.type !== '입금') return false;
                
                // 보증금 거래 제외
                if (customer.depositAmount > 0 && t.inAmount === customer.depositAmount) return false;
                
                return true;
            });
            
            const totalAmount = tradeTransactions.reduce((sum, t) => sum + t.inAmount, 0);
            const avgAmount = tradeTransactions.length > 0 ? Math.round(totalAmount / tradeTransactions.length) : 0;
            
            document.getElementById('tradeSalesGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">트레이드 매출 총액</div>
                    <div class="summary-value">₩${totalAmount.toLocaleString()}</div>
                    <div class="summary-detail">보증금 제외</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">거래 건수</div>
                    <div class="summary-value">${tradeTransactions.length}건</div>
                    <div class="summary-detail">평균: ₩${avgAmount.toLocaleString()}</div>
                </div>
            `;
            
            const tbody = document.getElementById('tradeSalesTable');
            tbody.innerHTML = '';
            
            if (tradeTransactions.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="4" style="text-align: center; padding: 20px; color: #6b7280;">트레이드 매출 데이터가 없습니다.</td>';
                return;
            }
            
            tradeTransactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.customer || '알 수 없음'}</td>
                    <td>${transaction.date || '-'}</td>
                    <td class="amount-positive">₩${(transaction.inAmount || 0).toLocaleString()}</td>
                    <td><span class="status-badge status-sales">트레이드</span></td>
                `;
            });
        }

        function updateBoutiqueSalesTab() {
            const boutiqueTransactions = allTransactions.filter(t => {
                const customer = allCustomers[t.customer];
                return customer && customer.classification === 'boutique' && t.type === '입금';
            });
            
            const totalAmount = boutiqueTransactions.reduce((sum, t) => sum + t.inAmount, 0);
            const avgAmount = boutiqueTransactions.length > 0 ? Math.round(totalAmount / boutiqueTransactions.length) : 0;
            
            document.getElementById('boutiqueSalesGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">부티크 매출 총액</div>
                    <div class="summary-value">₩${totalAmount.toLocaleString()}</div>
                    <div class="summary-detail">1회성 고객</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">거래 건수</div>
                    <div class="summary-value">${boutiqueTransactions.length}건</div>
                    <div class="summary-detail">평균: ₩${avgAmount.toLocaleString()}</div>
                </div>
            `;
            
            const tbody = document.getElementById('boutiqueSalesTable');
            tbody.innerHTML = '';
            
            if (boutiqueTransactions.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="4" style="text-align: center; padding: 20px; color: #6b7280;">부티크 매출 데이터가 없습니다.</td>';
                return;
            }
            
            boutiqueTransactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.customer || '알 수 없음'}</td>
                    <td>${transaction.date || '-'}</td>
                    <td class="amount-positive">₩${(transaction.inAmount || 0).toLocaleString()}</td>
                    <td><span class="status-badge status-boutique">부티크</span></td>
                `;
            });
        }

        function updateDepositsTab() {
            const depositCustomers = Object.values(allCustomers).filter(c => c.depositAmount > 0);
            
            const totalDeposits = depositCustomers.reduce((sum, c) => sum + c.depositAmount, 0);
            const totalRefunds = depositCustomers.reduce((sum, c) => sum + c.refundAmount, 0);
            const maintainedDeposits = depositCustomers.filter(c => c.status === 'maintained').reduce((sum, c) => sum + c.depositAmount, 0);
            
            const refundRate = totalDeposits > 0 ? Math.round(totalRefunds / totalDeposits * 100) : 0;
            
            document.getElementById('depositsGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-title">총 보증금</div>
                    <div class="summary-value">₩${totalDeposits.toLocaleString()}</div>
                    <div class="summary-detail">${depositCustomers.length}명</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">총 환급액</div>
                    <div class="summary-value">₩${totalRefunds.toLocaleString()}</div>
                    <div class="summary-detail">환급률: ${refundRate}%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">유지 보증금</div>
                    <div class="summary-value">₩${maintainedDeposits.toLocaleString()}</div>
                    <div class="summary-detail">미환급</div>
                </div>
            `;
            
            const tbody = document.getElementById('depositsTable');
            tbody.innerHTML = '';
            
            if (depositCustomers.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px; color: #6b7280;">보증금 데이터가 없습니다.</td>';
                return;
            }
            
            depositCustomers.forEach(customer => {
                const row = tbody.insertRow();
                const difference = customer.depositAmount - customer.refundAmount;
                const statusBadge = getStatusBadge(customer);
                const customerName = customer.name || '알 수 없음';
                
                row.innerHTML = `
                    <td>${customerName}</td>
                    <td class="amount-positive">₩${(customer.depositAmount || 0).toLocaleString()}</td>
                    <td class="amount-negative">₩${(customer.refundAmount || 0).toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td class="${difference > 0 ? 'amount-positive' : 'amount-negative'}">₩${difference.toLocaleString()}</td>
                    <td>
                        <button class="btn" onclick="editDeposit('${customerName.replace(/'/g, "\\'")}')">수정</button>
                    </td>
                `;
            });
        }

        function showTab(tabName) {
            // 모든 탭 숨기기
            document.querySelectorAll('.content-section').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 선택된 탭 보이기
            document.getElementById(tabName + 'Tab').style.display = 'block';
            event.target.classList.add('active');
        }

        function editCustomer(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            showCustomerEditModal(customer);
        }

        function editDeposit(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            showDepositEditModal(customer);
        }

        function showCustomerEditModal(customer) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>고객 정보 수정: ${customer.name}</h3>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">분류</label>
                        <select id="editClassification" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                            <option value="trade" ${customer.classification === 'trade' ? 'selected' : ''}>트레이드</option>
                            <option value="boutique" ${customer.classification === 'boutique' ? 'selected' : ''}>부티크</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">상태</label>
                        <select id="editStatus" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                            <option value="maintained" ${customer.status === 'maintained' ? 'selected' : ''}>유지고객</option>
                            <option value="churned" ${customer.status === 'churned' ? 'selected' : ''}>이탈고객</option>
                            <option value="refund" ${customer.status === 'refund' ? 'selected' : ''}>환불</option>
                            <option value="boutique" ${customer.status === 'boutique' ? 'selected' : ''}>부티크</option>
                        </select>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">보증금 (수동 설정)</label>
                        <input type="number" id="editDepositAmount" value="${customer.depositAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">환급액 (수동 설정)</label>
                        <input type="number" id="editRefundAmount" value="${customer.refundAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">매출액 (수동 설정)</label>
                        <input type="number" id="editSalesAmount" value="${customer.salesAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                        <button class="btn" onclick="saveCustomerEdit('${customer.name}')">저장</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function showDepositEditModal(customer) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>보증금 관리: ${customer.name}</h3>
                    
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h4>현재 정보</h4>
                        <p><strong>보증금:</strong> ₩${customer.depositAmount.toLocaleString()}</p>
                        <p><strong>환급액:</strong> ₩${customer.refundAmount.toLocaleString()}</p>
                        <p><strong>차액:</strong> ₩${(customer.depositAmount - customer.refundAmount).toLocaleString()}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">보증금 수정</label>
                        <input type="number" id="editDepositAmount" value="${customer.depositAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">환급액 수정</label>
                        <input type="number" id="editRefundAmount" value="${customer.refundAmount}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">환급일</label>
                        <input type="date" id="editRefundDate" value="${customer.refundDate || ''}" 
                               style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">상태</label>
                        <select id="editDepositStatus" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                            <option value="maintained" ${customer.status === 'maintained' ? 'selected' : ''}>유지고객</option>
                            <option value="churned" ${customer.status === 'churned' ? 'selected' : ''}>이탈고객</option>
                            <option value="refund" ${customer.status === 'refund' ? 'selected' : ''}>환불</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                        <button class="btn" onclick="saveDepositEdit('${customer.name}')">저장</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function saveCustomerEdit(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            const classification = document.getElementById('editClassification').value;
            const status = document.getElementById('editStatus').value;
            const depositAmount = parseInt(document.getElementById('editDepositAmount').value) || 0;
            const refundAmount = parseInt(document.getElementById('editRefundAmount').value) || 0;
            const salesAmount = parseInt(document.getElementById('editSalesAmount').value) || 0;
            
            // 수동 분류 정보 저장
            manualClassifications[customerName] = {
                classification: classification,
                status: status,
                depositAmount: depositAmount,
                refundAmount: refundAmount,
                salesAmount: salesAmount,
                modified: true
            };
            
            // 고객 정보 업데이트
            customer.classification = classification;
            customer.status = status;
            customer.depositAmount = depositAmount;
            customer.refundAmount = refundAmount;
            customer.salesAmount = salesAmount;
            
            closeModal();
            updateAllTabs();
            
            showNotification('✅ 고객 정보가 수정되었습니다.');
        }

        function saveDepositEdit(customerName) {
            const customer = allCustomers[customerName];
            if (!customer) return;
            
            const depositAmount = parseInt(document.getElementById('editDepositAmount').value) || 0;
            const refundAmount = parseInt(document.getElementById('editRefundAmount').value) || 0;
            const refundDate = document.getElementById('editRefundDate').value;
            const status = document.getElementById('editDepositStatus').value;
            
            // 수동 분류 정보 저장
            if (!manualClassifications[customerName]) {
                manualClassifications[customerName] = {};
            }
            manualClassifications[customerName].depositAmount = depositAmount;
            manualClassifications[customerName].refundAmount = refundAmount;
            manualClassifications[customerName].refundDate = refundDate;
            manualClassifications[customerName].status = status;
            manualClassifications[customerName].modified = true;
            
            // 고객 정보 업데이트
            customer.depositAmount = depositAmount;
            customer.refundAmount = refundAmount;
            customer.refundDate = refundDate;
            customer.status = status;
            
            closeModal();
            updateAllTabs();
            
            showNotification('✅ 보증금 정보가 수정되었습니다.');
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #059669; color: white;
                padding: 15px 20px; border-radius: 8px; z-index: 3000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function exportCustomerData() {
            const data = {
                customers: allCustomers,
                transactions: allTransactions,
                manualClassifications: manualClassifications,
                customerMerges: customerMerges,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `casa_trade_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('✅ 데이터가 내보내기되었습니다.');
        }

        function exportToExcel() {
            // 엑셀 형식으로 내보내기
            const workbook = XLSX.utils.book_new();
            
            // 고객 데이터 시트
            const customerData = Object.values(allCustomers).map(customer => ({
                '고객명': customer.name,
                '분류': customer.classification === 'trade' ? '트레이드' : '부티크',
                '상태': getStatusText(customer.status),
                '보증금': customer.depositAmount,
                '환급액': customer.refundAmount,
                '매출액': customer.salesAmount,
                '총입금': customer.totalIncome,
                '총출금': customer.totalOutcome,
                '거래수': customer.transactions.length,
                '첫거래일': customer.firstTransactionDate ? customer.firstTransactionDate.toLocaleDateString() : '',
                '최근거래일': customer.lastTransactionDate ? customer.lastTransactionDate.toLocaleDateString() : ''
            }));
            
            const customerSheet = XLSX.utils.json_to_sheet(customerData);
            XLSX.utils.book_append_sheet(workbook, customerSheet, '고객데이터');
            
            // 트레이드 매출 시트
            const tradeTransactions = allTransactions.filter(t => {
                const customer = allCustomers[t.customer];
                return customer && customer.classification === 'trade' && t.type === '입금' && 
                       !(customer.depositAmount > 0 && t.inAmount === customer.depositAmount);
            });
            
            const tradeData = tradeTransactions.map(t => ({
                '고객명': t.customer,
                '거래일': t.date,
                '금액': t.inAmount,
                '분류': '트레이드'
            }));
            
            const tradeSheet = XLSX.utils.json_to_sheet(tradeData);
            XLSX.utils.book_append_sheet(workbook, tradeSheet, '트레이드매출');
            
            // 부티크 매출 시트
            const boutiqueTransactions = allTransactions.filter(t => {
                const customer = allCustomers[t.customer];
                return customer && customer.classification === 'boutique' && t.type === '입금';
            });
            
            const boutiqueData = boutiqueTransactions.map(t => ({
                '고객명': t.customer,
                '거래일': t.date,
                '금액': t.inAmount,
                '분류': '부티크'
            }));
            
            const boutiqueSheet = XLSX.utils.json_to_sheet(boutiqueData);
            XLSX.utils.book_append_sheet(workbook, boutiqueSheet, '부티크매출');
            
            // 보증금 관리 시트
            const depositData = Object.values(allCustomers)
                .filter(c => c.depositAmount > 0)
                .map(customer => ({
                    '고객명': customer.name,
                    '보증금': customer.depositAmount,
                    '환급액': customer.refundAmount,
                    '차액': customer.depositAmount - customer.refundAmount,
                    '상태': getStatusText(customer.status),
                    '환급일': customer.refundDate || ''
                }));
            
            const depositSheet = XLSX.utils.json_to_sheet(depositData);
            XLSX.utils.book_append_sheet(workbook, depositSheet, '보증금관리');
            
            // 파일 다운로드
            XLSX.writeFile(workbook, `casa_trade_analysis_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('✅ 엑셀 파일이 다운로드되었습니다.');
        }

        function getStatusText(status) {
            switch (status) {
                case 'maintained': return '유지고객';
                case 'churned': return '이탈고객';
                case 'refund': return '환불';
                case 'boutique': return '부티크';
                default: return '미분류';
            }
        }

        function showCustomerMergeModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>🔗 고객 통합 (같은 사람을 하나로 합치기)</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        예: "김규"와 "김규낙찰금"처럼 같은 사람이지만 다른 이름으로 거래한 경우
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">병합할 고객 1 (메인)</label>
                            <select id="mergeCustomer1" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                                <option value="">고객 선택...</option>
                                ${Object.keys(allCustomers).map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                            <div id="customer1Info" style="font-size: 0.8em; color: #6b7280; margin-top: 5px;"></div>
                        </div>
                        
                        <div style="text-align: center; font-size: 1.5em; color: #7c3aed;">→</div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">병합할 고객 2 (병합됨)</label>
                            <select id="mergeCustomer2" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px;">
                                <option value="">고객 선택...</option>
                                ${Object.keys(allCustomers).map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                            <div id="customer2Info" style="font-size: 0.8em; color: #6b7280; margin-top: 5px;"></div>
                        </div>
                    </div>
                    
                    <div id="mergePreview" style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
                        <h4 style="margin-bottom: 10px;">병합 미리보기:</h4>
                        <div id="mergePreviewContent"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                        <button class="btn" onclick="executeCustomerMerge()" id="executeMergeBtn" disabled>병합 실행</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 고객 선택 시 정보 표시
            document.getElementById('mergeCustomer1').addEventListener('change', updateMergePreview);
            document.getElementById('mergeCustomer2').addEventListener('change', updateMergePreview);
        }

        function updateMergePreview() {
            const customer1Name = document.getElementById('mergeCustomer1').value;
            const customer2Name = document.getElementById('mergeCustomer2').value;
            
            const customer1Info = document.getElementById('customer1Info');
            const customer2Info = document.getElementById('customer2Info');
            const mergePreview = document.getElementById('mergePreview');
            const executeMergeBtn = document.getElementById('executeMergeBtn');
            
            if (customer1Name && allCustomers[customer1Name]) {
                const c1 = allCustomers[customer1Name];
                customer1Info.textContent = `보증금: ₩${c1.depositAmount.toLocaleString()}, 매출: ₩${c1.salesAmount.toLocaleString()}, 거래: ${c1.transactions.length}건`;
            } else {
                customer1Info.textContent = '';
            }
            
            if (customer2Name && allCustomers[customer2Name]) {
                const c2 = allCustomers[customer2Name];
                customer2Info.textContent = `보증금: ₩${c2.depositAmount.toLocaleString()}, 매출: ₩${c2.salesAmount.toLocaleString()}, 거래: ${c2.transactions.length}건`;
            } else {
                customer2Info.textContent = '';
            }
            
            if (customer1Name && customer2Name && customer1Name !== customer2Name) {
                const c1 = allCustomers[customer1Name];
                const c2 = allCustomers[customer2Name];
                
                mergePreview.style.display = 'block';
                document.getElementById('mergePreviewContent').innerHTML = `
                    <strong>"${customer2Name}"의 모든 거래가 "${customer1Name}"으로 이동됩니다:</strong><br>
                    • 총 거래: ${c1.transactions.length + c2.transactions.length}건<br>
                    • 합계 보증금: ₩${(c1.depositAmount + c2.depositAmount).toLocaleString()}<br>
                    • 합계 매출: ₩${(c1.salesAmount + c2.salesAmount).toLocaleString()}<br>
                    <div style="color: #dc2626; margin-top: 10px;">⚠️ 이 작업은 되돌릴 수 없습니다!</div>
                `;
                executeMergeBtn.disabled = false;
            } else {
                mergePreview.style.display = 'none';
                executeMergeBtn.disabled = true;
            }
        }

        function executeCustomerMerge() {
            const customer1Name = document.getElementById('mergeCustomer1').value;
            const customer2Name = document.getElementById('mergeCustomer2').value;
            
            if (!customer1Name || !customer2Name || customer1Name === customer2Name) {
                showNotification('❌ 올바른 고객을 선택해주세요!');
                return;
            }
            
            if (!confirm(`정말로 "${customer2Name}"을 "${customer1Name}"으로 병합하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!`)) {
                return;
            }
            
            const customer1 = allCustomers[customer1Name];
            const customer2 = allCustomers[customer2Name];
            
            if (!customer1 || !customer2) {
                showNotification('❌ 고객 정보를 찾을 수 없습니다!');
                return;
            }

            // 고객 통합 실행
            mergeCustomerData(customer1Name, customer2Name);
            
            closeModal();
            updateAllTabs();
            
            showNotification(`✅ "${customer2Name}"이 "${customer1Name}"으로 통합되었습니다.`);
        }

        // 테스트용 샘플 데이터 생성
        function createSampleData() {
            const sampleTransactions = [
                { date: '2024-01-15', customer: '김규', inAmount: 1000000, outAmount: 0 },
                { date: '2024-01-20', customer: '김규', inAmount: 150000, outAmount: 0 },
                { date: '2024-01-25', customer: '김규', inAmount: 0, outAmount: 1000000 },
                { date: '2024-02-01', customer: '김규낙찰금', inAmount: 500000, outAmount: 0 },
                { date: '2024-02-05', customer: '김규낙찰금', inAmount: 200000, outAmount: 0 },
                { date: '2024-02-10', customer: '김규낙찰금', inAmount: 0, outAmount: 500000 },
                { date: '2024-01-10', customer: '이영희', inAmount: 50000, outAmount: 0 },
                { date: '2024-01-12', customer: '박민수', inAmount: 30000, outAmount: 0 },
                { date: '2024-01-18', customer: '최진호', inAmount: 2000000, outAmount: 0 },
                { date: '2024-01-22', customer: '최진호', inAmount: 300000, outAmount: 0 },
                { date: '2024-01-28', customer: '최진호', inAmount: 0, outAmount: 2000000 }
            ];
            
            allTransactions = sampleTransactions.map(t => ({
                id: `${t.date}_${t.customer}_${t.inAmount || t.outAmount}`,
                date: t.date,
                customer: t.customer,
                inAmount: t.inAmount || 0,
                outAmount: t.outAmount || 0,
                type: t.inAmount > 0 ? '입금' : '출금',
                parsedDate: new Date(t.date)
            }));
            
            classifyCustomers();
            mergeCustomers();
            updateAllTabs();
            
            showNotification('✅ 샘플 데이터가 로드되었습니다.');
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료');
            updateAllTabs();
        });

        // 검색 기능
        document.getElementById('customerSearch').addEventListener('input', updateCustomersTab);
        document.getElementById('customerFilter').addEventListener('change', updateCustomersTab);
    </script>
</body>
</html>
